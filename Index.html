<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta id="viewport-meta" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>TradeGinger | India's #1 B2B & C2C Marketplace</title>
    <meta name="theme-color" content="#0ea5e9">

    <!-- Preconnects -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js" defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 800: '#075985', 900: '#0c4a6e' },
                        accent: { 500: '#f59e0b', 600: '#d97706' },
                        dark: { 800: '#1e293b', 900: '#0f172a' },
                    },
                    padding: { 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; user-select: none; padding-bottom: calc(70px + env(safe-area-inset-bottom)); }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.3); }
        
        #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; padding: 12px 16px; border-radius: 12px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.15); font-size: 0.95rem; display: flex; align-items: center; gap: 12px; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        @media (min-width: 768px) {
            body { padding-bottom: 0; }
            #toast-container { bottom: 24px; right: 24px; left: auto; transform: none; width: auto; }
        }

        /* Password Strength Meter */
        .strength-meter { height: 4px; border-radius: 2px; transition: all 0.3s; background: #e2e8f0; overflow: hidden; }
        .strength-meter div { height: 100%; width: 0; transition: width 0.3s, background-color 0.3s; }

        /* Simulator Styles */
        body.simulate-mobile { background-color: #111827; display: flex; justify-content: center; padding: 40px 0; min-height: 100vh; overflow-y: scroll; }
        body.simulate-mobile #app-wrapper { width: 375px; max-width: 375px; height: 812px; min-height: 812px; background: white; border-radius: 32px; border: 8px solid #374151; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; overflow-x: hidden; overflow-y: auto; padding-bottom: 0 !important; }
        body.simulate-mobile .md\:hidden { display: flex !important; }
        body.simulate-mobile .md\:flex, body.simulate-mobile .md\:block { display: none !important; }
        body.simulate-mobile #mobile-bottom-nav { position: absolute; bottom: 0; width: 100%; border-radius: 0 0 24px 24px; }
        body.simulate-mobile nav.sticky { position: absolute; top: 0; width: 100%; border-radius: 24px 24px 0 0; }
    </style>
</head>
<body class="text-gray-800 flex flex-col min-h-screen">

    <!-- View Switcher -->
    <div class="fixed bottom-24 md:bottom-6 left-4 z-[100] animate-bounce">
        <button onclick="app.ui.toggleView()" id="view-switch-btn" class="bg-dark-900 text-white w-12 h-12 rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition border-2 border-white/20">
            <i class="fas fa-desktop text-lg" id="view-switch-icon"></i>
        </button>
    </div>

    <!-- App Wrapper -->
    <div id="app-wrapper" class="flex flex-col min-h-screen relative bg-gray-50 transition-all duration-300 w-full pb-[70px] md:pb-0">

        <!-- Top Navigation -->
        <nav class="glass sticky top-0 z-50 shadow-sm transition-all duration-300">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <a href="#home" class="flex items-center gap-2 group">
                        <div class="w-9 h-9 bg-gradient-to-br from-primary-600 to-primary-800 rounded-xl flex items-center justify-center text-white font-extrabold text-xl shadow-lg">TG</div>
                        <span class="text-2xl font-extrabold tracking-tighter text-dark-900">Trade<span class="text-primary-600">Ginger</span></span>
                    </a>
                    
                    <!-- Desktop Menu -->
                    <div class="hidden md:flex items-center space-x-8">
                        <form onsubmit="app.ui.handleSearch(event)" class="relative">
                            <input type="text" placeholder="Search..." class="w-64 pl-10 pr-4 py-2 bg-gray-100 rounded-full text-sm focus:bg-white focus:ring-2 focus:ring-primary-500 outline-none">
                            <i class="fas fa-search absolute left-3.5 top-2.5 text-gray-400"></i>
                        </form>
                        <button onclick="app.router.navigate('home')" class="text-gray-600 hover:text-primary-600 font-medium text-sm">Home</button>
                        <div id="nav-auth-section" class="flex items-center space-x-4 relative"></div>
                        <button onclick="app.router.navigate('sell')" class="bg-gradient-to-r from-accent-500 to-accent-600 text-white px-6 py-2.5 rounded-full font-bold shadow-lg text-sm flex items-center gap-2 hover:-translate-y-0.5 transition"><i class="fas fa-plus-circle"></i> SELL</button>
                    </div>

                    <!-- Mobile Header Actions -->
                    <div class="md:hidden flex items-center gap-3">
                        <div id="nav-auth-section-mobile"></div> 
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="app-view" class="flex-grow relative z-0"></main>

        <!-- Mobile Bottom Navigation -->
        <div id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center py-2 pb-safe z-[90] shadow-md">
            <button onclick="app.router.navigate('home')" class="flex flex-col items-center p-2 text-gray-500 hover:text-primary-600 active:text-primary-700 w-16"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-medium">Home</span></button>
            <button onclick="app.router.navigate('listing')" class="flex flex-col items-center p-2 text-gray-500 hover:text-primary-600 active:text-primary-700 w-16"><i class="fas fa-th-large text-xl mb-1"></i><span class="text-[10px] font-medium">Browse</span></button>
            <div class="relative -top-6">
                <button onclick="app.router.navigate('sell')" class="bg-gradient-to-r from-accent-500 to-accent-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg border-4 border-white transform active:scale-95 transition"><i class="fas fa-plus text-2xl"></i></button>
            </div>
            <button onclick="document.getElementById('chat-modal').classList.remove('hidden')" class="flex flex-col items-center p-2 text-gray-500 hover:text-primary-600 active:text-primary-700 w-16"><i class="fas fa-comment-dots text-xl mb-1"></i><span class="text-[10px] font-medium">Chat</span></button>
            <button onclick="app.router.navigate('profile')" class="flex flex-col items-center p-2 text-gray-500 hover:text-primary-600 active:text-primary-700 w-16"><i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-medium">Profile</span></button>
        </div>

    </div>

    <!-- Toast -->
    <div id="toast-container"></div>

    <!-- --- SYSTEM MODALS --- -->
    
    <!-- Auth Modal (Advanced) -->
    <div id="auth-modal" class="fixed inset-0 bg-dark-900/60 backdrop-blur-sm hidden z-[60] flex items-end md:items-center justify-center p-0 md:p-4 transition-all duration-300">
        <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl w-full max-w-md overflow-hidden max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="flex justify-between items-center p-6 border-b border-gray-50">
                <h3 class="text-xl font-bold text-gray-900" id="auth-title">Welcome Back</h3>
                <button onclick="app.modals.auth.hide()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-8">
                
                <!-- LOGIN / REGISTER FORM -->
                <form id="auth-form" onsubmit="app.auth.handleAuthSubmit(event)">
                    <!-- Account Type -->
                    <div id="user-type-toggle" class="hidden mb-6 flex bg-gray-100 p-1 rounded-xl">
                        <button type="button" class="flex-1 py-2.5 rounded-lg text-sm font-bold bg-white shadow-sm text-gray-900 transition-all" onclick="app.auth.setUserType('individual', this)">Individual</button>
                        <button type="button" class="flex-1 py-2.5 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-900 transition-all" onclick="app.auth.setUserType('business', this)">Business</button>
                        <input type="hidden" name="accountType" id="auth-account-type" value="individual">
                    </div>

                    <!-- Names -->
                    <div id="register-fields" class="hidden space-y-4 mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" name="firstName" placeholder="First Name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none">
                            <input type="text" name="lastName" placeholder="Last Name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                    </div>
                    
                    <!-- Email & Password -->
                    <div class="space-y-4">
                        <div class="relative group">
                            <i class="fas fa-envelope absolute left-4 top-4 text-gray-400"></i>
                            <input type="email" id="auth-email" name="email" placeholder="Email Address" required class="w-full pl-11 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                        
                        <!-- Password -->
                        <div>
                            <div class="relative group">
                                <i class="fas fa-lock absolute left-4 top-4 text-gray-400"></i>
                                <input type="password" id="auth-password" name="password" placeholder="Password" required onkeyup="app.auth.checkStrength(this.value)" class="w-full pl-11 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none">
                            </div>
                            <!-- Strength Meter -->
                            <div id="password-strength-container" class="hidden mt-2">
                                <div class="strength-meter w-full bg-gray-200 h-1 rounded-full overflow-hidden">
                                    <div id="strength-bar" class="h-full w-0 transition-all duration-300 bg-red-500"></div>
                                </div>
                                <p id="strength-text" class="text-[10px] mt-1 text-gray-500">Min 10 chars, 1 Upper, 1 Number, 1 Special</p>
                            </div>
                        </div>

                        <!-- Confirm Password -->
                        <div id="confirm-password-field" class="hidden relative group">
                            <i class="fas fa-check-double absolute left-4 top-4 text-gray-400"></i>
                            <input type="password" id="auth-confirm-password" placeholder="Confirm Password" class="w-full pl-11 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                    </div>

                    <button type="submit" id="auth-submit-btn" class="w-full mt-8 bg-primary-600 hover:bg-primary-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2">
                        <span id="auth-btn-text">Secure Login</span> <i class="fas fa-arrow-right"></i>
                    </button>

                    <div class="mt-8 text-center text-sm">
                        <span id="auth-switch-text" class="text-gray-500">New to TradeGinger?</span>
                        <button type="button" onclick="app.auth.toggleMode()" class="text-primary-600 font-bold hover:underline ml-1" id="auth-switch-btn">Create Account</button>
                    </div>
                </form>

                <!-- OTP FORM -->
                <form id="otp-form" onsubmit="app.auth.handleOtpSubmit(event)" class="hidden space-y-6 animate-fade-in">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-50 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-envelope-open-text text-2xl"></i></div>
                        <h4 class="text-lg font-bold text-gray-900">Verify Email</h4>
                        <p class="text-sm text-gray-500 mt-2">Code sent to <span id="otp-email-display" class="font-bold text-gray-900"></span></p>
                    </div>
                    <input type="text" name="otp" placeholder="Enter 6-digit Code" required maxlength="6" class="w-full text-center px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-primary-500 outline-none text-2xl tracking-widest font-bold">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all">Verify & Login</button>
                    <button type="button" onclick="app.auth.resetAuth()" class="w-full text-sm text-gray-400 hover:text-gray-600">Back</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const CONFIG = {
            SUPABASE_URL: 'https://crepnlidfdoskighdhdt.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyZXBubGlkZmRvc2tpZ2hkaGR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4Mjg3MzYsImV4cCI6MjA2ODQwNDczNn0.SjrYMGxuIFDsSZpPBm6a_ZveuI_gef80o03TNESJlDw',
            SCHEMA_VERSION: "3.1"
        };

        const supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        const state = { user: null, profile: null, pendingAuth: null, pendingRegistrationData: null };

        // --- UTILS ---
        const utils = {
            toast: (msg, type = 'info') => {
                const el = document.createElement('div');
                el.className = `toast ${type==='error'?'bg-red-600':'bg-dark-900'}`;
                el.innerHTML = `<span>${msg}</span>`;
                document.getElementById('toast-container').appendChild(el);
                setTimeout(() => el.remove(), 3000);
            },
            sanitize: (str) => { const d=document.createElement('div'); d.textContent=str; return d.innerHTML; },
            formatPrice: (p) => new Intl.NumberFormat('en-IN', {style:'currency', currency:'INR', maximumFractionDigits:0}).format(p),
            timeAgo: (d) => {
                const s = Math.floor((new Date() - new Date(d))/1000);
                if (s > 31536000) return Math.floor(s/31536000) + "y ago";
                if (s > 86400) return Math.floor(s/86400) + "d ago";
                return "Just now";
            },
            isAdmin: () => state.user?.email === 'admin@tradeginger.com'
        };

        // --- APP LOGIC ---
        const app = {
            init: async () => {
                const { data: { session } } = await supabase.auth.getSession();
                if(session) await app.auth.setUser(session.user);
                supabase.auth.onAuthStateChange(async (ev, session) => {
                    if(session) await app.auth.setUser(session.user);
                    else app.auth.clearUser();
                    app.ui.renderNav();
                });
                app.ui.renderNav();
                app.views.load();
                
                window.onclick = (e) => {
                    if (!e.target.closest('#user-menu-btn')) document.getElementById('user-menu-dropdown')?.classList.add('hidden');
                };
                
                // Mobile menu toggle support (if needed in future views)
                document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
                   document.getElementById('mobile-menu').classList.toggle('hidden');
                });
            },

            auth: {
                isRegistering: false,
                toggleMode: () => {
                    app.auth.isRegistering = !app.auth.isRegistering;
                    const els = {
                        fields: document.getElementById('register-fields'),
                        toggle: document.getElementById('user-type-toggle'),
                        confirm: document.getElementById('confirm-password-field'),
                        strength: document.getElementById('password-strength-container'),
                        title: document.getElementById('auth-title'),
                        btn: document.getElementById('auth-btn-text'),
                        switchText: document.getElementById('auth-switch-text'),
                        switchBtn: document.getElementById('auth-switch-btn')
                    };

                    if (app.auth.isRegistering) {
                        els.fields.classList.remove('hidden');
                        els.toggle.classList.remove('hidden');
                        els.confirm.classList.remove('hidden');
                        els.strength.classList.remove('hidden');
                        els.title.innerText = "Create Account";
                        els.btn.innerText = "Send Verification Code";
                        els.switchText.innerText = "Already have an account?";
                        els.switchBtn.innerText = "Login";
                        document.getElementById('auth-confirm-password').required = true;
                    } else {
                        els.fields.classList.add('hidden');
                        els.toggle.classList.add('hidden');
                        els.confirm.classList.add('hidden');
                        els.strength.classList.add('hidden');
                        els.title.innerText = "Welcome Back";
                        els.btn.innerText = "Secure Login";
                        els.switchText.innerText = "New to TradeGinger?";
                        els.switchBtn.innerText = "Create Account";
                        document.getElementById('auth-confirm-password').required = false;
                    }
                },
                setUserType: (type, btn) => {
                    document.getElementById('auth-account-type').value = type;
                    const btns = btn.parentElement.querySelectorAll('button');
                    btns.forEach(b => { b.classList.remove('bg-white','shadow-sm','text-gray-900'); b.classList.add('text-gray-500'); });
                    btn.classList.remove('text-gray-500');
                    btn.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                },
                checkStrength: (val) => {
                    if(!app.auth.isRegistering) return;
                    const bar = document.getElementById('strength-bar');
                    const text = document.getElementById('strength-text');
                    
                    const hasLength = val.length >= 10;
                    const hasUpper = /[A-Z]/.test(val);
                    const hasNumber = /[0-9]/.test(val);
                    const hasSpecial = /[^A-Za-z0-9]/.test(val);
                    
                    let strength = 0;
                    if(hasLength) strength++;
                    if(hasUpper) strength++;
                    if(hasNumber) strength++;
                    if(hasSpecial) strength++;

                    let color = 'bg-red-500', width = '20%', msg = 'Too Weak';
                    if (strength >= 2) { color = 'bg-yellow-500'; width = '50%'; msg = 'Medium'; }
                    if (strength >= 3) { color = 'bg-blue-500'; width = '75%'; msg = 'Strong'; }
                    if (strength === 4) { color = 'bg-green-500'; width = '100%'; msg = 'Excellent Security!'; }

                    bar.className = `h-full transition-all duration-300 ${color}`;
                    bar.style.width = width;
                    text.innerText = msg;
                    text.className = `text-[10px] mt-1 font-bold ${color.replace('bg-','text-')}`;
                },
                handleAuthSubmit: async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const email = fd.get('email'), password = fd.get('password');

                    if (app.auth.isRegistering) {
                        const confirm = document.getElementById('auth-confirm-password').value;
                        if (password !== confirm) return utils.toast("Passwords do not match!", "error");
                        
                        const hasLength = password.length >= 10;
                        const hasUpper = /[A-Z]/.test(password);
                        const hasNumber = /[0-9]/.test(password);
                        const hasSpecial = /[^A-Za-z0-9]/.test(password);

                        if (!hasLength || !hasUpper || !hasNumber || !hasSpecial) {
                            return utils.toast("Password too weak. See requirements.", "error");
                        }

                        const fullName = `${fd.get('firstName')} ${fd.get('lastName')}`;
                        try {
                            state.pendingRegistrationData = { 
                                first_name: fd.get('firstName'), 
                                last_name: fd.get('lastName'), 
                                full_name: fullName, 
                                account_type: fd.get('accountType') 
                            };
                            
                            // Sign Up with minimal metadata
                            const { error } = await supabase.auth.signUp({
                                email, password,
                                options: { data: { full_name: fullName } }
                            });
                            if(error) throw error;

                            // Switch to OTP
                            state.pendingAuth = { email };
                            document.getElementById('auth-form').classList.add('hidden');
                            document.getElementById('otp-form').classList.remove('hidden');
                            document.getElementById('otp-email-display').innerText = email;
                            utils.toast("Code sent to email!", "success");
                        } catch (err) { utils.toast(err.message, "error"); }
                    } else {
                        try {
                            const { error } = await supabase.auth.signInWithPassword({ email, password });
                            if(error) throw error;
                            utils.toast("Logged in successfully", "success");
                            app.modals.auth.hide();
                        } catch(err) { utils.toast(err.message, "error"); }
                    }
                },
                handleOtpSubmit: async (e) => {
                    e.preventDefault();
                    const token = e.target.querySelector('input[name="otp"]').value;
                    if(!token || !state.pendingAuth) return;

                    try {
                        const { data: { user }, error } = await supabase.auth.verifyOtp({
                            email: state.pendingAuth.email, token, type: 'signup'
                        });
                        if(error) throw error;

                        // Update Profile with extra details safely
                        if (user && state.pendingRegistrationData) {
                            await supabase.from('profiles').update({
                                first_name: state.pendingRegistrationData.first_name,
                                last_name: state.pendingRegistrationData.last_name,
                                account_type: state.pendingRegistrationData.account_type
                            }).eq('id', user.id);
                        }

                        utils.toast("Verified! Welcome.", "success");
                        app.modals.auth.hide();
                        app.auth.resetAuth();
                    } catch (err) { utils.toast(err.message, "error"); }
                },
                resetAuth: () => {
                    document.getElementById('auth-form').classList.remove('hidden');
                    document.getElementById('otp-form').classList.add('hidden');
                    state.pendingAuth = null;
                },
                logout: async (e) => {
                    e?.preventDefault();
                    await supabase.auth.signOut();
                    app.auth.clearUser();
                },
                setUser: async (u) => {
                    state.user = u;
                    // Use maybeSingle to avoid error if profile doesn't exist yet
                    const { data } = await supabase.from('profiles').select('*').eq('id', u.id).maybeSingle();
                    state.profile = data || { full_name: u.user_metadata.full_name };
                    app.ui.renderNav();
                },
                clearUser: () => { state.user=null; state.profile=null; app.ui.renderNav(); }
            },

            ui: {
                renderNav: () => {
                    const nav = document.getElementById('nav-auth-section');
                    const mob = document.getElementById('nav-auth-section-mobile');
                    
                    if(state.user) {
                        const html = `
                            <div class="relative">
                                <button id="user-menu-btn" onclick="document.getElementById('user-menu-dropdown').classList.toggle('hidden')" class="focus:outline-none">
                                    <img src="${state.profile?.avatar_url || 'https://placehold.co/40'}" class="w-8 h-8 rounded-full border border-gray-200 object-cover">
                                </button>
                                <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 py-2 z-50 animate-fade-in">
                                    <div class="px-4 py-2 border-b text-sm font-bold text-gray-800 truncate">${state.profile?.full_name || 'User'}</div>
                                    <a href="#profile" class="block px-4 py-2 text-sm text-gray-600 hover:bg-gray-50">My Profile</a>
                                    ${utils.isAdmin() ? '<a href="#admin" class="block px-4 py-2 text-sm text-blue-600 font-bold hover:bg-blue-50">Admin Dashboard</a>' : ''}
                                    <a href="#" onclick="app.auth.logout(event)" class="block px-4 py-2 text-sm text-red-500 hover:bg-red-50">Logout</a>
                                </div>
                            </div>`;
                        nav.innerHTML = html;
                        mob.innerHTML = html;
                    } else {
                        const btn = `<button onclick="app.modals.auth.show()" class="text-sm font-bold text-primary-600 hover:text-primary-800">Login</button>`;
                        nav.innerHTML = btn;
                        mob.innerHTML = btn;
                    }
                },
                toggleView: () => {
                    const isMobile = window.matchMedia("(max-width: 768px)").matches;
                    const body = document.body;
                    const icon = document.getElementById('view-switch-icon');
                    
                    if (isMobile) {
                        const meta = document.getElementById('viewport-meta');
                        if (meta.content.includes('width=1280')) {
                            meta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
                            icon.className = 'fas fa-desktop text-lg';
                            utils.toast("Mobile View", "success");
                        } else {
                            meta.content = 'width=1280';
                            icon.className = 'fas fa-mobile-alt text-lg';
                            utils.toast("Desktop View", "success");
                        }
                    } else {
                        body.classList.toggle('simulate-mobile');
                        icon.className = body.classList.contains('simulate-mobile') ? 'fas fa-desktop text-lg' : 'fas fa-mobile-alt text-lg';
                        utils.toast(body.classList.contains('simulate-mobile') ? "Mobile Mode" : "Desktop Mode", "success");
                    }
                }
            },

            router: {
                navigate: (p) => window.location.hash = p,
                handle: async () => {
                    const h = window.location.hash.slice(1) || 'home';
                    if(['sell','profile','admin'].includes(h) && !state.user) return app.modals.auth.show();
                    
                    const view = document.getElementById('app-view');
                    
                    if(h==='home') {
                        view.innerHTML = app.views.home;
                        // Fetch listings logic would go here
                    } else if(h==='profile') {
                        view.innerHTML = app.views.profile();
                    } else if(h==='sell') {
                         app.modals.sell.show();
                         history.back(); // Keep url clean
                    } else if (h === 'listing') {
                         view.innerHTML = app.views.listings(null, null);
                         // Fetch logic
                    }
                }
            },

            modals: {
                auth: { show: () => document.getElementById('auth-modal').classList.remove('hidden'), hide: () => document.getElementById('auth-modal').classList.add('hidden') },
                sell: { show: () => document.getElementById('sell-modal').classList.remove('hidden'), hide: () => document.getElementById('sell-modal').classList.add('hidden') }
            },

            views: {
                load: () => app.router.handle(),
                home: `
                    <div class="px-4 pt-6 pb-20">
                        <div class="bg-gradient-to-br from-primary-600 to-dark-900 rounded-3xl p-8 text-white shadow-xl mb-8 relative overflow-hidden">
                            <div class="relative z-10">
                                <h1 class="text-3xl font-bold mb-2 leading-tight">Buy & Sell <br><span class="text-accent-500">Securely</span></h1>
                                <p class="text-primary-100 text-sm mb-6 opacity-90">Verified Users. Zero Fees. Trusted Community.</p>
                                <button onclick="app.router.navigate('listing')" class="bg-white text-primary-900 px-6 py-3 rounded-full font-bold text-sm shadow-lg hover:scale-105 transition transform">Explore Marketplace</button>
                            </div>
                            <div class="absolute right-0 bottom-0 opacity-10 transform translate-x-10 translate-y-10">
                                <i class="fas fa-shield-alt text-9xl"></i>
                            </div>
                        </div>
                        
                        <h2 class="font-bold text-lg mb-4 text-gray-900">Categories</h2>
                        <div class="grid grid-cols-4 gap-4 mb-8">
                            <div onclick="app.router.navigate('listing?cat=1')" class="flex flex-col items-center gap-2 cursor-pointer active:scale-95 transition group">
                                <div class="w-14 h-14 rounded-2xl bg-white text-primary-600 flex items-center justify-center text-xl shadow-sm border border-gray-100 group-hover:border-primary-200"><i class="fas fa-car"></i></div>
                                <span class="text-[10px] font-medium text-gray-600">Cars</span>
                            </div>
                            <div onclick="app.router.navigate('listing?cat=2')" class="flex flex-col items-center gap-2 cursor-pointer active:scale-95 transition group">
                                <div class="w-14 h-14 rounded-2xl bg-white text-primary-600 flex items-center justify-center text-xl shadow-sm border border-gray-100 group-hover:border-primary-200"><i class="fas fa-building"></i></div>
                                <span class="text-[10px] font-medium text-gray-600">Property</span>
                            </div>
                            <div onclick="app.router.navigate('listing?cat=3')" class="flex flex-col items-center gap-2 cursor-pointer active:scale-95 transition group">
                                <div class="w-14 h-14 rounded-2xl bg-white text-primary-600 flex items-center justify-center text-xl shadow-sm border border-gray-100 group-hover:border-primary-200"><i class="fas fa-mobile-alt"></i></div>
                                <span class="text-[10px] font-medium text-gray-600">Mobiles</span>
                            </div>
                             <div onclick="app.router.navigate('listing?cat=6')" class="flex flex-col items-center gap-2 cursor-pointer active:scale-95 transition group">
                                <div class="w-14 h-14 rounded-2xl bg-white text-primary-600 flex items-center justify-center text-xl shadow-sm border border-gray-100 group-hover:border-primary-200"><i class="fas fa-tools"></i></div>
                                <span class="text-[10px] font-medium text-gray-600">Services</span>
                            </div>
                        </div>
                        
                         <h2 class="font-bold text-lg mb-4 text-gray-900">Fresh Recommendations</h2>
                         <div id="home-feed" class="grid grid-cols-2 gap-4 pb-8">
                            <!-- Dynamic Content -->
                            <div class="col-span-2 text-center py-10 text-gray-400 text-sm">Loading latest ads...</div>
                         </div>
                    </div>
                `,
                listings: (c,q) => `<div class="p-4 pt-20">Listings View (Placeholder)</div>`,
                profile: () => `
                    <div class="p-4 pt-8 pb-24">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-3xl border-4 border-white shadow-md">
                                ${state.profile?.avatar_url ? `<img src="${state.profile.avatar_url}" class="w-full h-full rounded-full object-cover">` : '<i class="fas fa-user text-gray-400"></i>'}
                            </div>
                            <div>
                                <h1 class="text-xl font-bold text-gray-900">${utils.sanitize(state.profile?.full_name || 'User')}</h1>
                                <p class="text-xs text-gray-500 mb-2">${state.user?.email}</p>
                                <span class="bg-primary-50 text-primary-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider border border-primary-100">${state.profile?.account_type || 'Individual'}</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-gray-800">My Listings</div>
                                    <div class="text-xs text-gray-500">Manage your active ads</div>
                                </div>
                                <i class="fas fa-chevron-right text-gray-300"></i>
                            </div>
                             <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-gray-800">Purchased Leads</div>
                                    <div class="text-xs text-gray-500">View contact details</div>
                                </div>
                                <i class="fas fa-chevron-right text-gray-300"></i>
                            </div>
                        </div>

                        <button onclick="app.auth.logout()" class="w-full mt-8 border border-red-100 text-red-500 py-3 rounded-xl font-bold hover:bg-red-50 transition">Log Out</button>
                    </div>
                `
            }
        };

        window.app = app;
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
