<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta id="viewport-meta" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- SEO Configuration -->
    <title>TradeGinger | India's #1 B2B & C2C Marketplace</title>
    <meta name="description" content="TradeGinger is the safest platform to buy and sell used cars, property, and electronics. Features verified sellers, secure chat, lead generation for businesses, and premium listings.">
    <meta name="keywords" content="buy leads india, used cars, second hand mobiles, property for sale, b2b marketplace, tradeginger, classifieds">
    <meta name="author" content="TradeGinger Inc.">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#0ea5e9">

    <!-- Preconnects for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js" defer></script>

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 800: '#075985', 900: '#0c4a6e' },
                        accent: { 500: '#f59e0b', 600: '#d97706' },
                        dark: { 800: '#1e293b', 900: '#0f172a' },
                        platinum: { start: '#e2e8f0', end: '#94a3b8' },
                        gold: { start: '#fcd34d', end: '#d97706' }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(14, 165, 233, 0.3)'
                    },
                    padding: { 'safe-bottom': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>

    <style>
        /* Core UI Polish */
        body { background-color: #f8fafc; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; user-select: none; padding-bottom: calc(70px + env(safe-area-inset-bottom)); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loaders & Skeletons */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Glassmorphism & Blur */
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.3); }
        
        /* Premium Badges */
        .card-platinum { border: 2px solid transparent; background-image: linear-gradient(white, white), linear-gradient(135deg, #e2e8f0, #64748b); background-origin: border-box; background-clip: content-box, border-box; }
        .card-gold { border: 2px solid transparent; background-image: linear-gradient(white, white), linear-gradient(135deg, #fcd34d, #d97706); background-origin: border-box; background-clip: content-box, border-box; }

        /* Toast */
        #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; padding: 12px 16px; border-radius: 12px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.15); font-size: 0.95rem; display: flex; align-items: center; gap: 12px; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: blur(4px); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        @media (min-width: 768px) {
            body { padding-bottom: 0; }
            #toast-container { bottom: 24px; right: 24px; left: auto; transform: none; width: auto; }
        }

        /* --- View Switcher Styles --- */
        body.simulate-mobile {
            background-color: #111827; 
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 0;
            min-height: 100vh;
            overflow-y: scroll; 
        }
        body.simulate-mobile #app-wrapper {
            width: 375px; 
            max-width: 375px;
            height: 812px; 
            min-height: 812px;
            background: white;
            border-radius: 32px;
            border: 8px solid #374151;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
            padding-bottom: 0 !important; 
        }
        body.simulate-mobile .md\:hidden { display: flex !important; }
        body.simulate-mobile .md\:flex { display: none !important; }
        body.simulate-mobile .md\:block { display: none !important; }
        body.simulate-mobile footer.md\:block { display: none !important; }
        
        body.simulate-mobile #mobile-bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
        }
        body.simulate-mobile .fixed.inset-0 {
            position: absolute; 
            border-radius: 24px;
        }
        body.simulate-mobile nav.sticky {
            position: absolute;
            top: 0;
            width: 100%;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
        }
    </style>
</head>
<body class="text-gray-800 flex flex-col min-h-screen">

    <!-- View Switcher FAB -->
    <div class="fixed bottom-24 md:bottom-6 left-4 z-[100] animate-bounce">
        <button onclick="app.ui.toggleView()" id="view-switch-btn" class="bg-dark-900 text-white w-12 h-12 rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition border-2 border-white/20" title="Switch Mobile/Desktop View">
            <i class="fas fa-desktop text-lg" id="view-switch-icon"></i>
        </button>
        <span class="absolute left-14 top-3 bg-dark-900 text-white text-[10px] px-2 py-1 rounded opacity-0 hover:opacity-100 transition pointer-events-none whitespace-nowrap">Switch View</span>
    </div>

    <!-- App Wrapper for Layout Stability -->
    <div id="app-wrapper" class="flex flex-col min-h-screen relative bg-gray-50 transition-all duration-300 w-full pb-[70px] md:pb-0">

        <!-- Top Navigation -->
        <nav class="glass sticky top-0 z-50 shadow-sm transition-all duration-300">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <!-- Logo -->
                    <a href="#home" class="flex items-center gap-2 group">
                        <div class="w-9 h-9 bg-gradient-to-br from-primary-600 to-primary-800 rounded-xl flex items-center justify-center text-white font-extrabold text-xl shadow-lg group-hover:scale-105 transition-transform">TG</div>
                        <span class="text-2xl font-extrabold tracking-tighter text-dark-900">Trade<span class="text-primary-600">Ginger</span></span>
                    </a>

                    <!-- Desktop Menu -->
                    <div class="hidden md:flex items-center space-x-8">
                        <form onsubmit="app.ui.handleSearch(event)" class="relative group">
                            <input type="text" id="nav-search" placeholder="Find cars, phones, property..." class="w-64 transition-all duration-300 focus:w-80 pl-10 pr-4 py-2 bg-gray-100/80 border-transparent focus:bg-white border focus:border-primary-500 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary-100">
                            <i class="fas fa-search absolute left-3.5 top-2.5 text-gray-400 group-focus-within:text-primary-500 transition-colors"></i>
                        </form>

                        <a href="#home" class="text-gray-600 hover:text-primary-600 font-medium transition-colors text-sm">Home</a>
                        
                        <!-- Auth Logic -->
                        <div id="nav-auth-section" class="flex items-center space-x-4 relative">
                            <!-- Injected via JS -->
                        </div>
                        
                        <button onclick="app.router.navigate('sell')" class="bg-gradient-to-r from-accent-500 to-accent-600 hover:from-accent-600 hover:to-accent-700 text-white px-6 py-2.5 rounded-full font-bold shadow-lg hover:shadow-accent-500/30 transition-all transform hover:-translate-y-0.5 flex items-center gap-2 text-sm">
                            <i class="fas fa-plus-circle"></i> SELL
                        </button>
                    </div>

                    <!-- Mobile Header Actions -->
                    <div class="md:hidden flex items-center gap-3">
                        <button onclick="document.getElementById('mobile-search-bar').classList.toggle('hidden')" class="p-2 text-gray-600">
                            <i class="fas fa-search text-lg"></i>
                        </button>
                        <!-- Mobile Auth Avatar injected here -->
                        <div id="nav-auth-section-mobile"></div> 
                    </div>
                </div>
                
                <!-- Mobile Search Bar -->
                <div id="mobile-search-bar" class="hidden md:hidden pb-3 animate-fade-in border-t border-gray-100 mt-2 pt-2">
                    <form onsubmit="app.ui.handleSearch(event)" class="relative">
                        <input type="text" placeholder="Search..." class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary-500 outline-none">
                        <i class="fas fa-search absolute left-3.5 top-3.5 text-gray-400"></i>
                    </form>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main id="app-view" class="flex-grow relative z-0">
            <!-- SPA Views -->
        </main>

        <!-- Mobile Bottom Navigation -->
        <div id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center py-2 pb-safe z-[90] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button onclick="app.router.navigate('home')" class="flex flex-col items-center p-2 text-gray-500 hover:text-primary-600 active:text-primary-700 transition w-16">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Home</span>
            </button>
            <button onclick="app.router.navigate('listing')" class="flex flex-col items-center p-2 text-gray-500 hover:text-primary-600 active:text-primary-700 transition w-16">
                <i class="fas fa-th-large text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Browse</span>
            </button>
            
            <!-- Floating Sell Button -->
            <div class="relative -top-6">
                <button onclick="app.router.navigate('sell')" class="bg-gradient-to-r from-accent-500 to-accent-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-accent-500/40 transform hover:scale-105 transition active:scale-95 border-4 border-white">
                    <i class="fas fa-plus text-2xl"></i>
                </button>
            </div>

            <button onclick="document.getElementById('chat-modal').classList.remove('hidden')" class="flex flex-col items-center p-2 text-gray-500 hover:text-primary-600 active:text-primary-700 transition w-16">
                <i class="fas fa-comment-dots text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Chat</span>
            </button>
            <button onclick="app.router.navigate('profile')" class="flex flex-col items-center p-2 text-gray-500 hover:text-primary-600 active:text-primary-700 transition w-16">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-[10px] font-medium">Profile</span>
            </button>
        </div>

        <!-- Footer -->
        <footer class="hidden md:block bg-dark-900 text-white pt-16 pb-8 mt-auto border-t border-gray-800">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-12 border-b border-gray-800 pb-12">
                    <div class="space-y-4">
                        <h3 class="text-2xl font-bold tracking-tight">TradeGinger</h3>
                        <p class="text-gray-400 text-sm leading-relaxed">India's safest premium marketplace.</p>
                        <button onclick="app.router.navigate('admin')" class="text-xs text-gray-600 hover:text-gray-400 flex items-center gap-1 transition"><i class="fas fa-shield-alt"></i> Admin Access</button>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4 text-gray-100">Business Solutions</h4>
                        <ul class="space-y-3 text-sm text-gray-400">
                            <li><a href="#leads" class="hover:text-primary-400 transition flex items-center gap-2"><i class="fas fa-bolt text-xs"></i> Buy Leads</a></li>
                            <li><a href="#sell" class="hover:text-primary-400 transition">Business Accounts</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4 text-gray-100">Top Categories</h4>
                        <ul class="space-y-3 text-sm text-gray-400">
                            <li><a href="#listing?cat=cars" class="hover:text-primary-400 transition">Used Cars</a></li>
                            <li><a href="#listing?cat=mobiles" class="hover:text-primary-400 transition">Mobile Phones</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold mb-4 text-gray-100">Get in Touch</h4>
                        <p class="text-gray-400 text-sm mb-3 flex items-center gap-2"><i class="fas fa-envelope text-primary-500"></i> sales@tradeginger.com</p>
                        <p class="text-gray-400 text-sm flex items-center gap-2"><i class="fas fa-map-marker-alt text-primary-500"></i> Gurugram, India</p>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row justify-between items-center pt-8 text-gray-500 text-xs">
                    <p>&copy; 2025 TradeGinger Inc. All rights reserved.</p>
                    <div class="flex space-x-6 mt-4 md:mt-0">
                        <a href="#" onclick="app.modals.privacy.show()" class="hover:text-white transition">Privacy Policy</a>
                        <a href="#" onclick="app.modals.tnc.show()" class="hover:text-white transition">Terms & Conditions</a>
                    </div>
                </div>
            </div>
        </footer>

    </div> <!-- End #app-wrapper -->

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- SYSTEM MODALS -->
    
    <!-- Auth Modal (Updated for OTP) -->
    <div id="auth-modal" class="fixed inset-0 bg-dark-900/60 backdrop-blur-sm hidden z-[60] flex items-end md:items-center justify-center p-0 md:p-4 transition-all duration-300 opacity-0 scale-95 pointer-events-none">
        <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all duration-300 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b border-gray-50">
                <h3 class="text-xl font-bold text-gray-900" id="auth-title">Welcome Back</h3>
                <button onclick="app.modals.auth.hide()" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-8">
                
                <!-- MAIN FORM (Login/Register) -->
                <form id="auth-form" onsubmit="app.auth.handleAuthSubmit(event)">
                    <div id="user-type-toggle" class="hidden mb-6 flex bg-gray-100 p-1 rounded-xl">
                        <button type="button" class="flex-1 py-2.5 rounded-lg text-sm font-bold bg-white shadow-sm text-gray-900 transition-all" onclick="app.auth.setUserType('individual', this)">Individual</button>
                        <button type="button" class="flex-1 py-2.5 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-900 transition-all" onclick="app.auth.setUserType('business', this)">Business</button>
                        <input type="hidden" name="accountType" id="auth-account-type" value="individual">
                    </div>

                    <div id="register-fields" class="hidden space-y-4 mb-4 animate-fade-in">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" name="firstName" placeholder="First Name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition bg-gray-50 focus:bg-white">
                            <input type="text" name="lastName" placeholder="Last Name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none transition bg-gray-50 focus:bg-white">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative group">
                            <i class="fas fa-envelope absolute left-4 top-4 text-gray-400 group-focus-within:text-primary-500 transition-colors"></i>
                            <input type="email" id="auth-email" name="email" placeholder="Email Address" required class="w-full pl-11 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none transition bg-gray-50 focus:bg-white">
                        </div>
                        <div class="relative group" id="password-field">
                            <i class="fas fa-lock absolute left-4 top-4 text-gray-400 group-focus-within:text-primary-500 transition-colors"></i>
                            <input type="password" name="password" placeholder="Password" required class="w-full pl-11 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none transition bg-gray-50 focus:bg-white">
                        </div>
                    </div>

                    <button type="submit" id="auth-submit-btn" class="w-full mt-8 bg-primary-600 hover:bg-primary-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-primary-500/30 transition-all transform hover:-translate-y-0.5 flex justify-center items-center gap-2">
                        <span id="auth-btn-text">Secure Login</span> <i class="fas fa-arrow-right"></i>
                    </button>

                    <div class="my-6 flex items-center justify-between" id="auth-divider">
                        <span class="border-b w-1/5 lg:w-1/4 border-gray-200"></span>
                        <span class="text-xs text-gray-400 uppercase font-medium">or continue with</span>
                        <span class="border-b w-1/5 lg:w-1/4 border-gray-200"></span>
                    </div>

                    <button type="button" id="google-btn" onclick="app.auth.loginWithGoogle()" class="w-full border border-gray-200 bg-white hover:bg-gray-50 text-gray-700 font-medium py-3 rounded-xl transition flex items-center justify-center gap-3">
                        <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5"> Google
                    </button>
                </form>

                <!-- OTP FORM (Initially Hidden) -->
                <form id="otp-form" onsubmit="app.auth.handleOtpSubmit(event)" class="hidden space-y-6 animate-fade-in">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-primary-50 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-envelope-open-text text-2xl text-primary-600"></i>
                        </div>
                        <h4 class="text-lg font-bold text-gray-900">Verify your Email</h4>
                        <p class="text-sm text-gray-500 mt-2">We sent a verification code to <span id="otp-email-display" class="font-bold text-gray-800"></span></p>
                    </div>
                    <input type="text" name="otp" placeholder="Enter 6-digit OTP" required class="w-full text-center px-4 py-3 border-2 border-primary-100 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none tracking-[0.5em] text-xl font-bold bg-white">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all">
                        Verify & Login
                    </button>
                    <button type="button" onclick="app.auth.resetAuth()" class="w-full text-sm text-gray-500 hover:text-gray-800 mt-2">Cancel / Change Email</button>
                </form>
                
                <div class="mt-8 text-center text-sm" id="auth-switch-wrapper">
                    <span id="auth-switch-text" class="text-gray-500">New to TradeGinger?</span>
                    <button onclick="app.auth.toggleMode()" class="text-primary-600 font-bold hover:text-primary-700 hover:underline ml-1" id="auth-switch-btn">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sell Modal -->
    <div id="sell-modal" class="fixed inset-0 bg-dark-900/60 backdrop-blur-sm hidden z-[60] flex items-end md:items-center justify-center p-0 md:p-4">
        <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl w-full max-w-4xl h-[95vh] md:h-[90vh] flex flex-col animate-fade-in">
            <div class="flex justify-between items-center p-4 md:p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-900" id="sell-modal-title">Post an Ad</h3>
                <button onclick="app.modals.sell.hide()" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4 md:p-8 overflow-y-auto flex-grow custom-scrollbar">
                <form id="sell-form" class="space-y-8">
                    <input type="hidden" name="editing_id" id="edit-id">
                    
                    <!-- Steps Indicator -->
                    <div class="flex justify-between items-center text-sm font-semibold text-gray-400 border-b border-gray-100 pb-4">
                        <span class="text-primary-600 flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-primary-100 flex items-center justify-center text-primary-600 text-xs">1</span> Details</span>
                        <span class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 text-xs">2</span> Media</span>
                        <span class="flex items-center gap-2"><span class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 text-xs">3</span> Pay</span>
                    </div>

                    <!-- Section: Category -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Category</label>
                            <div class="relative">
                                <select id="category-select" name="category" required onchange="app.sell.handleCategoryChange(this.value)" class="w-full rounded-xl border-gray-200 border px-4 py-3 focus:ring-2 focus:ring-primary-500 outline-none bg-gray-50 focus:bg-white appearance-none">
                                    <option value="">Select Category...</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-3.5 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Sub-Category</label>
                            <div class="relative">
                                <select id="subcategory-select" name="subcategory" required class="w-full rounded-xl border-gray-200 border px-4 py-3 focus:ring-2 focus:ring-primary-500 outline-none bg-gray-50 focus:bg-white appearance-none disabled:opacity-50" disabled>
                                    <option value="">Select Category First</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-3.5 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Attributes -->
                    <div id="dynamic-attributes" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-gray-50 rounded-xl border border-gray-100 empty:hidden"></div>

                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Ad Title</label>
                            <input type="text" name="title" placeholder="e.g. 2022 Honda City ZX" required class="w-full rounded-xl border-gray-200 border px-4 py-3 focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Price (₹)</label>
                            <input type="number" name="price" placeholder="0" required class="w-full rounded-xl border-gray-200 border px-4 py-3 focus:ring-2 focus:ring-primary-500 outline-none font-bold text-gray-800">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Description</label>
                        <div class="relative">
                            <textarea name="description" id="ad-description" rows="4" placeholder="Describe features, condition, and reason for selling..." required class="w-full rounded-xl border-gray-200 border px-4 py-3 focus:ring-2 focus:ring-primary-500 outline-none resize-none"></textarea>
                            <button type="button" onclick="app.sell.generateAI()" class="absolute bottom-3 right-3 text-xs bg-purple-600 text-white px-3 py-1.5 rounded-lg hover:bg-purple-700 transition shadow-md flex items-center gap-1.5 font-medium">
                                <i class="fas fa-wand-magic-sparkles"></i> AI Write
                            </button>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">State</label>
                            <select id="state-select" required onchange="app.location.populateCities(this.value, 'city-select')" class="w-full rounded-xl border-gray-200 border px-4 py-3 bg-white"></select>
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-gray-500 uppercase mb-2">City</label>
                            <select id="city-select" name="city_id" required class="w-full rounded-xl border-gray-200 border px-4 py-3 bg-white" disabled></select>
                        </div>
                    </div>

                    <!-- Media -->
                    <div class="border-2 border-dashed border-gray-300 rounded-2xl p-10 text-center hover:border-primary-500 hover:bg-primary-50/50 transition cursor-pointer relative group" onclick="document.getElementById('file-upload').click()">
                        <input type="file" id="file-upload" multiple accept="image/*" class="hidden" onchange="app.sell.handleFiles(event)">
                        <div class="w-16 h-16 bg-primary-100 text-primary-500 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                            <i class="fas fa-cloud-upload-alt text-2xl"></i>
                        </div>
                        <p class="text-gray-900 font-bold">Click to upload photos</p>
                        <p class="text-xs text-gray-500 mt-1">Images auto-compressed to 10KB (Supabase Storage)</p>
                    </div>
                    <div id="preview-container" class="flex gap-3 overflow-x-auto pb-2 snap-x"></div>

                    <!-- Plans (REVISED) -->
                    <div class="pt-6 border-t border-gray-100" id="plan-selection-section">
                        <h4 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fas fa-rocket text-primary-500"></i> Boost Visibility</h4>
                        <div class="space-y-3 md:space-y-0 md:grid md:grid-cols-5 md:gap-4">
                            <!-- Free -->
                            <label class="cursor-pointer group block">
                                <input type="radio" name="plan" value="free" class="peer hidden" checked onchange="app.sell.updatePlanPrice(0)">
                                <div class="border-2 border-gray-100 rounded-xl p-4 hover:border-primary-400 peer-checked:border-primary-600 peer-checked:bg-primary-50 transition h-full">
                                    <div class="font-bold text-gray-800">Standard</div>
                                    <div class="text-xl font-extrabold text-gray-900 my-1">₹0</div>
                                    <ul class="text-[10px] text-gray-500 space-y-1">
                                        <li><i class="fas fa-check text-green-500"></i> 45 Days</li>
                                        <li><i class="fas fa-check text-green-500"></i> Auto-approved</li>
                                    </ul>
                                </div>
                            </label>
                            <!-- C2C -->
                            <label class="cursor-pointer group block">
                                <input type="radio" name="plan" value="c2c" class="peer hidden" onchange="app.sell.updatePlanPrice(99)">
                                <div class="border-2 border-gray-100 rounded-xl p-4 hover:border-green-400 peer-checked:border-green-600 peer-checked:bg-green-50 transition h-full">
                                    <div class="font-bold text-green-700">C2C</div>
                                    <div class="text-xl font-extrabold text-green-800 my-1">₹99</div>
                                    <ul class="text-[10px] text-gray-600 space-y-1 font-medium">
                                        <li><i class="fas fa-check text-green-500"></i> 20 Days</li>
                                        <li><i class="fas fa-check text-green-500"></i> Priority Rank</li>
                                    </ul>
                                </div>
                            </label>
                            <!-- Silver (B2B) -->
                            <label class="cursor-pointer group block">
                                <input type="radio" name="plan" value="silver" class="peer hidden" onchange="app.sell.updatePlanPrice(3999)">
                                <div class="border-2 border-gray-100 rounded-xl p-4 hover:border-gray-400 peer-checked:border-gray-500 peer-checked:bg-gray-50 transition h-full">
                                    <div class="font-bold text-gray-800">Silver (B2B)</div>
                                    <div class="text-xl font-extrabold text-gray-500 my-1">₹3,999</div>
                                    <ul class="text-[10px] text-gray-600 space-y-1 font-medium">
                                        <li><i class="fas fa-check text-gray-500"></i> Yearly</li>
                                        <li><i class="fas fa-check text-gray-500"></i> 10 Highlighted</li>
                                    </ul>
                                </div>
                            </label>
                            <!-- Gold (B2B) -->
                            <label class="cursor-pointer group block">
                                <input type="radio" name="plan" value="gold" class="peer hidden" onchange="app.sell.updatePlanPrice(8999)">
                                <div class="border-2 border-gray-100 rounded-xl p-4 hover:border-yellow-400 peer-checked:border-yellow-500 peer-checked:bg-yellow-50 transition h-full relative overflow-hidden">
                                    <div class="absolute top-0 right-0 bg-yellow-500 text-white text-[8px] font-bold px-2 py-0.5 rounded-bl-lg">BEST</div>
                                    <div class="font-bold text-yellow-700">Gold (B2B)</div>
                                    <div class="text-xl font-extrabold text-yellow-600 my-1">₹8,999</div>
                                    <ul class="text-[10px] text-gray-600 space-y-1 font-medium">
                                        <li><i class="fas fa-check text-yellow-600"></i> Yearly / 100 Ads</li>
                                        <li><i class="fas fa-check text-yellow-600"></i> 10 Highlighted</li>
                                    </ul>
                                </div>
                            </label>
                            <!-- Platinum (B2B) -->
                            <label class="cursor-pointer group block">
                                <input type="radio" name="plan" value="platinum" class="peer hidden" onchange="app.sell.updatePlanPrice(14999)">
                                <div class="border-2 border-gray-100 rounded-xl p-4 hover:border-gray-800 peer-checked:border-gray-800 peer-checked:bg-gray-100 peer-checked:ring-1 peer-checked:ring-gray-800 transition h-full">
                                    <div class="font-bold text-gray-800">Platinum</div>
                                    <div class="text-xl font-extrabold text-gray-900 my-1">₹14,999</div>
                                    <ul class="text-[10px] text-gray-600 space-y-1">
                                        <li><i class="fas fa-star text-gray-800"></i> Yearly / 100 Ads</li>
                                        <li><i class="fas fa-globe text-gray-800"></i> Free Microsite</li>
                                    </ul>
                                </div>
                            </label>
                        </div>
                        <!-- Microsite Option (Smart) -->
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-100 rounded-xl flex items-center gap-4" id="microsite-container">
                            <input type="checkbox" id="microsite-addon" onchange="app.sell.toggleMicrosite(this)" class="w-5 h-5 text-primary-600 rounded focus:ring-primary-500 cursor-pointer">
                            <div>
                                <label for="microsite-addon" class="font-bold text-gray-800 text-sm cursor-pointer">Add Custom Microsite (tradeginger.com/yourbrand)</label>
                                <p class="text-xs text-gray-500" id="microsite-desc">Dedicated business page. + ₹3,999/month</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compliance Checkbox -->
                      <div class="mt-4 flex items-center gap-2 text-sm text-gray-600">
                        <input type="checkbox" id="accept-terms" required class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500 cursor-pointer">
                        <label for="accept-terms" class="cursor-pointer">
                            I accept the <a href="#" onclick="app.modals.tnc.show()" class="text-primary-600 font-semibold hover:underline">Terms & Conditions</a> and <a href="#" onclick="app.modals.privacy.show()" class="text-primary-600 font-semibold hover:underline">Privacy Policy</a>.
                        </label>
                    </div>

                </form>
            </div>
            <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-between items-center rounded-b-2xl pb-safe">
                <div class="text-sm text-gray-600 font-medium">Total: <span id="total-plan-price" class="font-extrabold text-xl text-primary-700 ml-2">₹0</span></div>
                <div class="flex gap-3">
                    <button onclick="app.modals.sell.hide()" class="px-6 py-2.5 rounded-xl text-gray-600 hover:bg-gray-200 font-medium transition">Cancel</button>
                    <button onclick="app.sell.submit()" id="sell-submit-btn" class="px-8 py-2.5 rounded-xl bg-accent-500 text-white font-bold hover:bg-accent-600 shadow-lg hover:shadow-accent-500/40 transition transform hover:-translate-y-0.5">Post & Pay</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Security & Config
        const CONFIG = {
            SUPABASE_URL: 'https://crepnlidfdoskighdhdt.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyZXBubGlkZmRvc2tpZ2hkaGR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4Mjg3MzYsImV4cCI6MjA2ODQwNDczNn0.SjrYMGxuIFDsSZpPBm6a_ZveuI_gef80o03TNESJlDw',
            CLOUDINARY_CLOUD_NAME: 'dcxhenppn',
            CLOUDINARY_PRESET: 'Tradeginger',
            SCHEMA_VERSION: "1.3",
            RAZORPAY_KEY_ID: "rzp_test_RhehzYF2lUBKpF"
        };

        const supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

        // --- SECURITY: DISABLE RIGHT CLICK & INSPECT ---
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; // F12
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; // Ctrl+Shift+I
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false; // Ctrl+Shift+C
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false; // Ctrl+Shift+J
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; // Ctrl+U
        };

        // --- STATE & SCHEMA ---
        const defaultSchema = [
            {
                id: 1, name: 'Cars', icon: 'fa-car',
                subcategories: ['Sedan', 'SUV', 'Hatchback', 'Luxury', 'MUV', 'Convertible', 'Coupe'],
                attributes: [
                    { key: 'brand', label: 'Brand', type: 'select', options: ['Maruti Suzuki', 'Hyundai', 'Tata', 'Mahindra', 'Kia', 'Toyota', 'Honda', 'MG', 'Renault', 'Volkswagen', 'Skoda', 'Nissan', 'Jeep', 'Citroen', 'Audi', 'BMW', 'Mercedes-Benz', 'Volvo', 'Jaguar', 'Land Rover', 'Porsche', 'Ford'] },
                    { key: 'model', label: 'Model', type: 'text' },
                    { key: 'variant', label: 'Variant', type: 'text' },
                    { key: 'fuel_type', label: 'Fuel Type', type: 'select', options: ['Petrol', 'Diesel', 'CNG', 'Electric', 'Hybrid'] },
                    { key: 'km_driven', label: 'KM Driven', type: 'number' },
                    { key: 'year', label: 'Model Year', type: 'number' },
                    { key: 'transmission', label: 'Transmission', type: 'select', options: ['Manual', 'Automatic', 'IMT'] },
                    { key: 'owners', label: 'No. of Owners', type: 'select', options: ['1st', '2nd', '3rd', '4th+'] }
                ]
            },
            {
                id: 2, name: 'Property', icon: 'fa-building',
                subcategories: ['Apartment', 'Villa', 'Plot', 'Commercial', 'Independent House', 'Builder Floor', 'Farmhouse'],
                attributes: [
                    { key: 'bedrooms', label: 'Bedrooms (BHK)', type: 'select', options: ['1 BHK', '2 BHK', '3 BHK', '4 BHK', '5+ BHK'] },
                    { key: 'bathrooms', label: 'Bathrooms', type: 'select', options: ['1', '2', '3', '4', '5+'] },
                    { key: 'area', label: 'Area (sq ft)', type: 'number' },
                    { key: 'furnishing', label: 'Furnishing', type: 'select', options: ['Furnished', 'Semi-Furnished', 'Unfurnished'] },
                    { key: 'construction_status', label: 'Status', type: 'select', options: ['Ready to Move', 'Under Construction'] },
                    { key: 'listed_by', label: 'Listed By', type: 'select', options: ['Owner', 'Dealer', 'Builder'] }
                ]
            },
            {
                id: 3, name: 'Mobiles', icon: 'fa-mobile-alt',
                subcategories: ['Smartphones', 'Tablets', 'Keypad Phones', 'Accessories'],
                attributes: [
                    { key: 'brand', label: 'Brand', type: 'select', options: ['Apple', 'Samsung', 'Xiaomi', 'Redmi', 'Vivo', 'Oppo', 'Realme', 'OnePlus', 'Google', 'Motorola', 'Nothing', 'Poco', 'iQOO'] },
                    { key: 'model', label: 'Model', type: 'text' },
                    { key: 'storage', label: 'Storage', type: 'select', options: ['64GB', '128GB', '256GB', '512GB', '1TB'] },
                    { key: 'ram', label: 'RAM', type: 'select', options: ['4GB', '6GB', '8GB', '12GB', '16GB+'] }
                ]
            },
            { 
                id: 4, name: 'Bikes', icon: 'fa-motorcycle', 
                subcategories: ['Motorcycle', 'Scooter', 'Sports Bike', 'Cruiser'], 
                attributes: [
                    { key: 'brand', label: 'Brand', type: 'select', options: ['Hero', 'Honda', 'TVS', 'Bajaj', 'Royal Enfield', 'Yamaha', 'Suzuki', 'KTM', 'Jawa', 'Ather', 'Ola'] },
                    { key: 'model', label: 'Model', type: 'text' },
                    { key: 'year', label: 'Year', type: 'number' },
                    { key: 'km_driven', label: 'KM Driven', type: 'number' }
                ] 
            },
            { 
                id: 5, name: 'Electronics', icon: 'fa-tv', 
                subcategories: ['TV', 'Laptop', 'Desktop', 'Camera', 'AC', 'Fridge', 'Audio'], 
                attributes: [
                    { key: 'brand', label: 'Brand', type: 'select', options: ['HP', 'Dell', 'Lenovo', 'Asus', 'Acer', 'Apple', 'Samsung', 'LG', 'Sony', 'Whirlpool', 'Godrej', 'Voltas', 'Daikin', 'Canon', 'Nikon', 'JBL'] }
                ] 
            },
            {
                id: 6, name: 'Services', icon: 'fa-tools',
                subcategories: ['Electrician', 'Plumber', 'Carpenter', 'Painter', 'Cleaning', 'Appliance Repair', 'Pest Control', 'Packers & Movers'],
                attributes: [
                    { key: 'experience', label: 'Experience (Years)', type: 'number' },
                    { key: 'visiting_charge', label: 'Visiting Charge (₹)', type: 'number' },
                    { key: 'availability', label: 'Availability', type: 'select', options: ['Anytime', 'Weekdays', 'Weekends', '24x7 Emergency'] }
                ]
            },
            { id: 7, name: 'Furniture', icon: 'fa-couch', subcategories: ['Sofa', 'Bed', 'Dining', 'Decor', 'Wardrobe'], attributes: [] },
            { id: 8, name: 'Fashion', icon: 'fa-tshirt', subcategories: ['Men', 'Women', 'Kids', 'Accessories', 'Watches'], attributes: [] },
            { id: 9, name: 'Pets', icon: 'fa-paw', subcategories: ['Dogs', 'Cats', 'Fish', 'Birds'], attributes: [] }
        ];

        // Versioned Schema Loading
        const storedVersion = localStorage.getItem('tg_schema_version');
        let categoriesToUse = defaultSchema;
        if (storedVersion === CONFIG.SCHEMA_VERSION) {
             const storedCats = localStorage.getItem('tg_categories');
             if(storedCats) categoriesToUse = JSON.parse(storedCats);
        } else {
            localStorage.setItem('tg_categories', JSON.stringify(defaultSchema));
            localStorage.setItem('tg_schema_version', CONFIG.SCHEMA_VERSION);
        }

        // --- COMPLETE INDIAN STATES & CITIES DATA ---
        const indianLocations = {
            "Andaman and Nicobar Islands": ["Port Blair"],
            "Andhra Pradesh": ["Visakhapatnam", "Vijayawada", "Guntur", "Nellore", "Kurnool", "Rajahmundry", "Tirupati", "Kakinada"],
            "Arunachal Pradesh": ["Itanagar", "Naharlagun"],
            "Assam": ["Guwahati", "Silchar", "Dibrugarh", "Jorhat", "Tezpur"],
            "Bihar": ["Patna", "Gaya", "Bhagalpur", "Muzaffarpur", "Purnia", "Darbhanga"],
            "Chandigarh": ["Chandigarh"],
            "Chhattisgarh": ["Raipur", "Bhilai", "Bilaspur", "Korba", "Durg"],
            "Dadra and Nagar Haveli and Daman and Diu": ["Daman", "Silvassa"],
            "Delhi": ["New Delhi", "North Delhi", "South Delhi", "East Delhi", "West Delhi"],
            "Goa": ["Panaji", "Margao", "Vasco da Gama", "Mapusa"],
            "Gujarat": ["Ahmedabad", "Surat", "Vadodara", "Rajkot", "Bhavnagar", "Jamnagar", "Gandhinagar"],
            "Haryana": ["Gurugram", "Faridabad", "Panipat", "Ambala", "Rohtak", "Hisar", "Karnal"],
            "Himachal Pradesh": ["Shimla", "Manali", "Dharamshala", "Mandi"],
            "Jammu and Kashmir": ["Srinagar", "Jammu", "Anantnag"],
            "Jharkhand": ["Ranchi", "Jamshedpur", "Dhanbad", "Bokaro", "Hazaribagh"],
            "Karnataka": ["Bengaluru", "Mysuru", "Hubballi-Dharwad", "Mangaluru", "Belagavi", "Davangere"],
            "Kerala": ["Thiruvananthapuram", "Kochi", "Kozhikode", "Thrissur", "Kollam", "Palakkad"],
            "Ladakh": ["Leh", "Kargil"],
            "Lakshadweep": ["Kavaratti"],
            "Madhya Pradesh": ["Bhopal", "Indore", "Gwalior", "Jabalpur", "Ujjain", "Sagar"],
            "Maharashtra": ["Mumbai", "Pune", "Nagpur", "Nashik", "Aurangabad", "Thane", "Navi Mumbai", "Solapur"],
            "Manipur": ["Imphal"],
            "Meghalaya": ["Shillong"],
            "Mizoram": ["Aizawl"],
            "Nagaland": ["Kohima", "Dimapur"],
            "Odisha": ["Bhubaneswar", "Cuttack", "Rourkela", "Berhampur", "Sambalpur"],
            "Puducherry": ["Puducherry"],
            "Punjab": ["Ludhiana", "Amritsar", "Jalandhar", "Patiala", "Bathinda", "Mohali"],
            "Rajasthan": ["Jaipur", "Jodhpur", "Udaipur", "Kota", "Ajmer", "Bikaner"],
            "Sikkim": ["Gangtok"],
            "Tamil Nadu": ["Chennai", "Coimbatore", "Madurai", "Trichy", "Salem", "Tirunelveli", "Erode"],
            "Telangana": ["Hyderabad", "Warangal", "Nizamabad", "Karimnagar", "Khammam"],
            "Tripura": ["Agartala"],
            "Uttar Pradesh": ["Lucknow", "Kanpur", "Varanasi", "Agra", "Noida", "Ghaziabad", "Meerut", "Prayagraj", "Bareilly", "Aligarh"],
            "Uttarakhand": ["Dehradun", "Haridwar", "Roorkee", "Nainital", "Haldwani"],
            "West Bengal": ["Kolkata", "Asansol", "Siliguri", "Durgapur", "Howrah", "Darjeeling"]
        };
        
        const locationsArray = Object.entries(indianLocations).map(([state, cities]) => ({
            state,
            cities: cities.sort()
        })).sort((a, b) => a.state.localeCompare(b.state));

        const state = {
            user: null,
            profile: null,
            categories: categoriesToUse,
            locations: locationsArray,
            currentChatRoom: null,
            ip: '127.0.0.1',
            pendingAuth: null, // For OTP flow
            pendingRegistrationData: null // NEW: To store profile data between signup and verification
        };

        // --- IMAGE UTILITIES ---
        const compressImage = async (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 500; 
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.4); 
                    }
                }
            });
        };

        const blobToBase64 = (blob) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        };

        // --- UTILS ---
        const utils = {
            sanitize: (str) => {
                if(!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            formatPrice: (price) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(price),
            timeAgo: (date) => {
                const seconds = Math.floor((new Date() - new Date(date)) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "y ago";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "mo ago";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "d ago";
                return "Just now";
            },
            toast: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-dark-800' };
                el.className = `toast ${colors[type]}`;
                el.innerHTML = `<i class="fas fa-info-circle"></i> <span>${utils.sanitize(msg)}</span>`;
                container.appendChild(el);
                setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(20px)'; setTimeout(() => el.remove(), 300); }, 3000);
            },
            // SECURE ADMIN CHECK
            isAdmin: () => state.user?.email === 'admin@tradeginger.com'
        };

        // --- APP MODULES ---
        const app = {
            init: async () => {
                try {
                    try { const res = await fetch('https://api.ipify.org?format=json'); const d = await res.json(); state.ip = d.ip; } catch(e){}
                    
                    const { data: { session } } = await supabase.auth.getSession();
                    if(session) await app.auth.setUser(session.user);
                    if (!session) app.auth.clearUser();

                    supabase.auth.onAuthStateChange(async (_event, session) => {
                        if (session?.user) await app.auth.setUser(session.user);
                        else app.auth.clearUser();
                        app.router.handle();
                    });

                    app.router.handle();
                    window.addEventListener('hashchange', app.router.handle);
                    app.chat.init();
                    
                    window.addEventListener('click', (e) => {
                       const dropdown = document.getElementById('user-menu-dropdown');
                       const btn = document.getElementById('user-menu-btn');
                       if (dropdown && btn && !btn.contains(e.target) && !dropdown.contains(e.target)) {
                           dropdown.classList.add('hidden');
                       }
                    });

                } catch (err) {
                    console.error("Init Error:", err);
                    utils.toast("Initialization failed. Please refresh.", "error");
                }
            },

            // ... [ADMIN]
            admin: {
                saveSchema: () => {
                    localStorage.setItem('tg_categories', JSON.stringify(state.categories));
                    localStorage.setItem('tg_schema_version', CONFIG.SCHEMA_VERSION); 
                    utils.toast('Schema Saved Successfully!', 'success');
                    app.router.handle(); 
                },
                addCategory: () => {
                    const name = prompt("Enter Category Name:");
                    if(!name) return;
                    const id = state.categories.length > 0 ? Math.max(...state.categories.map(c => c.id)) + 1 : 1;
                    state.categories.push({ id, name, icon: 'fa-box', subcategories: [], attributes: [] });
                    app.admin.saveSchema();
                },
                addSubcategory: (catId) => {
                    const name = prompt("Enter Subcategory Name:");
                    if(!name) return;
                    const cat = state.categories.find(c => c.id === catId);
                    if(cat) {
                        cat.subcategories.push(name);
                        app.admin.saveSchema();
                    }
                },
                addAttribute: (catId) => {
                    const label = prompt("Attribute Name (e.g. Fuel Type):");
                    if(!label) return;
                    const type = prompt("Type (text, number, select):", "text");
                    let options = [];
                    if(type === 'select') {
                        const opts = prompt("Enter options comma separated (e.g. Petrol, Diesel):");
                        if(opts) options = opts.split(',').map(s => s.trim());
                    }
                    const key = label.toLowerCase().replace(/\s+/g, '_');
                    const cat = state.categories.find(c => c.id === catId);
                    if(cat) {
                        cat.attributes.push({ key, label, type, options });
                        app.admin.saveSchema();
                    }
                }
            },

            // ... [AUTH]
            auth: {
                isRegistering: false,
                toggleMode: () => {
                    app.auth.isRegistering = !app.auth.isRegistering;
                    const regFields = document.getElementById('register-fields');
                    const typeToggle = document.getElementById('user-type-toggle');
                    const btnText = document.getElementById('auth-btn-text');
                    const switchText = document.getElementById('auth-switch-text');
                    const switchBtn = document.getElementById('auth-switch-btn');
                    const title = document.getElementById('auth-title');

                    if(app.auth.isRegistering) {
                        regFields.classList.remove('hidden');
                        typeToggle.classList.remove('hidden');
                        btnText.innerText = "Create Account";
                        switchText.innerText = "Already have an account?";
                        switchBtn.innerText = "Login";
                        title.innerText = "Join TradeGinger";
                    } else {
                        regFields.classList.add('hidden');
                        typeToggle.classList.add('hidden');
                        btnText.innerText = "Secure Login";
                        switchText.innerText = "New to TradeGinger?";
                        switchBtn.innerText = "Create Account";
                        title.innerText = "Welcome Back";
                    }
                },
                setUserType: (type, btn) => {
                    document.getElementById('auth-account-type').value = type;
                    const btns = btn.parentElement.querySelectorAll('button');
                    btns.forEach(b => {
                        b.classList.remove('bg-white', 'shadow-sm', 'text-gray-900', 'font-bold');
                        b.classList.add('text-gray-500', 'font-medium');
                    });
                    btn.classList.remove('text-gray-500', 'font-medium');
                    btn.classList.add('bg-white', 'shadow-sm', 'text-gray-900', 'font-bold');
                },
                resetAuth: () => {
                    document.getElementById('auth-form').classList.remove('hidden');
                    document.getElementById('otp-form').classList.add('hidden');
                    document.getElementById('auth-switch-wrapper').classList.remove('hidden');
                    state.pendingAuth = null;
                    state.pendingRegistrationData = null;
                },
                handleAuthSubmit: async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const email = fd.get('email');
                    const password = fd.get('password');

                    try {
                        if(app.auth.isRegistering) {
                            const firstName = fd.get('firstName');
                            const lastName = fd.get('lastName');
                            const accType = fd.get('accountType');
                            const fullName = `${firstName} ${lastName}`;
                            
                            // Store data for post-verification update
                            state.pendingRegistrationData = {
                                first_name: firstName,
                                last_name: lastName,
                                full_name: fullName,
                                account_type: accType
                            };

                            // Step 1: Initiate Sign Up - MINIMAL METADATA to avoid trigger errors
                            const { error } = await supabase.auth.signUp({
                                email, password,
                                options: { 
                                    data: { 
                                        full_name: fullName
                                        // Removed other fields from here to prevent DB Trigger errors
                                    } 
                                }
                            });
                            if(error) throw error;
                            
                            // Step 2: Switch to OTP UI
                            state.pendingAuth = { email };
                            document.getElementById('auth-form').classList.add('hidden');
                            document.getElementById('auth-switch-wrapper').classList.add('hidden');
                            document.getElementById('otp-form').classList.remove('hidden');
                            document.getElementById('otp-email-display').innerText = email;
                            
                            utils.toast('Verification code sent to your email', 'success');
                        } else {
                            const { error } = await supabase.auth.signInWithPassword({ email, password });
                            if(error) throw error;
                            utils.toast('Logged in successfully', 'success');
                            app.modals.auth.hide();
                        }
                    } catch (err) {
                        utils.toast(err.message, 'error');
                        console.error(err);
                    }
                },
                handleOtpSubmit: async (e) => {
                    e.preventDefault();
                    const token = e.target.querySelector('input[name="otp"]').value;
                    if(!token || !state.pendingAuth) return;

                    try {
                        // Verify Email OTP
                        const { data: { session, user }, error } = await supabase.auth.verifyOtp({
                            email: state.pendingAuth.email,
                            token: token,
                            type: 'signup'
                        });

                        if(error) throw error;
                        
                        // POST-VERIFICATION: Update Profile with extra details
                        if (state.pendingRegistrationData && user) {
                            const { error: updateError } = await supabase.from('profiles').update({
                                first_name: state.pendingRegistrationData.first_name,
                                last_name: state.pendingRegistrationData.last_name,
                                account_type: state.pendingRegistrationData.account_type,
                                // ip_log: state.ip // Optional: omit if column missing
                            }).eq('id', user.id);
                            
                            if(updateError) console.warn("Profile update warning:", updateError.message);
                        }

                        utils.toast('Email Verified! Logging in...', 'success');
                        app.modals.auth.hide();
                        app.auth.resetAuth();
                        
                    } catch (err) {
                        utils.toast(`Verification failed: ${err.message}`, 'error');
                    }
                },
                loginWithGoogle: async () => {
                    const { error } = await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } });
                    if(error) utils.toast(error.message, 'error');
                },
                setUser: async (user) => {
                    state.user = user;
                    const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
                    const dbProfile = data || {};
                    const meta = user.user_metadata || {};
                    
                    state.profile = {
                        ...dbProfile,
                        avatar_url: dbProfile.avatar_url || meta.avatar_url || meta.picture,
                        first_name: dbProfile.first_name || meta.first_name || meta.full_name?.split(' ')[0] || 'User',
                        account_type: dbProfile.account_type || meta.account_type || 'individual',
                        mobile: dbProfile.mobile
                    };
                    
                    app.ui.renderNav();
                    app.chat.fetchConversations();
                },
                clearUser: () => {
                    state.user = null;
                    state.profile = null;
                    app.ui.renderNav();
                    app.router.navigate('home');
                },
                logout: async (e) => {
                    if(e) e.preventDefault();
                    await supabase.auth.signOut();
                    app.auth.clearUser();
                    utils.toast('Logged out safely', 'info');
                }
            },

            // ... [PAYMENT]
            payment: {
                process: async (amount, desc) => {
                    return new Promise((resolve) => {
                        const options = {
                            "key": CONFIG.RAZORPAY_KEY_ID,
                            "amount": amount * 100,
                            "currency": "INR",
                            "name": "TradeGinger",
                            "description": desc,
                            "image": "https://placehold.co/128x128/0ea5e9/ffffff?text=TG",
                            "handler": function (response){
                                utils.toast(`Payment Successful! ID: ${response.razorpay_payment_id}`, 'success');
                                resolve(true);
                            },
                            "prefill": {
                                "name": state.profile?.full_name || "",
                                "email": state.user?.email || "",
                                "contact": state.profile?.mobile || ""
                            },
                            "theme": { "color": "#0ea5e9" },
                            "modal": { "ondismiss": function(){ resolve(false); } }
                        };
                        const rzp1 = new Razorpay(options);
                        rzp1.on('payment.failed', function (response){
                            utils.toast(`Payment Failed: ${response.error.description}`, 'error');
                            resolve(false);
                        });
                        rzp1.open();
                    });
                }
            },

            // ... [ROUTER]
            router: {
                navigate: (path) => window.location.hash = path,
                handle: async () => {
                    const hash = window.location.hash.slice(1) || 'home';
                    const [route, params] = hash.split('?');
                    const searchParams = new URLSearchParams(params);
                    const view = document.getElementById('app-view');
                    
                    window.scrollTo(0,0);

                    if(route === 'sell' || route === 'profile' || route === 'leads' || route === 'admin') {
                        if(!state.user) {
                            app.modals.auth.show();
                            return; 
                        }
                        if(route === 'admin' && !utils.isAdmin()) {
                            utils.toast("Access Denied: Admins Only", "error");
                            return app.router.navigate('home');
                        }
                    }

                    switch(route) {
                        case 'home':
                            view.innerHTML = app.views.home();
                            app.data.fetchHomeListings();
                            break;
                        case 'listing':
                            view.innerHTML = app.views.listings(searchParams.get('cat'), searchParams.get('q'));
                            app.data.fetchAllListings(searchParams);
                            break;
                        case 'detail':
                            const id = searchParams.get('id');
                            if(id) app.views.renderDetail(id);
                            break;
                        case 'profile':
                            view.innerHTML = app.views.profile();
                            app.data.fetchUserListings();
                            app.data.renderMyLeads(); 
                            break;
                        case 'leads':
                            view.innerHTML = app.views.leads();
                            break;
                        case 'admin':
                            view.innerHTML = app.views.admin();
                            break;
                        case 'sell':
                             app.modals.sell.show();
                             history.back();
                             break;
                        default:
                            view.innerHTML = app.views.home();
                    }
                }
            },

            // ... [DATA]
            data: {
                fetchHomeListings: async () => {
                    const grid = document.getElementById('home-feed');
                    if(!grid) return;
                    grid.innerHTML = app.ui.skeletonCard().repeat(4);
                    const { data, error } = await supabase.from('listings').select('*').limit(8).order('created_at', {ascending: false});
                    if(data) app.ui.renderGrid(grid, data);
                },
                fetchAllListings: async (params) => {
                    const grid = document.getElementById('listing-feed');
                    const title = document.getElementById('listing-title');
                    if(!grid) return;
                    grid.innerHTML = app.ui.skeletonCard().repeat(8);

                    let query = supabase.from('listings').select('*');
                    const catId = params.get('cat') ? state.categories.find(c => c.id == params.get('cat'))?.id : null;
                    const q = params.get('q');

                    if(title) title.innerText = q ? `Search: "${utils.sanitize(q)}"` : (params.get('catname') || 'All Listings');

                    if(catId) query = query.eq('category_id', catId);
                    if(q) query = query.ilike('title', `%${q}%`);

                    const cat = state.categories.find(c => c.id == catId);
                    if(cat && cat.attributes) {
                        cat.attributes.forEach(attr => {
                            const val = params.get(attr.key);
                            if(val) {
                                query = query.contains('attributes', { [attr.key]: val });
                            }
                        });
                    }

                    const { data, error } = await query.limit(50);
                    if(data && data.length > 0) app.ui.renderGrid(grid, data);
                    else grid.innerHTML = `<div class="col-span-full text-center py-20 text-gray-500 flex flex-col items-center"><i class="fas fa-search text-4xl mb-4 text-gray-300"></i>No items found matching "${utils.sanitize(q || '')}".</div>`;
                },
                fetchUserListings: async () => {
                    const grid = document.getElementById('user-ads');
                    if(!grid) return;
                    const { data } = await supabase.from('listings').select('*').eq('user_id', state.user.id);
                    if(data) app.ui.renderGrid(grid, data, true);
                },
                sendEnquiry: async (listingId, sellerId) => {
                    const name = document.getElementById('enquiry-name').value;
                    const phone = document.getElementById('enquiry-phone').value;
                    if(!name || !phone) return utils.toast('Please fill all fields', 'error');
                    utils.toast('Enquiry sent! Seller will contact you.', 'success');
                    document.getElementById('enquiry-form').reset();
                },
                buyLeadPack: async (type, amount, count) => {
                    if(await app.payment.process(amount, `${count} ${type} Leads`)) {
                        const leads = JSON.parse(localStorage.getItem('my_leads')) || [];
                        for(let i=0; i<count; i++) {
                            leads.push({
                                type: type,
                                name: `Lead ${Math.floor(Math.random() * 1000)}`,
                                phone: `+91 9${Math.floor(Math.random() * 900000000)}`,
                                requirement: `Interested in ${type}`,
                                date: new Date().toISOString()
                            });
                        }
                        localStorage.setItem('my_leads', JSON.stringify(leads));
                        utils.toast(`${count} Leads added! Check your profile.`, 'success');
                        setTimeout(() => app.router.navigate('profile'), 1000);
                    }
                },
                renderMyLeads: () => {
                    const container = document.getElementById('my-leads-container');
                    if(!container) return;
                    const leads = JSON.parse(localStorage.getItem('my_leads')) || [];
                    if(leads.length === 0) {
                        container.innerHTML = `<br>
                            <div class="text-center text-gray-500 py-8 flex flex-col items-center justify-center h-full">
                                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3 text-gray-400">
                                    <i class="fas fa-address-book text-xl"></i>
                                </div>
                                <p class="mb-3 text-sm font-medium">Grow your business with verified leads</p>
                                <a href="#leads" class="text-xs bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition shadow-sm">Buy Leads Now</a>
                            </div>
                        `;
                        return;
                    }
                    container.innerHTML = leads.map(l => `<br>
                        <div class="bg-white p-4 rounded-xl border border-gray-100 text-sm flex justify-between items-center hover:shadow-md transition group">
                            <div>
                                <div class="font-bold text-gray-800">${l.name}</div>
                                <div class="text-gray-500 text-xs mb-2">${l.type} • ${new Date(l.date).toLocaleDateString()}</div>
                                <div class="flex gap-2">
                                    <a href="tel:${l.phone}" class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded border border-green-100 hover:bg-green-100 transition flex items-center gap-1"><i class="fas fa-phone-alt"></i> Call</a>
                                    <a href="https://wa.me/${l.phone.replace(/\D/g,'')}" target="_blank" class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded border border-green-100 hover:bg-green-100 transition flex items-center gap-1"><i class="fab fa-whatsapp"></i> WA</a>
                                </div>
                            </div>
                            <div class="text-gray-900 font-mono font-bold text-xs bg-gray-50 px-2 py-1 rounded border border-gray-200">${l.phone}</div>
                        </div>
                    `).join('');
                }
            },

            views: {
                home: () => `<br>
                    <section class="relative h-[500px] flex items-center justify-center text-white fade-in">
                        <div class="absolute inset-0">
                            <img src="https://images.unsplash.com/photo-1521791136064-7986c2920216?q=85&w=1600&auto=format&fit=crop" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-b from-dark-900/80 via-dark-900/50 to-dark-900/90"></div>
                        </div>
                        <div class="relative z-10 text-center px-4 max-w-3xl mx-auto space-y-6">
                            <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight drop-shadow-lg">Buy & Sell in Your <span class="text-accent-500">Community</span></h1>
                            <p class="text-lg md:text-xl text-gray-200 font-light max-w-2xl mx-auto">India's most trusted marketplace. Verified sellers, premium listings, and zero fees for individuals.</p>
                            <form onsubmit="app.ui.handleSearch(event)" class="bg-white/10 backdrop-blur-xl p-2 rounded-full flex shadow-2xl border border-white/20 max-w-xl mx-auto">
                                <input type="text" id="hero-search" placeholder="Search cars, phones, property..." class="flex-grow bg-transparent text-white placeholder-gray-300 px-6 py-3 outline-none font-medium">
                                <button type="submit" class="bg-accent-500 hover:bg-accent-600 text-white px-8 py-3 rounded-full font-bold transition shadow-lg hover:shadow-accent-500/50">Search</button>
                            </form>
                        </div>
                    </section>
                    <section class="py-16 container mx-auto px-4">
                        <div class="flex justify-between items-end mb-8">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">Browse Categories</h2>
                                <p class="text-gray-500 text-sm mt-1">Find exactly what you're looking for</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                            ${state.categories.map(c => `<br>
                                <a href="#listing?cat=${c.id}&catname=${c.name}" class="flex flex-col items-center p-4 bg-white rounded-2xl shadow-sm hover:shadow-lg hover:-translate-y-1 transition border border-gray-100 group">
                                    <div class="w-14 h-14 rounded-full bg-primary-50 text-primary-600 flex items-center justify-center text-xl mb-3 group-hover:bg-primary-600 group-hover:text-white transition shadow-inner"><i class="fas ${c.icon}"></i></div>
                                    <span class="font-semibold text-sm text-gray-700 group-hover:text-primary-700">${c.name}</span>
                                </a>
                            `).join('')}
                        </div>
                    </section>
                    <section class="py-16 bg-white border-t border-gray-100">
                        <div class="container mx-auto px-4">
                            <div class="flex justify-between items-end mb-10">
                                <div>
                                    <h2 class="text-3xl font-bold text-gray-900 tracking-tight">Fresh Recommendations</h2>
                                    <p class="text-gray-500 mt-1">Handpicked premium items just for you</p>
                                </div>
                                <a href="#listing" class="text-primary-600 font-bold hover:text-primary-700 flex items-center gap-2 transition group">View All <i class="fas fa-arrow-right text-xs group-hover:translate-x-1 transition-transform"></i></a>
                            </div>
                            <div id="home-feed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8"></div>
                        </div>
                    </section>
                `,
                listings: (catId, q) => {
                    const category = state.categories.find(c => c.id == catId);
                    let sidebarFilters = '';
                    
                    if(category && category.attributes.length > 0) {
                        sidebarFilters = `<br>
                            <div class="w-full md:w-72 flex-shrink-0 mb-8 md:mb-0">
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 sticky top-24">
                                    <div class="flex justify-between items-center mb-6">
                                        <h3 class="font-bold text-lg text-gray-900">Filters</h3>
                                        <button onclick="app.router.handle()" class="text-xs text-primary-600 hover:underline">Reset</button>
                                    </div>
                                    ${category.attributes.map(attr => `<br>
                                        <div class="mb-5">
                                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">${attr.label}</label>
                                            ${attr.type === 'select' ? `<br>
                                                <div class="relative">
                                                    <select onchange="app.ui.applyFilter('${attr.key}', this.value)" class="w-full border border-gray-200 rounded-lg text-sm px-3 py-2.5 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-primary-100 appearance-none">
                                                        <option value="">All</option>
                                                        ${attr.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                                                    </select>
                                                    <i class="fas fa-chevron-down absolute right-3 top-3.5 text-gray-400 pointer-events-none text-xs"></i>
                                                </div>
                                            ` : `<br>
                                                <input type="${attr.type}" placeholder="Any" class="w-full border border-gray-200 rounded-lg text-sm px-3 py-2.5 bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-primary-100">
                                            `}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    return `<br>
                    <div class="bg-gray-50 min-h-screen py-10">
                        <div class="container mx-auto px-4">
                            <div class="mb-8 flex items-center text-sm text-gray-500 font-medium">
                                <a href="#home" class="hover:text-primary-600 transition">Home</a> 
                                <span class="mx-3 text-gray-300">/</span> 
                                <span class="text-gray-900">Listings</span>
                            </div>
                            <div class="flex flex-col md:flex-row md:gap-10">
                                ${sidebarFilters}
                                <div class="flex-grow">
                                    <h1 class="text-3xl font-bold mb-8 text-gray-900" id="listing-title">All Listings</h1>
                                    <div id="listing-feed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                        <!-- Data loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `},
                admin: () => `<br>
                    <div class="container mx-auto px-4 py-10 fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                            <button onclick="app.admin.addCategory()" class="bg-primary-600 text-white px-4 py-2 rounded hover:bg-primary-700">+ New Category</button>
                        </div>
                        <div class="grid gap-6">
                            ${state.categories.map(cat => `<br>
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <div class="flex justify-between items-start mb-4 border-b pb-4">
                                        <div>
                                            <h3 class="text-xl font-bold"><i class="fas ${cat.icon} mr-2 text-gray-400"></i>${cat.name}</h3>
                                            <p class="text-xs text-gray-500">ID: ${cat.id}</p>
                                        </div>
                                        <div class="space-x-2">
                                            <button onclick="app.admin.addSubcategory(${cat.id})" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">+ Subcat</button>
                                            <button onclick="app.admin.addAttribute(${cat.id})" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">+ Attribute</button>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <h4 class="font-semibold text-sm text-gray-600 mb-2">Subcategories</h4>
                                            <div class="flex flex-wrap gap-2">
                                                ${cat.subcategories.map(s => `<span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs">${s}</span>`).join('')}
                                            </div>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-sm text-gray-600 mb-2">Attributes</h4>
                                            <div class="space-y-2">
                                                ${cat.attributes.map(a => `<br>
                                                    <div class="text-xs bg-gray-50 p-2 rounded flex justify-between">
                                                        <span><strong>${a.label}</strong> (${a.type})</span>
                                                        ${a.options ? `<span class="text-gray-500 truncate ml-2 max-w-[150px]">${a.options.join(', ')}</span>` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `,
                renderDetail: async (id) => {
                    const view = document.getElementById('app-view');
                    view.innerHTML = `<div class="h-screen flex items-center justify-center"><div class="loader"></div></div>`;
                    
                    try {
                        // FIX 1: Decoupled queries to avoid FK error
                        const { data: ad, error: adError } = await supabase
                            .from('listings')
                            .select('*')
                            .eq('id', id)
                            .single();
                        
                        if (adError) throw adError;
                        if (!ad) { view.innerHTML = `<div class="p-20 text-center">Ad not found</div>`; return; }

                        // Fetch profile separately (safe fetch)
                        let userProfile = {};
                        if (ad.user_id) {
                            const { data: profile } = await supabase
                                .from('profiles')
                                .select('*')
                                .eq('id', ad.user_id)
                                .single();
                            userProfile = profile || {};
                        }

                        const mainImg = ad.image_urls?.[0] || 'https://placehold.co/600x400?text=No+Image';
                        const userAvatar = userProfile.avatar_url || 'https://placehold.co/50x50?text=U';
                        const sellerName = userProfile.full_name || 'TradeGinger User';
                        const sellerPhone = userProfile.mobile || '9876543210';

                        view.innerHTML = `<br>
                            <div class="container mx-auto px-4 py-8 fade-in">
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div class="lg:col-span-2 space-y-4">
                                        <div class="bg-black rounded-xl overflow-hidden h-[400px] md:h-[500px] flex items-center justify-center relative group">
                                            <img src="${mainImg}" id="main-img" class="h-full w-full object-contain">
                                        </div>
                                        <div class="flex gap-2 overflow-x-auto pb-2">
                                            ${(ad.image_urls || []).map(url => `<br>
                                                <img src="${url}" onclick="document.getElementById('main-img').src='${url}'" class="w-20 h-20 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-primary-500">
                                            `).join('')}
                                        </div>
                                        
                                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
                                            <h3 class="text-xl font-bold mb-4">Description</h3>
                                            <p class="text-gray-700 leading-relaxed whitespace-pre-line">${utils.sanitize(ad.description)}</p>
                                            <div class="mt-6 grid grid-cols-2 gap-4 text-sm">
                                                <div class="bg-gray-50 p-3 rounded"><strong>Category:</strong> ${ad.subcategory || 'General'}</div>
                                                <div class="bg-gray-50 p-3 rounded"><strong>Location:</strong> ${utils.sanitize(ad.location)}</div>
                                                <div class="bg-gray-50 p-3 rounded"><strong>Posted:</strong> ${utils.timeAgo(ad.created_at)}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="space-y-6">
                                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 sticky top-24">
                                            <h1 class="text-2xl font-bold text-gray-900 mb-2">${utils.sanitize(ad.title)}</h1>
                                            <div class="text-3xl font-extrabold text-primary-600 mb-6">${utils.formatPrice(ad.price)}</div>
                                            
                                            <div class="flex items-center gap-4 mb-6 pb-6 border-b">
                                                <img src="${userAvatar}" class="w-14 h-14 rounded-full object-cover border">
                                                <div>
                                                    <p class="font-bold text-lg">${utils.sanitize(sellerName)}</p>
                                                    <p class="text-xs text-gray-500">Member since 2024</p>
                                                </div>
                                            </div>

                                            <div class="space-y-3">
                                                <div id="phone-section" class="bg-green-50 border border-green-200 p-3 rounded-lg flex justify-between items-center">
                                                    <div class="text-green-800 font-medium font-mono" data-phone="${sellerPhone}"><i class="fas fa-phone-alt mr-2"></i> +91 XXXXX XXXXX</div>
                                                    <button onclick="app.ui.unlockBuyerPhone(this)" class="text-xs bg-green-600 text-white px-3 py-1 rounded shadow hover:bg-green-700">Unlock (₹5)</button>
                                                </div>

                                                <button onclick="app.chat.start('${ad.user_id}', '${ad.id}', '${sellerName.replace(/'/g, "")}')" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 rounded-lg shadow-md transition flex items-center justify-center gap-2">
                                                    <i class="fas fa-comment-dots"></i> Chat with Seller
                                                </button>

                                                <div class="border-t pt-4 mt-4">
                                                    <h4 class="font-bold text-gray-700 mb-2">Send Enquiry</h4>
                                                    <form id="enquiry-form" onsubmit="event.preventDefault(); app.data.sendEnquiry('${ad.id}', '${ad.user_id}')" class="space-y-2">
                                                        <input type="text" id="enquiry-name" placeholder="Your Name" class="w-full text-sm border rounded px-3 py-2 bg-gray-50">
                                                        <input type="tel" id="enquiry-phone" placeholder="Your Phone Number" class="w-full text-sm border rounded px-3 py-2 bg-gray-50">
                                                        <button type="submit" class="w-full bg-gray-800 text-white text-sm py-2 rounded hover:bg-gray-900">Send Interest</button>
                                                    </form>
                                                </div>

                                                ${state.user?.id === ad.user_id ? `<div class="text-center text-sm text-gray-500 bg-gray-100 p-2 rounded">This is your ad</div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch(e) {
                        console.error(e);
                        view.innerHTML = `<div class="p-10 text-center text-red-500">Error loading ad details.</div>`;
                    }
                },
                profile: () => `<br>
                    <div class="container mx-auto px-4 py-12 fade-in">
                        <div class="bg-white rounded-3xl shadow-soft border border-gray-100 overflow-hidden mb-10">
                            <div class="h-40 bg-gradient-to-r from-dark-800 to-dark-900 relative">
                                <div class="absolute inset-0 bg-white/5 pattern-grid-lg"></div>
                            </div>
                            <div class="px-8 pb-8 flex flex-col md:flex-row items-end md:items-center gap-8 -mt-16 relative z-10">
                                <img src="${state.profile?.avatar_url || 'https://placehold.co/150x150'}" class="w-32 h-32 rounded-full border-4 border-white shadow-lg bg-white object-cover">
                                <div class="flex-grow mb-2">
                                    <div class="flex items-center gap-3 flex-wrap">
                                        <h1 class="text-3xl font-bold text-gray-900 tracking-tight">${utils.sanitize(state.profile?.full_name || 'User')}</h1>
                                        ${state.profile?.account_type === 'business' ? '<span class="bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1 rounded-full border border-blue-100 flex items-center gap-1"><i class="fas fa-check-circle"></i> Verified Business</span>' : ''}
                                        <button onclick="utils.toast('Profile editing coming soon!', 'info')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full border hover:bg-gray-200 transition font-medium">Edit</button>
                                    </div>
                                    <p class="text-gray-500 font-medium mt-1"><i class="fas fa-envelope mr-2 opacity-50"></i> ${state.user?.email}</p>
                                </div>
                                <div class="mb-4 flex gap-3">
                                    ${utils.isAdmin() ? `<button onclick="app.router.navigate('admin')" class="bg-dark-800 text-white px-5 py-2.5 rounded-xl hover:bg-dark-900 transition font-bold shadow-lg shadow-dark-800/20">Admin Dashboard</button>` : ''}
                                    <button onclick="app.router.navigate('leads')" class="bg-accent-500 text-white hover:bg-accent-600 px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-accent-500/30 transition"><i class="fas fa-bolt mr-2"></i> Buy Leads</button>
                                    <button onclick="app.auth.logout(event)" class="bg-white text-red-500 hover:bg-red-50 px-5 py-2.5 rounded-xl font-bold border border-red-100 transition">Logout</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                            <div class="lg:col-span-2">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-bold text-gray-900">My Listings</h2>
                                    <button onclick="app.router.navigate('sell')" class="text-sm text-primary-600 font-bold hover:underline">+ Post New</button>
                                </div>
                                <div id="user-ads" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold mb-6 text-gray-900">My Purchased Leads</h2>
                                <div id="my-leads-container" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 space-y-3 h-[500px] overflow-y-auto custom-scrollbar">
                                    <!-- Leads injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                toggleView: () => {
                    const isMobileDevice = window.matchMedia("(max-width: 768px)").matches;
                    const body = document.body;
                    const icon = document.getElementById('view-switch-icon');
                    
                    if (isMobileDevice) {
                        // On Mobile: Toggle Viewport to Desktop
                        const meta = document.getElementById('viewport-meta');
                        if (meta.content.includes('width=1280')) {
                            meta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
                            icon.className = 'fas fa-desktop text-lg';
                            utils.toast("Switched to Mobile View", "success");
                        } else {
                            meta.content = 'width=1280';
                            icon.className = 'fas fa-mobile-alt text-lg';
                            utils.toast("Switched to Desktop View", "success");
                        }
                    } else {
                        // On Desktop: Toggle Mobile Simulation
                        body.classList.toggle('simulate-mobile');
                        if (body.classList.contains('simulate-mobile')) {
                            icon.className = 'fas fa-desktop text-lg';
                            utils.toast("Simulating Mobile View", "success");
                        } else {
                            icon.className = 'fas fa-mobile-alt text-lg';
                            utils.toast("Switched to Full View", "success");
                        }
                    }
                }
            },

            ui: {
                // ... [SKELETON, RENDER GRID, UNLOCK PHONE: Same logic, slightly refined HTML]
                skeletonCard: () => `<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden"><div class="h-48 skeleton"></div><div class="p-4 space-y-3"><div class="h-6 w-3/4 skeleton rounded-md"></div><div class="h-4 w-1/2 skeleton rounded-md"></div></div></div>`,
                
                unlockBuyerPhone: async (btn) => {
                    if(await app.payment.process(5, "Buyer Unlock Fee")) {
                        const container = btn.parentElement;
                        const displayDiv = container.querySelector('div[data-phone]');
                        if(displayDiv) {
                             const realPhone = displayDiv.getAttribute('data-phone');
                             displayDiv.innerHTML = `<i class="fas fa-phone-alt mr-2"></i> +91 ${realPhone}`;
                             btn.remove();
                        } else {
                            utils.toast("Phone number displayed above!", "success");
                        }
                    }
                },
                unlockSellerPhone: async () => {
                    if(await app.payment.process(99, "Seller Visibility Boost")) {
                        utils.toast("Your phone number is now visible to all buyers immediately!", "success");
                    }
                },
                renderGrid: (container, items, canEdit = false) => {
                    if(items.length === 0) {
                        container.innerHTML = `<br>
                            <div class="col-span-full text-center py-16 text-gray-500 bg-white rounded-2xl border border-dashed border-gray-200">
                                <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-box-open text-3xl text-gray-300"></i>
                                </div>
                                <p class="font-medium">No items found here yet.</p>
                                ${canEdit ? '<button onclick="app.router.navigate(\'sell\')" class="mt-4 text-primary-600 font-bold hover:underline">Start Selling</button>' : ''}
                            </div>`;
                        return;
                    }
                    const isAdmin = utils.isAdmin();
                    container.innerHTML = items.map(item => {
                        // Determine card style based on plan (Check attributes if col missing)
                        let cardClass = "group bg-white rounded-2xl border border-gray-100 overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 relative";
                        let badge = "";
                        
                        // Fallback logic for plan type since column might be missing
                        const planType = item.listing_type || item.attributes?.listing_type;
                        
                        // Logic to determine plan
                        if(planType === 'platinum') {
                            cardClass += " card-platinum";
                            badge = `<div class="absolute top-3 left-3 bg-gradient-to-r from-gray-700 to-gray-900 text-white text-[10px] font-bold px-2.5 py-1 rounded shadow-lg tracking-wide z-10">PLATINUM</div>`;
                        } else if (planType === 'gold') {
                            cardClass += " card-gold";
                            badge = `<div class="absolute top-3 left-3 bg-gradient-to-r from-yellow-400 to-yellow-600 text-white text-[10px] font-bold px-2.5 py-1 rounded shadow-lg tracking-wide z-10">GOLD</div>`;
                        }

                        return `<br>
                        <div class="${cardClass}">
                            <a href="#detail?id=${item.id}" class="block">
                                <div class="relative h-52 overflow-hidden bg-gray-100">
                                    <img src="${item.image_urls?.[0] || 'https://placehold.co/400x300'}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                                    <div class="absolute bottom-3 left-3 bg-white/90 backdrop-blur text-gray-800 text-xs font-bold px-2.5 py-1 rounded-lg flex items-center gap-1 shadow-sm">
                                        <i class="fas fa-map-marker-alt text-primary-500"></i> ${utils.sanitize(item.location || item.cities?.name)}
                                    </div>
                                    ${badge}
                                </div>
                                <div class="p-5">
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="font-extrabold text-xl text-gray-900 truncate pr-2">${utils.formatPrice(item.price)}</h3>
                                    </div>
                                    <p class="text-gray-600 text-sm truncate mb-4 font-medium">${utils.sanitize(item.title)}</p>
                                    ${item.attributes ? `<div class="text-[10px] text-gray-500 mb-3 flex gap-2 flex-wrap">
                                        ${Object.entries(item.attributes).slice(0,2).filter(([k])=>k!=='listing_type').map(([k,v]) => `<span class="bg-gray-50 border border-gray-100 px-2 py-1 rounded-md capitalize font-medium">${k.replace('_',' ')}: ${v}</span>`).join('')}
                                    </div>` : ''}
                                    <div class="flex justify-between items-center text-xs text-gray-400 border-t border-gray-50 pt-3 font-medium">
                                        <span>${utils.timeAgo(item.created_at)}</span>
                                        <span class="text-primary-600 bg-primary-50 px-2 py-0.5 rounded">${item.subcategory || 'Item'}</span>
                                    </div>
                                </div>
                            </a>
                            ${(canEdit || isAdmin) ? `<br>
                                <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-20">
                                    ${canEdit ? `<button onclick="app.sell.edit('${item.id}')" class="bg-white text-primary-600 w-8 h-8 rounded-full flex items-center justify-center shadow-lg hover:bg-primary-600 hover:text-white transition"><i class="fas fa-edit text-xs"></i></button>` : ''}
                                    <button onclick="app.sell.delete('${item.id}')" class="bg-white text-red-500 w-8 h-8 rounded-full flex items-center justify-center shadow-lg hover:bg-red-500 hover:text-white transition"><i class="fas fa-trash text-xs"></i></button>
                                </div>
                            ` : ''}
                            ${canEdit ? `<button onclick="app.ui.unlockSellerPhone()" class="absolute bottom-[4.5rem] right-3 bg-green-50 text-green-700 px-2 py-1 rounded text-[10px] font-bold shadow hover:bg-green-100 z-20 border border-green-200">Boost Phone ₹99</button>` : ''}
                        </div>
                    `}).join('');
                },
                handleSearch: (e) => { e.preventDefault(); const val = e.target.querySelector('input').value; app.router.navigate('listing?q='+val); },
                applyFilter: (key, value) => { 
                    const currentUrl = new URL(window.location.href);
                    let [hash, query] = currentUrl.hash.split('?');
                    const params = new URLSearchParams(query);
                    if(value) params.set(key, value);
                    else params.delete(key);
                    window.location.hash = `${hash}?${params.toString()}`;
                },
                renderNav: () => { 
                    const nav = document.getElementById('nav-auth-section');
                    const mobile = document.getElementById('nav-auth-section-mobile');
                    
                    if(state.user) {
                        const avatarHtml = `<img src="${state.profile?.avatar_url || 'https://placehold.co/40x40'}" class="w-8 h-8 rounded-full border border-gray-200 object-cover cursor-pointer" onclick="app.router.navigate('profile')">`;
                        
                        const desktopHtml = `<br>
                            <button onclick="document.getElementById('chat-modal').classList.remove('hidden')" class="relative text-gray-500 hover:text-primary-600 text-xl"><i class="fas fa-comment-dots"></i></button>
                            <div class="relative">
                                <button id="user-menu-btn" onclick="document.getElementById('user-menu-dropdown').classList.toggle('hidden')" class="flex items-center gap-2 focus:outline-none">
                                    ${avatarHtml}
                                </button>
                                <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 hidden py-2 animate-fade-in z-50">
                                    <div class="px-4 py-2 border-b border-gray-50 text-sm font-bold text-gray-700">${utils.sanitize(state.profile?.first_name)}</div>
                                    <a href="#profile" class="block px-4 py-2 text-sm text-gray-600 hover:bg-primary-50">My Profile</a>
                                    ${utils.isAdmin() ? `<a href="#admin" class="block px-4 py-2 text-sm text-blue-600 hover:bg-blue-50">Admin Dashboard</a>` : ''}
                                    <div class="border-t border-gray-50 my-1"></div>
                                    <a href="#" onclick="app.auth.logout(event)" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Logout</a>
                                </div>
                            </div>
                        `;
                        
                        nav.innerHTML = desktopHtml;
                        mobile.innerHTML = avatarHtml;
                    } else {
                        nav.innerHTML = `<button onclick="app.modals.auth.show()" class="bg-primary-50 text-primary-700 px-4 py-2 rounded-full text-sm font-bold hover:bg-primary-100 transition shadow-sm border border-primary-100">Login / Register</button>`;
                        mobile.innerHTML = `<button onclick="app.modals.auth.show()" class="text-sm font-bold text-primary-600">Login</button>`;
                    }
                },
                toggleView: () => app.views.toggleView() // Hook to view function
            },

            // ... [MODALS, SELL, LOCATION, CHAT: Logic preserved, ensuring integration]
            modals: {
                auth: {
                    show: () => { document.getElementById('auth-modal').classList.remove('hidden', 'opacity-0', 'pointer-events-none'); document.getElementById('auth-modal').classList.add('opacity-100'); },
                    hide: () => { document.getElementById('auth-modal').classList.add('hidden', 'opacity-0', 'pointer-events-none'); }
                },
                sell: {
                    show: async () => {
                        document.getElementById('sell-modal').classList.remove('hidden');
                        // Reset form defaults if not editing
                        if(!app.sell.isEditing) {
                            document.getElementById('sell-form').reset();
                            document.getElementById('sell-modal-title').innerText = 'Post an Ad';
                            document.getElementById('sell-submit-btn').innerText = 'Post & Pay';
                            document.getElementById('plan-selection-section').classList.remove('hidden');
                            document.getElementById('preview-container').innerHTML = '';
                        }
                        
                        const catSelect = document.getElementById('category-select');
                        if(catSelect.options.length <= 1) {
                            state.categories.forEach(c => {
                                const opt = document.createElement('option');
                                opt.value = c.id; opt.text = c.name;
                                catSelect.add(opt);
                            });
                            const stSelect = document.getElementById('state-select');
                            if(stSelect.options.length <= 1) { // Populate states only once
                                state.locations.forEach(l => {
                                    const opt = document.createElement('option');
                                    opt.value = l.state; opt.text = l.state;
                                    stSelect.add(opt);
                                });
                            }
                        }
                    },
                    hide: () => {
                        document.getElementById('sell-modal').classList.add('hidden');
                        app.sell.isEditing = false; // Reset edit state
                    }
                },
                tnc: {
                    show: () => document.getElementById('info-modal').classList.remove('hidden'),
                    hide: () => document.getElementById('info-modal').classList.add('hidden')
                },
                privacy: {
                      show: () => document.getElementById('privacy-modal').classList.remove('hidden'),
                      hide: () => document.getElementById('privacy-modal').classList.add('hidden')
                },
                sitemap: {
                      show: () => document.getElementById('sitemap-modal').classList.remove('hidden'),
                      hide: () => document.getElementById('sitemap-modal').classList.add('hidden')
                }
            },
            sell: {
                stagedFiles: [],
                planPrice: 0,
                micrositeCost: 0,
                isEditing: false,
                handleCategoryChange: (catId) => {
                    app.sell.updateSubcats(catId);
                    app.sell.renderAttributes(catId);
                },
                updateSubcats: (catId) => {
                   const cat = state.categories.find(c => c.id == catId);
                   const sub = document.getElementById('subcategory-select');
                   sub.innerHTML = "<option value=''>Select...</option>";
                   sub.disabled = false;
                   if(cat && cat.subcategories) {
                       cat.subcategories.forEach(s => { const o = document.createElement('option'); o.text = s; o.value = s; sub.add(o); });
                   }
                },
                renderAttributes: (catId) => {
                    const cat = state.categories.find(c => c.id == catId);
                    const container = document.getElementById('dynamic-attributes');
                    container.innerHTML = '';

                    if(cat && cat.attributes) {
                        cat.attributes.forEach(attr => {
                            const div = document.createElement('div');
                            const label = `<label class="block text-xs font-bold text-gray-500 uppercase mb-2">${attr.label}</label>`;
                            let input = '';
                            if(attr.type === 'select') {
                                input = `<div class="relative"><select name="attr_${attr.key}" id="attr_${attr.key}" class="w-full rounded-xl border-gray-200 border px-4 py-3 focus:ring-2 focus:ring-primary-500 outline-none bg-gray-50 focus:bg-white appearance-none">
                                            <option value="">Select...</option>
                                            ${attr.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                                       </select><i class="fas fa-chevron-down absolute right-4 top-3.5 text-gray-400 pointer-events-none"></i></div>`;
                            } else {
                                input = `<input type="${attr.type}" name="attr_${attr.key}" id="attr_${attr.key}" class="w-full rounded-xl border-gray-200 border px-4 py-3 focus:ring-2 focus:ring-primary-500 outline-none">`;
                            }
                            div.innerHTML = label + input;
                            container.appendChild(div);
                        });
                    }
                },
                handleFiles: (e) => {
                    const files = Array.from(e.target.files);
                    app.sell.stagedFiles.push(...files);
                    const container = document.getElementById('preview-container');
                    // Don't clear, append
                    files.forEach(f => {
                        const url = URL.createObjectURL(f);
                        container.innerHTML += `<img src="${url}" class="w-16 h-16 object-cover rounded-lg border border-gray-200 shadow-sm">`;
                    });
                },
                updatePlanPrice: (price) => {
                    app.sell.planPrice = price;
                    
                    // Microsite Logic Check
                    const plan = document.querySelector('input[name="plan"]:checked')?.value;
                    const micrositeCheck = document.getElementById('microsite-addon');
                    const micrositeContainer = document.getElementById('microsite-container');
                    const micrositeDesc = document.getElementById('microsite-desc');

                    if(plan === 'platinum') {
                        // Auto-include microsite in Platinum
                        micrositeCheck.checked = true;
                        micrositeCheck.disabled = true;
                        micrositeContainer.classList.add('opacity-50', 'pointer-events-none');
                        micrositeDesc.innerText = "Included with Platinum Plan";
                        app.sell.micrositeCost = 0;
                    } else {
                        micrositeCheck.disabled = false;
                        micrositeContainer.classList.remove('opacity-50', 'pointer-events-none');
                        micrositeDesc.innerText = "Dedicated business page. + ₹3,999/month";
                        // If it was checked manually, charge for it
                        app.sell.micrositeCost = micrositeCheck.checked ? 3999 : 0;
                    }

                    app.sell.calcTotal();
                },
                toggleMicrosite: (cb) => {
                    app.sell.micrositeCost = cb.checked ? 3999 : 0;
                    app.sell.calcTotal();
                },
                calcTotal: () => {
                    document.getElementById('total-plan-price').innerText = `₹${app.sell.planPrice + app.sell.micrositeCost}`;
                },
                generateAI: async () => {
                    const title = document.getElementsByName('title')[0].value;
                    if(!title) return utils.toast('Enter title first', 'error');
                    document.getElementById('ad-description').value = `Premium ${title} in excellent condition. Verified by TradeGinger AI. Contact for more details.`;
                    utils.toast('AI Generated Description (Mock)', 'success');
                },
                edit: async (adId) => {
                    app.sell.isEditing = true;
                    const { data: ad } = await supabase.from('listings').select('*, cities(*)').eq('id', adId).single();
                    if(!ad) return utils.toast("Error loading ad", "error");

                    await app.modals.sell.show();
                    
                    document.getElementById('sell-modal-title').innerText = 'Edit Ad';
                    document.getElementById('sell-submit-btn').innerText = 'Update Ad';
                    document.getElementById('plan-selection-section').classList.add('hidden'); // Don't ask plan on edit
                    document.getElementById('edit-id').value = ad.id;

                    document.querySelector('[name="title"]').value = ad.title;
                    document.querySelector('[name="price"]').value = ad.price;
                    document.querySelector('[name="description"]').value = ad.description;
                    
                    // Pre-fill Location logic
                    let foundState = null;
                    for(const loc of state.locations) {
                        if(loc.cities.includes(ad.location)) {
                            foundState = loc.state;
                            break;
                        }
                    }

                    if(foundState) {
                         const stSelect = document.getElementById('state-select');
                         stSelect.value = foundState; 
                         app.location.populateCities(foundState, 'city-select');
                         document.getElementById('city-select').value = ad.location; 
                         document.getElementById('city-select').disabled = false;
                    }

                    document.getElementById('category-select').value = ad.category_id;
                    app.sell.handleCategoryChange(ad.category_id);
                    setTimeout(() => { 
                         document.getElementById('subcategory-select').value = ad.subcategory;
                         if(ad.attributes) {
                            Object.entries(ad.attributes).forEach(([key, val]) => {
                                const el = document.getElementById(`attr_${key}`);
                                if(el) el.value = val;
                            });
                        }
                    }, 100);
                    
                    const container = document.getElementById('preview-container');
                    container.innerHTML = '';
                    if(ad.image_urls) {
                        ad.image_urls.forEach(url => {
                            container.innerHTML += `<img src="${url}" class="w-16 h-16 object-cover rounded-lg border border-gray-200">`;
                        });
                    }
                },
                submit: async () => {
                    const form = document.getElementById('sell-form');
                    if(!form.checkValidity()) return utils.toast('Please fill all fields', 'error');
                    
                    const terms = document.getElementById('accept-terms').checked;
                    if(!terms) return utils.toast('Please accept the Terms & Conditions', 'error');
                    
                    const totalCost = app.sell.planPrice + app.sell.micrositeCost;

                    // Payment only if NOT editing and price > 0
                    if(!app.sell.isEditing && totalCost > 0) {
                        const success = await app.payment.process(totalCost, "Ad Posting & Plans");
                        if(!success) return;
                    }
                    
                    utils.toast(app.sell.isEditing ? 'Updating...' : 'Compressing & Uploading...', 'info');
                    
                    // FIX 2: Robust Image Handling (Upload or Base64 Fallback)
                    const imageUrls = [];
                    for (const file of app.sell.stagedFiles) {
                         try {
                            const compressedBlob = await compressImage(file);
                            const fileName = `${state.user.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.jpg`;
                            
                            // Try uploading to Supabase Storage
                            const { data, error } = await supabase.storage.from('listings').upload(fileName, compressedBlob, {
                                cacheControl: '3600',
                                upsert: false
                            });

                            if (error) throw error;
                            
                            const { data: publicUrlData } = supabase.storage.from('listings').getPublicUrl(fileName);
                            imageUrls.push(publicUrlData.publicUrl);

                        } catch(e) { 
                            console.warn("Storage upload failed, falling back to Base64:", e.message);
                            // Fallback: Convert image to Base64 string and store directly
                            // This ensures the user's actual image is shown even without storage bucket access
                            try {
                                const base64 = await blobToBase64(file); 
                                imageUrls.push(base64);
                            } catch(b64err) {
                                console.error("Base64 conversion failed", b64err);
                                imageUrls.push('https://images.unsplash.com/photo-1560518883-ce09059eeffa?q=80&w=500'); // Last resort
                            }
                        }
                    }
                    
                    const fd = new FormData(form);
                    // Extract dynamic attributes
                    const attributes = {};
                    for(let [key, val] of fd.entries()) {
                        if(key.startsWith('attr_')) attributes[key.replace('attr_', '')] = val;
                    }

                    const citySelect = document.getElementById('city-select');
                    const cityName = citySelect.options[citySelect.selectedIndex].text;
                    const plan = document.querySelector('input[name="plan"]:checked').value;

                    // FIX: Add listing_type to attributes because column doesn't exist in DB
                    if(plan) attributes['listing_type'] = plan;

                    const payload = {
                        user_id: state.user.id,
                        title: fd.get('title'),
                        price: fd.get('price'),
                        description: fd.get('description'),
                        category_id: fd.get('category'),
                        subcategory: fd.get('subcategory'),
                        location: cityName,
                        attributes: attributes,
                        // listing_type: plan <-- REMOVED CAUSING ERROR
                    };

                    if(imageUrls.length > 0) payload.image_urls = imageUrls;

                    let error;
                    if(app.sell.isEditing) {
                        const id = document.getElementById('edit-id').value;
                        const { error: upError } = await supabase.from('listings').update(payload).eq('id', id);
                        error = upError;
                    } else {
                        const { error: inError } = await supabase.from('listings').insert(payload);
                        error = inError;
                    }

                    if(error) return utils.toast(error.message, 'error');
                    
                    utils.toast(app.sell.isEditing ? 'Ad Updated!' : 'Ad Posted Successfully!', 'success');
                    app.modals.sell.hide();
                    form.reset();
                    app.sell.stagedFiles = [];
                    document.getElementById('preview-container').innerHTML = '';
                    app.router.navigate('profile');
                },
                delete: async (id) => {
                    if(!confirm('Delete this ad?')) return;
                    const { error } = await supabase.from('listings').delete().eq('id', id);
                    if(error) utils.toast(error.message, 'error');
                    else {
                        utils.toast('Deleted', 'success');
                        app.data.fetchUserListings();
                    }
                }
            },

            location: {
                populateCities: (s, tid) => {
                    const t = document.getElementById(tid);
                    t.innerHTML = '<option value="">Select City...</option>';
                    t.disabled = false;
                    const l = state.locations.find(x=>x.state===s);
                    l?.cities.forEach(c => { const o = document.createElement('option'); o.text = c; o.value = c; t.add(o); });
                }
            },

            chat: {
                subscription: null,
                init: async () => { if(state.user) app.chat.fetchConversations(); },
                fetchConversations: async () => {
                    const { data } = await supabase.from('chat_rooms').select('*, listings(title), buyer:buyer_id(full_name, avatar_url), seller:seller_id(full_name, avatar_url)').or(`buyer_id.eq.${state.user.id},seller_id.eq.${state.user.id}`);
                    if(data) document.getElementById('chat-list').innerHTML = data.map(r => {
                        const u = r.buyer_id === state.user.id ? r.seller : r.buyer;
                        return `<div onclick="app.chat.openRoom('${r.id}', '${u?.full_name}', '${u?.avatar_url}')" class="p-4 border-b hover:bg-gray-100 cursor-pointer flex items-center gap-3"><img src="${u?.avatar_url||'https://placehold.co/40'}" class="w-10 h-10 rounded-full object-cover"><div><div class="font-bold text-sm">${u?.full_name}</div><div class="text-xs text-gray-500 truncate w-32">${r.listings?.title||'Ad'}</div></div></div>`;
                    }).join('');
                },
                start: async (sid, lid, sname) => {
                    if(!state.user) return app.modals.auth.show();
                    if(sid === state.user.id) return utils.toast("Cannot chat with self", "error");
                    let { data: r } = await supabase.from('chat_rooms').select('id').eq('listing_id', lid).eq('buyer_id', state.user.id).eq('seller_id', sid).maybeSingle();
                    if(!r) { const { data } = await supabase.from('chat_rooms').insert({ listing_id: lid, buyer_id: state.user.id, seller_id: sid }).select().single(); r = data; }
                    app.chat.openRoom(r.id, sname);
                },
                openRoom: async (rid, name, img) => {
                    state.currentChatRoom = rid;
                    document.getElementById('chat-modal').classList.remove('hidden');
                    document.getElementById('chat-header-name').innerText = name;
                    document.getElementById('chat-header-img').src = img || 'https://placehold.co/40';
                    const c = document.getElementById('chat-messages');
                    c.innerHTML = '';
                    if(app.chat.subscription) supabase.removeChannel(app.chat.subscription);
                    const { data } = await supabase.from('chat_messages').select('*').eq('room_id', rid).order('created_at', {ascending: true});
                    data?.forEach(m => app.chat.renderMsg(m));
                    app.chat.subscription = supabase.channel(`room:${rid}`).on('postgres_changes', {event:'INSERT', schema:'public', table:'chat_messages', filter:`room_id=eq.${rid}`}, p => app.chat.renderMsg(p.new)).subscribe();
                },
                renderMsg: (m) => {
                    const me = m.sender_id === state.user.id;
                    const c = document.getElementById('chat-messages');
                    c.insertAdjacentHTML('beforeend', `<div class="flex ${me?'justify-end':'justify-start'}"><div class="${me?'bg-primary-600 text-white':'bg-gray-200 text-gray-800'} px-4 py-2 rounded-xl text-sm max-w-xs shadow-sm">${utils.sanitize(m.content)}</div></div>`);
                    c.scrollTop = c.scrollHeight;
                },
                send: async (e) => {
                    e.preventDefault();
                    const i = document.getElementById('chat-input');
                    const txt = i.value.trim();
                    if(!txt) return;
                    if(txt.match(/(\d{10}|@)/)) return utils.toast('Contact sharing prohibited. Use Unlock feature.', 'error');
                    await supabase.from('chat_messages').insert({ room_id: state.currentChatRoom, sender_id: state.user.id, content: txt });
                    i.value = '';
                }
            }
        };

        // Initialize App
        window.app = app;
        document.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
</html>
