<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace - Buy & Sell Locally</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa; /* Softer, off-white background */
        }
        .hero-section {
            background: linear-gradient(rgba(26, 32, 44, 0.7), rgba(26, 32, 44, 0.7)), url('https://images.unsplash.com/photo-1521791136064-7986c2920216?q=80&w=2069&auto=format&fit=crop') no-repeat center center;
            background-size: cover;
            position: relative;
            overflow: hidden;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #sellModal .modal-content::-webkit-scrollbar, #loginModal .modal-content::-webkit-scrollbar, #tncModal .modal-content::-webkit-scrollbar, #chat-messages::-webkit-scrollbar { width: 8px; }
        #sellModal .modal-content::-webkit-scrollbar-track, #loginModal .modal-content::-webkit-scrollbar-track, #tncModal .modal-content::-webkit-scrollbar-track, #chat-messages::-webkit-scrollbar-track { background: #f1f1f1; }
        #sellModal .modal-content::-webkit-scrollbar-thumb, #loginModal .modal-content::-webkit-scrollbar-thumb, #tncModal .modal-content::-webkit-scrollbar-thumb, #chat-messages::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        #sellModal .modal-content::-webkit-scrollbar-thumb:hover, #loginModal .modal-content::-webkit-scrollbar-thumb:hover, #tncModal .modal-content::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Dropdown CSS */
        .profile-dropdown, .category-dropdown, #notification-dropdown { display: none; }
        .profile-button:focus-within .profile-dropdown, .category-item:hover > .category-dropdown { display: block; }

        /* --- NEW Professional & Classy Theme Colors --- */
        .theme-primary { color: #1a202c; /* Deep Charcoal */ }
        .theme-accent { color: #b79438; /* Refined Gold */ }
        .bg-theme-primary { background-color: #1a202c; }
        .hover\:bg-theme-primary-dark:hover { background-color: #11151c; }
        .bg-theme-accent { background-color: #b79438; }
        .hover\:bg-theme-accent-dark:hover { background-color: #a08130; }
        .text-theme-accent { color: #b79438; }
        .hover\:text-theme-accent:hover { color: #a08130; }
        .focus\:ring-theme-accent:focus { --tw-ring-color: #b79438; }
        .border-theme-accent { border-color: #b79438; }
        
        .beer-cap {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            background-color: #1a202c; /* New Primary */
            color: #b79438; /* New Accent */
            border-radius: 50%;
            font-size: 1rem;
            box-shadow: 0 0 0 2px #f8f9fa, 0 0 0 3px #aaa, inset 0 1px 3px rgba(0,0,0,0.4);
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
            flex-shrink: 0;
        }
        .beer-cap:hover {
            transform: scale(1.1) rotate(5deg) !important;
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .accordion-icon { transform: rotate(180deg); }
        .notification-dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: red;
        }
        /* Toast Notification */
        #toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }
        #toast-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -10px);
        }
        .toast-success { background-color: #28a745; }
        .toast-error { background-color: #dc3545; }
        .toast-info { background-color: #17a2b8; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header Section (Logged-out state) -->
    <header id="header-logged-out" class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="#" onclick="showHomepage(event)" class="text-2xl font-bold theme-primary">Marketplace</a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#" onclick="showListingPage(event, 'cars')" class="text-gray-600 hover:text-theme-accent px-3 py-2 rounded-md text-sm font-medium">Cars</a>
                        <a href="#" onclick="showListingPage(event, 'mobiles')" class="text-gray-600 hover:text-theme-accent px-3 py-2 rounded-md text-sm font-medium">Mobiles</a>
                        <a href="#" onclick="showListingPage(event, 'electronics')" class="text-gray-600 hover:text-theme-accent px-3 py-2 rounded-md text-sm font-medium">Electronics</a>
                        <a href="#" onclick="showListingPage(event, 'property')" class="text-gray-600 hover:text-theme-accent px-3 py-2 rounded-md text-sm font-medium">Property</a>
                    </div>
                </div>
                <div class="flex items-center">
                    <a href="#" onclick="showLoginModal(event)" class="text-sm font-medium text-gray-700 hover:text-theme-accent mr-4">Login</a>
                    <button onclick="showSellModal()" class="flex items-center bg-theme-accent text-white px-4 py-2 rounded-full shadow-lg hover:bg-theme-accent-dark transition duration-300">
                        <i class="fas fa-plus-circle mr-2"></i>
                        SELL
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Header Section (Logged-in state) -->
    <header id="header-logged-in" class="bg-white shadow-md sticky top-0 z-50 hidden">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-8">
                    <a href="#" onclick="showHomepage(event)" class="text-2xl font-bold theme-primary">Marketplace</a>
                    <a href="#" onclick="showHomepage(event)" class="text-xl text-gray-500 hover:text-theme-accent" title="Home">
                        <i class="fas fa-home"></i>
                    </a>
                    <div class="hidden md:flex items-center border-2 rounded-full p-1 w-96">
                        <i class="fas fa-search text-gray-400 mx-3"></i>
                        <input type="text" placeholder="Search for cars, mobiles..." class="w-full bg-transparent focus:outline-none text-sm">
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                     <button onclick="openChatWindow('Recent Chat', 'AD-67890')" class="relative bg-white p-1 rounded-full text-gray-500 hover:text-gray-700">
                         <i class="fas fa-comment-dots text-xl"></i>
                         <span id="chat-notification-dot" class="hidden notification-dot"></span>
                     </button>
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="relative bg-white p-1 rounded-full text-gray-500 hover:text-gray-700">
                            <i class="far fa-bell text-xl"></i>
                            <span id="main-notification-dot" class="hidden notification-dot"></span>
                        </button>
                        <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg z-50 overflow-hidden">
                            <div class="p-4 font-bold border-b">Notifications</div>
                            <div class="divide-y">
                                <a href="#" class="block p-4 text-sm hover:bg-gray-50">
                                    <p class="font-semibold">Your ad is live!</p>
                                    <p class="text-gray-500">Your listing "Honda City 2021" is now visible to everyone.</p>
                                </a>
                                <a href="#" onclick="showMyAdsPage(event)" class="block p-4 text-sm hover:bg-gray-50">
                                    <p class="font-semibold">New Message</p>
                                    <p class="text-gray-500">You have a new message regarding your ad "iPhone 14".</p>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="relative profile-button">
                        <button class="flex items-center space-x-2">
                            <img id="header-profile-pic" class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/40x40/E2E8F0/4A5568?text=U" alt="User profile">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div class="profile-dropdown absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-50 overflow-hidden">
                            <div class="p-4">
                                <div class="flex items-center gap-3">
                                    <img id="dropdown-profile-pic" class="h-12 w-12 rounded-full object-cover" src="https://placehold.co/48x48/0A2342/D4AF37?text=U" alt="User profile">
                                    <div>
                                        <p id="dropdown-username" class="font-semibold text-gray-800">Unknown</p>
                                        <a href="#" onclick="showUserProfilePage(event)" class="text-sm text-theme-accent hover:underline">View and edit profile</a>
                                    </div>
                                </div>
                            </div>
                            <nav class="border-t border-gray-100">
                                <a href="#" onclick="showMyAdsPage(event)" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-ad w-5 text-center text-gray-500"></i> My ADS</a>
                                <a href="#" onclick="showPlaceholderPage(event)" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-briefcase w-5 text-center text-gray-500"></i> Premium Business Listing</a>
                                <a href="#" onclick="showPlaceholderPage(event)" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-shopping-cart w-5 text-center text-gray-500"></i> View Cart</a>
                                <a href="#" onclick="showPlaceholderPage(event)" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-file-invoice-dollar w-5 text-center text-gray-500"></i> Your Business Listing</a>
                            </nav>
                            <div class="border-t border-gray-100">
                                <a href="#" onclick="showHelpPage(event)" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-question-circle w-5 text-center text-gray-500"></i> Help</a>
                                <a href="#" onclick="logout(event)" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-50"><i class="fas fa-sign-out-alt w-5 text-center text-gray-500"></i> Logout</a>
                            </div>
                        </div>
                    </div>
                    <button onclick="showSellModal()" class="flex items-center bg-theme-accent text-white px-4 py-2 rounded-full shadow-lg hover:bg-theme-accent-dark transition duration-300"><i class="fas fa-plus-circle mr-2"></i>SELL</button>
                </div>
            </div>
        </nav>
    </header>

    <!-- PAGE 1: Homepage -->
    <div id="homepage">
        <section class="hero-section text-white py-20">
            <!-- Beer Cap Icons -->
            <div class="absolute top-4 left-4 flex space-x-3 z-20">
                <a href="#" onclick="showListingPage(event, 'cars')" class="beer-cap" style="transform: rotate(-15deg);"><i class="fas fa-car"></i></a>
                <a href="#" onclick="showListingPage(event, 'mobiles')" class="beer-cap" style="transform: rotate(10deg);"><i class="fas fa-mobile-alt"></i></a>
                <a href="#" onclick="showListingPage(event, 'property')" class="beer-cap" style="transform: rotate(8deg);"><i class="fas fa-building"></i></a>
                <a href="#" onclick="showListingPage(event, 'furniture')" class="beer-cap" style="transform: rotate(-12deg);"><i class="fas fa-couch"></i></a>
                <a href="#" onclick="showListingPage(event, 'bikes')" class="beer-cap" style="transform: rotate(15deg);"><i class="fas fa-motorcycle"></i></a>
                <a href="#" onclick="showListingPage(event, 'pets')" class="beer-cap" style="transform: rotate(-5deg);"><i class="fas fa-dog"></i></a>
            </div>
            
            <div class="container mx-auto px-4 text-center relative z-10">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-4">India's Marketplace</h1>
                <p class="text-lg md:text-xl mb-8">Find the best deals near you</p>
                <div class="max-w-4xl mx-auto bg-white rounded-full p-2 flex items-center shadow-2xl">
                    <div class="flex-grow flex items-center border-r-2 border-gray-200">
                        <i class="fas fa-map-marker-alt text-gray-400 mx-3"></i>
                        <input id="location-search" type="text" placeholder="Enter Pin Code or City" class="w-full bg-transparent text-gray-700 focus:outline-none">
                    </div>
                    <div class="flex-grow flex items-center ml-2">
                         <i class="fas fa-search text-gray-400 mx-3"></i>
                        <input id="keyword-search" type="text" placeholder="Search for cars, mobiles, and more..." class="w-full bg-transparent text-gray-700 focus:outline-none">
                    </div>
                    <button onclick="searchFromHome(event)" class="bg-theme-accent text-white rounded-full px-6 py-3 font-semibold hover:bg-theme-accent-dark transition duration-300">
                        Search
                    </button>
                </div>
            </div>
        </section>
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <section class="mb-12">
                <h2 class="text-2xl font-bold mb-6 text-center">Browse by Category</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                    <!-- Marketplace Goods -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 theme-primary">Marketplace</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <a href="#" onclick="showListingPage(event, 'mobiles')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-mobile-alt text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">Mobiles</span></a>
                            <a href="#" onclick="showListingPage(event, 'laptops')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-laptop text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">Laptops</span></a>
                            <a href="#" onclick="showListingPage(event, 'furniture')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-couch text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">Furniture</span></a>
                            <a href="#" onclick="showListingPage(event, 'fashion')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-tshirt text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">Fashion</span></a>
                            <a href="#" onclick="showListingPage(event, 'pets')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-dog text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">Pets</span></a>
                        </div>
                    </div>
                     <!-- Vehicles -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 theme-primary">Vehicles</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <a href="#" onclick="showListingPage(event, 'cars')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-car text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">Cars</span></a>
                             <a href="#" onclick="showListingPage(event, 'bikes')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-motorcycle text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">Bikes</span></a>
                            <a href="#" onclick="showListingPage(event, 'commercial_vehicles')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-truck text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">Commercial</span></a>
                        </div>
                    </div>
                     <!-- Real Estate -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 theme-primary">Real Estate</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <a href="#" onclick="showListingPage(event, 'property')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-building text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">For Sale</span></a>
                            <a href="#" onclick="showListingPage(event, 'property')" class="p-4 bg-white rounded-lg shadow hover:shadow-xl transition-shadow duration-300"><i class="fas fa-sign text-3xl text-theme-accent mb-2"></i><span class="block font-semibold text-sm">For Rent</span></a>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- PAGE 2: Product Listing Page -->
    <div id="listingpage" class="hidden">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row gap-8">
                <aside id="filter-sidebar" class="w-full md:w-1/3">
                    <!-- Dynamic Filters will be injected here by JavaScript -->
                </aside>
                <section class="w-full md:w-2/3">
                    <div class="flex items-center gap-4 mb-4">
                        <a href="#" onclick="goBack(event)" class="text-xl text-gray-500 hover:theme-primary" title="Back"><i class="fas fa-arrow-left"></i></a>
                        <h1 id="listing-page-title" class="text-2xl font-bold"></h1>
                    </div>
                    <div id="listing-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Dynamic Ads will be loaded here -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- PAGE 3: Help Center -->
    <div id="helppage" class="hidden">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="bg-white p-8 rounded-lg shadow-md max-w-4xl mx-auto">
                <div class="prose max-w-none">
                    <div class="flex items-center gap-4 mb-6">
                        <a href="#" onclick="goBack(event)" class="text-xl text-gray-500 hover:theme-primary" title="Back"><i class="fas fa-arrow-left"></i></a>
                        <h1 class="text-3xl font-bold">Help Center & Legal Information</h1>
                    </div>
                    <p class="mb-8">Welcome to the Marketplace Help Center. Here you can find our terms of use, privacy policies, and rules for posting on our platform.</p>
                    
                    <h2 class="text-2xl font-bold border-b pb-2 mb-4">1. Terms of Use</h2>
                    <p class="text-sm text-gray-500 mb-4"><strong>Last Updated:</strong> 25 Aug 2025</p>
                    <h3 class="text-xl font-semibold mt-4">Introduction</h3>
                    <p>Welcome to Marketplace! These are the terms and conditions governing your access to and use of the website Marketplace and its related sub-domains, sites, services, and tools. By using the Site, you hereby accept these terms and conditions and represent that you agree to comply with these terms and conditions. This User Agreement is deemed effective upon your use of the Site which signifies your acceptance of these terms.</p>
                    <h3 class="text-xl font-semibold mt-4">Eligibility for Membership</h3>
                    <p>Marketplace wishes to ensure that its members are able to form legally binding contracts and that minors do not purchase unsuitable content. Therefore, membership of the Site is not available to persons under the age of 18 years. You represent that you are 18 years of age or over the age of 18 years before you become a member of the Site.</p>
                    
                    <h2 class="text-2xl font-bold border-b pb-2 mb-4 mt-8">2. Privacy Policy</h2>
                    <p class="text-sm text-gray-500 mb-4"><strong>Last Updated:</strong> 25 Aug 2025</p>
                    <p>This Privacy Policy describes our policies on the collection, use, and disclosure of information about you in connection with your use of our services, including those offered through our websites, communications (e.g., emails, phone calls, and texts), and mobile applications.</p>
                    <h3 class="text-xl font-semibold mt-4">Information We Collect</h3>
                    <p>We may collect and store information about you when you use the Service. We use the information to fulfill your requests, provide the Service’s functionality, improve the Service’s quality, personalize your experience, track usage of the Service, provide feedback to third-party businesses that are listed on the Service, display relevant advertising, market the Service, provide customer support, message you, back up our systems, and comply with legal obligations.</p>
                    
                    <h2 class="text-2xl font-bold border-b pb-2 mb-4 mt-8">3. Prohibited Items Policy</h2>
                    <p>Marketplace users are responsible for ensuring their ads comply with all applicable laws. Our list of prohibited products and services below is not exhaustive and we reserve the right to update it at any time.</p>
                    <h3 class="text-xl font-semibold mt-4">Examples of Prohibited Items:</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Adult/Pornographic Material</li>
                        <li>Alcohol, Tobacco Products, Drugs</li>
                        <li>Counterfeit and Replica Items</li>
                        <li>Firearms, Ammunition, and Weapons</li>
                        <li>Hazardous Materials</li>
                        <li>Human Parts and Remains</li>
                        <li>Illegal Items & Services</li>
                        <li>Stolen Property</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- PAGE 4: Placeholder Page -->
    <div id="placeholderpage" class="hidden">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto text-center">
                 <div class="flex items-center justify-center gap-4 mb-6">
                    <a href="#" onclick="goBack(event)" class="text-xl text-gray-500 hover:theme-primary" title="Back"><i class="fas fa-arrow-left"></i></a>
                    <h1 class="text-3xl font-bold theme-primary">Coming Soon!</h1>
                </div>
                <p class="mt-4 text-lg text-gray-600">We are working hard on this feature and will be updating soon.</p>
            </div>
        </main>
    </div>

    <!-- PAGE 5: Coming Soon Page -->
    <div id="comingsoonpage" class="hidden">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto text-center">
                 <div class="flex items-center justify-center gap-4 mb-6">
                    <a href="#" onclick="goBack(event)" class="text-xl text-gray-500 hover:theme-primary" title="Back"><i class="fas fa-arrow-left"></i></a>
                    <h1 class="text-3xl font-bold text-red-600">We would be Live soon</h1>
                </div>
            </div>
        </main>
    </div>
    
    <!-- PAGE 6: Product Detail Page -->
    <div id="productdetailpage" class="hidden">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
             <div class="flex items-center gap-4 mb-4">
                <a href="#" onclick="goBack(event)" class="text-xl text-gray-500 hover:theme-primary" title="Back"><i class="fas fa-arrow-left"></i></a>
                <h1 class="text-2xl font-bold">Product Details</h1>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex flex-col md:flex-row gap-8">
                    <!-- Image Gallery -->
                    <div class="w-full md:w-2/3">
                        <img id="main-product-image" src="https://placehold.co/800x600/CBD5E0/4A5568?text=Honda+City" alt="Main Product Image" class="w-full h-auto rounded-lg shadow-lg">
                        <div class="flex space-x-2 mt-4">
                            <img src="https://placehold.co/100x75/CBD5E0/4A5568?text=Side" alt="Thumbnail" class="w-24 h-auto rounded-md cursor-pointer border-2 border-theme-accent">
                            <img src="https://placehold.co/100x75/CBD5E0/4A5568?text=Interior" alt="Thumbnail" class="w-24 h-auto rounded-md cursor-pointer">
                            <img src="https://placehold.co/100x75/CBD5E0/4A5568?text=Back" alt="Thumbnail" class="w-24 h-auto rounded-md cursor-pointer">
                        </div>
                    </div>
                    <!-- Ad Details -->
                    <div class="w-full md:w-1/3">
                        <div class="border-b pb-4 mb-4">
                            <h2 class="text-3xl font-bold mb-2">₹ 8,50,000</h2>
                            <p class="text-lg text-gray-600">Honda City 2021, Petrol, 25000 km</p>
                            <div class="flex justify-between text-sm text-gray-500 mt-2">
                                <span>Noida, UP</span>
                                <span>Posted Yesterday</span>
                            </div>
                        </div>
                        <div class="border-b pb-4 mb-4">
                             <h3 class="text-xl font-semibold mb-2">Seller Details</h3>
                             <div class="flex items-center gap-4">
                                <img class="h-16 w-16 rounded-full object-cover" src="https://placehold.co/64x64/0A2342/D4AF37?text=S" alt="Seller profile">
                                <div>
                                    <p class="font-bold text-lg">Seller Name</p>
                                    <p class="text-sm text-gray-500">Member since 2022</p>
                                </div>
                             </div>
                             <button onclick="openChatWindow('Seller Name', 'AD-12345')" class="w-full mt-4 bg-theme-primary text-white p-3 rounded-md font-semibold hover:bg-theme-primary-dark">
                                 <i class="fas fa-comments mr-2"></i>Chat with Seller
                             </button>
                        </div>
                         <button class="w-full border-2 border-gray-300 p-3 rounded-md flex items-center justify-center gap-2 hover:bg-gray-100">
                            <i class="far fa-heart text-red-500"></i>
                            <span class="font-semibold">Add to Favorites</span>
                         </button>
                    </div>
                </div>
                <div class="mt-8 border-t pt-6">
                    <h3 class="text-xl font-semibold mb-4">Details</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div><strong class="block">Brand</strong><span>Honda</span></div>
                        <div><strong class="block">Model</strong><span>City</span></div>
                        <div><strong class="block">Year</strong><span>2021</span></div>
                        <div><strong class="block">Fuel</strong><span>Petrol</span></div>
                        <div><strong class="block">KM Driven</strong><span>25,000</span></div>
                        <div><strong class="block">Transmission</strong><span>Automatic</span></div>
                    </div>
                </div>
                 <div class="mt-8 border-t pt-6">
                    <h3 class="text-xl font-semibold mb-4">Description</h3>
                    <p class="text-gray-700 leading-relaxed">
                        Well-maintained Honda City 2021 model available for sale. Single owner, driven only 25,000 kms. The car is in excellent condition with no history of accidents. All services done at authorized service centers. Features include automatic transmission, sunroof, and touch screen infotainment system.
                    </p>
                </div>
                <div class="mt-8 border-t pt-6">
                    <h3 class="text-xl font-semibold mb-4">Similar Ads</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Similar Ad 1 -->
                        <a href="#" class="block bg-white rounded-lg border border-gray-200 overflow-hidden product-card transition-all duration-300">
                            <img src="https://placehold.co/400x300/E2E8F0/4A5568?text=Hyundai+Verna" alt="Product" class="w-full h-40 object-cover">
                            <div class="p-3">
                                <h3 class="font-bold text-md mb-1">₹ 9,20,000</h3>
                                <p class="text-gray-600 text-xs">Hyundai Verna 2022</p>
                            </div>
                        </a>
                        <!-- Similar Ad 2 -->
                        <a href="#" class="block bg-white rounded-lg border border-gray-200 overflow-hidden product-card transition-all duration-300">
                            <img src="https://placehold.co/400x300/E2E8F0/4A5568?text=Maruti+Ciaz" alt="Product" class="w-full h-40 object-cover">
                            <div class="p-3">
                                <h3 class="font-bold text-md mb-1">₹ 8,90,000</h3>
                                <p class="text-gray-600 text-xs">Maruti Suzuki Ciaz 2021</p>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="mt-8 border-t pt-6">
                    <h3 class="text-xl font-semibold mb-4">Sponsored Links</h3>
                    <div class="p-4 border rounded-lg bg-gray-50 text-center">
                        <p class="text-gray-500">Advertisement</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- PAGE 7: My Ads Page -->
    <div id="myadspage" class="hidden">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex items-center gap-4 mb-6">
                <a href="#" onclick="goBack(event)" class="text-xl text-gray-500 hover:theme-primary" title="Back"><i class="fas fa-arrow-left"></i></a>
                <h1 class="text-3xl font-bold">My Ads</h1>
            </div>
            <div id="my-ads-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Ads will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <!-- PAGE 8: User Profile Page -->
    <div id="userprofilepage" class="hidden">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-1/4">
                    <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <img id="profile-page-pic" class="h-24 w-24 rounded-full object-cover mx-auto mb-4" src="https://placehold.co/96x96/0A2342/D4AF37?text=M" alt="User profile">
                        <h2 id="profile-page-username" class="text-2xl font-bold">Manas</h2>
                        <p id="profile-page-member-since" class="text-sm text-gray-500">Member since Sep 2014</p>
                        <div class="text-left text-sm mt-4">
                            <p class="font-semibold mb-2">User verified with:</p>
                            <div class="flex items-center gap-2 text-gray-600">
                                <i class="fas fa-check-circle text-green-500"></i>
                                <span>Phone</span>
                            </div>
                             <div class="flex items-center gap-2 text-gray-600">
                                <i class="fas fa-check-circle text-green-500"></i>
                                <span>Email</span>
                            </div>
                        </div>
                        <button onclick="showEditProfilePage(event)" class="w-full mt-6 bg-theme-primary text-white p-3 rounded-md font-semibold hover:bg-theme-primary-dark">Edit Profile</button>
                    </div>
                </div>
                <div class="w-full md:w-3/4">
                     <div class="bg-white p-8 rounded-lg shadow-md text-center">
                        <img src="https://placehold.co/300x200/F0F9FF/1a202c?text=Sell+Something" class="mx-auto mb-4">
                        <h3 class="text-2xl font-bold">You haven't listed anything yet</h3>
                        <p class="text-gray-500 mb-6">Let go of what you don't use anymore</p>
                        <button onclick="showSellModal()" class="bg-theme-accent text-white px-6 py-3 rounded-full font-semibold hover:bg-theme-accent-dark">Start selling</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- PAGE 9: Edit Profile Page -->
    <div id="editprofilepage" class="hidden">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md">
                <div class="flex items-center gap-4 mb-6 border-b pb-4">
                    <a href="#" onclick="goBack(event)" class="text-xl text-gray-500 hover:theme-primary" title="Back"><i class="fas fa-arrow-left"></i></a>
                    <h1 class="text-2xl font-bold">Edit Profile</h1>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Profile picture</h3>
                        <div class="flex items-center gap-4">
                             <img id="profile-pic-preview" class="h-24 w-24 rounded-full object-cover" src="https://placehold.co/96x96/0A2342/D4AF37?text=M" alt="User profile">
                             <input type="file" id="profile-pic-upload" class="hidden" accept="image/*" onchange="handleProfilePictureChange(event)">
                             <button onclick="document.getElementById('profile-pic-upload').click()" class="border border-gray-300 px-4 py-2 rounded-md text-sm font-semibold hover:bg-gray-50">Change Picture</button>
                        </div>
                        <div class="mt-8">
                            <h3 class="text-lg font-semibold mb-4">Basic information</h3>
                            <div class="space-y-4">
                                <input id="edit-profile-name-input" type="text" value="Manas" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent">
                                <textarea id="edit-profile-about-input" placeholder="About me (optional)" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent h-24"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Contact information</h3>
                             <div class="space-y-4">
                                <input id="edit-profile-email-input" type="email" value="user@example.com" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent bg-gray-100" readonly>
                                <input id="edit-profile-phone-input" type="tel" value="+919876543210" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent">
                            </div>
                        </div>
                         <div>
                            <h3 class="text-lg font-semibold mb-2">Additional information</h3>
                             <div class="flex items-center justify-between p-4 border rounded-lg">
                                <div class="flex items-center gap-3">
                                    <i class="fab fa-google text-red-500 text-2xl"></i>
                                    <div>
                                        <p class="font-semibold">Google</p>
                                        <p class="text-xs text-gray-500">Link your Google account to seamlessly use your contact list.</p>
                                    </div>
                                </div>
                                <button class="border-2 border-red-500 text-red-500 px-4 py-1 rounded-full text-sm font-semibold hover:bg-red-50">Unlink</button>
                             </div>
                        </div>
                    </div>
                </div>
                 <div class="flex justify-end gap-4 border-t pt-6 mt-8">
                    <button onclick="showUserProfilePage(event)" class="text-gray-600 font-semibold hover:text-theme-primary">Discard</button>
                    <button onclick="handleProfileUpdate(event)" class="bg-theme-primary text-white px-6 py-2 rounded-md font-semibold hover:bg-theme-primary-dark">Save changes</button>
                </div>
            </div>
        </main>
    </div>

    <!-- PAGE 10: Premium Listing Page -->
    <div id="premiumlistingpage" class="hidden">
        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex items-center gap-4 mb-6">
                <a href="#" onclick="goBack(event)" class="text-xl text-gray-500 hover:theme-primary" title="Back"><i class="fas fa-arrow-left"></i></a>
                <h1 class="text-3xl font-bold">Premium Listings</h1>
            </div>
            <div class="space-y-12">
                <!-- Featured Vehicles -->
                <section>
                    <h2 class="text-2xl font-bold mb-4">Featured Vehicles</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                         <a href="#" onclick="showProductDetailPage(event)" class="block bg-white rounded-lg border-2 border-theme-accent overflow-hidden product-card transition-all duration-300 relative">
                            <span class="absolute top-2 right-2 bg-theme-accent text-white text-xs font-bold px-2 py-1 rounded">Premium</span>
                            <img src="https://placehold.co/400x300/FEF3C7/4A5568?text=Jeep+Compass" alt="Product" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="font-bold text-lg mb-2">₹ 18,50,000</h3>
                                <p class="text-gray-600 text-sm">Jeep Compass 2022, Low KMs</p>
                            </div>
                        </a>
                    </div>
                </section>
                 <!-- Premium Properties -->
                <section>
                    <h2 class="text-xl font-bold mb-4">Premium Properties</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                         <a href="#" onclick="showProductDetailPage(event)" class="block bg-white rounded-lg border-2 border-theme-accent overflow-hidden product-card transition-all duration-300 relative">
                            <span class="absolute top-2 right-2 bg-theme-accent text-white text-xs font-bold px-2 py-1 rounded">Premium</span>
                            <img src="https://placehold.co/400x300/FEF3C7/4A5568?text=Luxury+Villa" alt="Product" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="font-bold text-lg mb-2">₹ 2,50,00,000</h3>
                                <p class="text-gray-600 text-sm">4 BHK Luxury Villa in South Delhi</p>
                            </div>
                        </a>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- PAGE 11: User Dashboard -->
    <div id="dashboardpage" class="hidden">
      <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
           <div class="flex items-center gap-4 mb-6">
              <a href="#" onclick="goBack(event)" class="text-xl text-gray-500 hover:theme-primary" title="Back"><i class="fas fa-arrow-left"></i></a>
              <h1 class="text-3xl font-bold">Premium Dashboard</h1>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md"><strong>Balance:</strong> ₹12,300</div>
            <div class="bg-white p-6 rounded-lg shadow-md"><strong>Last Login:</strong> 25 Aug 2025</div>
            <div class="bg-white p-6 rounded-lg shadow-md"><strong>Status:</strong> Premium Member</div>
          </div>
      </main>
    </div>

    <!-- Universal Footer -->
    <footer class="bg-gray-800 text-white mt-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                <div><h3 class="font-bold mb-4">Popular Categories</h3><ul><li class="mb-2"><a href="#" onclick="showListingPage(event, 'cars')" class="hover:text-theme-accent">Cars</a></li><li class="mb-2"><a href="#" onclick="showListingPage(event, 'mobiles')" class="hover:text-theme-accent">Mobiles</a></li></ul></div>
                <div><h3 class="font-bold mb-4">About Us</h3><ul><li class="mb-2"><a href="#" onclick="showComingSoonPage(event)" class="hover:text-theme-accent">About Marketplace</a></li><li class="mb-2"><a href="#" onclick="showComingSoonPage(event)" class="hover:text-theme-accent">Careers</a></li></ul></div>
                <div><h3 class="font-bold mb-4">Marketplace</h3><ul><li class="mb-2"><a href="#" onclick="showHelpPage(event)" class="hover:text-theme-accent">Help</a></li><li class="mb-2"><a href="#" onclick="showHelpPage(event)" class="hover:text-theme-accent">Legal & Privacy</a></li></ul></div>
                <div><h3 class="font-bold mb-4">Follow Us</h3><div class="flex space-x-4"><a href="#" onclick="showComingSoonPage(event)" class="text-2xl hover:text-theme-accent"><i class="fab fa-facebook-f"></i></a><a href="#" onclick="showComingSoonPage(event)" class="text-2xl hover:text-theme-accent"><i class="fab fa-twitter"></i></a><a href="#" onclick="showComingSoonPage(event)" class="text-2xl hover:text-theme-accent"><i class="fab fa-instagram"></i></a></div></div>
            </div>
            <div class="text-center text-gray-400 mt-8 pt-8 border-t border-gray-700">&copy; 2025 Marketplace. All rights reserved.</div>
        </div>
    </footer>

    <!-- Universal Sell Item Modal -->
    <div id="sellModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto border w-full max-w-3xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center p-4 border-b"><p class="text-2xl font-bold">Post Your Ad</p><div class="cursor-pointer z-50" onclick="hideSellModal()"><i class="fas fa-times text-xl"></i></div></div>
            <div class="p-6 modal-content" style="max-height: 85vh; overflow-y: auto;">
                <form id="adForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category*</label>
                        <select id="category-select" onchange="updateAttributeFields()" class="mt-1 block w-full input-style">
                            <option value="">Select a Category</option>
                        </select>
                    </div>
                    <div id="category-attributes" class="space-y-4 border-t pt-4 mt-4"></div>
                    <div class="border-t pt-6 mt-6 space-y-6">
                        <div>
                            <label class="label-style">Ad Title*</label>
                            <input type="text" id="ad-title" class="mt-1 block w-full input-style" required>
                        </div>
                        <div>
                            <label class="label-style">Description* (Min 50 words)</label>
                            <textarea rows="4" id="ad-description" placeholder="Include condition, features, and reason for selling" class="mt-1 block w-full input-style" required></textarea>
                        </div>
                        <div>
                            <label class="label-style">Set a Price (₹)*</label>
                            <input type="number" id="ad-price" placeholder="e.g., 15000" class="mt-1 block w-full input-style" required>
                        </div>
                        <div>
                            <label class="label-style">Upload Photos</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-theme-accent hover\:text-theme-accent">
                                            <span>Upload a file</span>
                                            <input id="file-upload" name="file-upload" type="file" class="sr-only" multiple accept="image/*">
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500">PNG, JPG up to 5MB</p>
                                </div>
                            </div>
                             <div id="image-preview-container" class="mt-4 flex flex-wrap gap-2"></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="terms-checkbox" type="checkbox" onchange="togglePostButton()" class="h-4 w-4 text-theme-accent rounded focus:ring-theme-accent">
                            <label for="terms-checkbox" class="text-xs text-gray-600">I have read all <a href="#" onclick="showTncModal(event)" class="underline text-theme-primary">T&C</a> AND I accepted the T&C*</label>
                        </div>
                    </div>
                    <div class="pt-6 border-t">
                        <button id="post-ad-button" type="submit" class="w-full bg-theme-accent text-white py-3 px-4 rounded-md font-semibold text-lg opacity-50 cursor-not-allowed" disabled>Post Now</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- T&C Modal -->
    <div id="tncModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center p-4 border-b">
                <p class="text-2xl font-bold">Terms of Use</p>
                <div class="cursor-pointer z-50" onclick="hideTncModal()">
                    <i class="fas fa-times text-xl"></i>
                </div>
            </div>
            <div class="p-6 modal-content prose prose-sm max-w-none" style="max-height: 70vh; overflow-y: auto;">
                 <p class="text-sm text-gray-500 mb-4"><strong>Last Updated:</strong> 25 Aug 2025</p>
                 <h3 class="text-xl font-semibold mt-4">Introduction</h3>
                 <p>Welcome to Marketplace! These are the terms and conditions governing your access to and use of the website Marketplace and its related sub-domains, sites, services, and tools. By using the Site, you hereby accept these terms and conditions and represent that you agree to comply with these terms and conditions. This User Agreement is deemed effective upon your use of the Site which signifies your acceptance of these terms.</p>
                 <h3 class="text-xl font-semibold mt-4">Eligibility for Membership</h3>
                 <p>Marketplace wishes to ensure that its members are able to form legally binding contracts and that minors do not purchase unsuitable content. Therefore, membership of the Site is not available to persons under the age of 18 years. You represent that you are 18 years of age or over the age of 18 years before you become a member of the Site.</p>
                 <h2 class="text-2xl font-bold border-b pb-2 mb-4 mt-8">2. Privacy Policy</h2>
                 <p class="text-sm text-gray-500 mb-4"><strong>Last Updated:</strong> 25 Aug 2025</p>
                 <p>This Privacy Policy describes our policies on the collection, use, and disclosure of information about you in connection with your use of our services, including those offered through our websites, communications (e.g., emails, phone calls, and texts), and mobile applications.</p>
                 <h3 class="text-xl font-semibold mt-4">Information We Collect</h3>
                 <p>We may collect and store information about you when you use the Service. We use the information to fulfill your requests, provide the Service’s functionality, improve the Service’s quality, personalize your experience, track usage of the Service, provide feedback to third-party businesses that are listed on the Service, display relevant advertising, market the Service, provide customer support, message you, back up our systems, and comply with legal obligations.</p>
                 <h2 class="text-2xl font-bold border-b pb-2 mb-4 mt-8">3. Prohibited Items Policy</h2>
                 <p>Marketplace users are responsible for ensuring their ads comply with all applicable laws. Our list of prohibited products and services below is not exhaustive and we reserve the right to update it at any time.</p>
                 <h3 class="text-xl font-semibold mt-4">Examples of Prohibited Items:</h3>
                 <ul class="list-disc list-inside space-y-1">
                    <li>Adult/Pornographic Material</li>
                    <li>Alcohol, Tobacco Products, Drugs</li>
                    <li>Counterfeit and Replica Items</li>
                    <li>Firearms, Ammunition, and Weapons</li>
                    <li>Hazardous Materials</li>
                    <li>Human Parts and Remains</li>
                    <li>Illegal Items & Services</li>
                    <li>Stolen Property</li>
                 </ul>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-4xl mx-auto rounded-lg overflow-hidden flex flex-col md:flex-row" style="max-height: 90vh;">
            <!-- Left Side -->
            <div class="w-full md:w-1/3 bg-theme-primary text-white p-8 space-y-8 hidden md:flex flex-col justify-center">
                <div class="flex items-center gap-4">
                    <i class="fas fa-truck-loading text-2xl text-theme-accent"></i>
                    <div>
                        <h3 class="font-bold">Manage your orders</h3>
                        <p class="text-sm text-gray-300">Track your orders, delivery and returns</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <i class="fas fa-comments-dollar text-2xl text-theme-accent"></i>
                    <div>
                        <h3 class="font-bold">Transact with buyers and sellers</h3>
                        <p class="text-sm text-gray-300">Check and respond to chats, replies, offers and more</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <i class="fas fa-bell text-2xl text-theme-accent"></i>
                    <div>
                        <h3 class="font-bold">Personalized notifications and alerts</h3>
                        <p class="text-sm text-gray-300">Get matching alerts for the products/services you are looking for</p>
                    </div>
                </div>
            </div>
            <!-- Right Side -->
            <div class="w-full md:w-2/3 bg-white p-8 flex flex-col justify-center relative overflow-y-auto">
                <button onclick="hideLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
                <div id="login-form" class="w-full max-w-sm mx-auto">
                    <div class="flex border-b mb-4">
                        <button id="login-tab" class="flex-1 py-2 font-semibold border-b-2 border-theme-accent" onclick="switchAuthForm('login')">Login</button>
                        <button id="register-tab" class="flex-1 py-2 text-gray-500" onclick="switchAuthForm('register')">Register</button>
                    </div>
                    <h2 class="text-2xl font-bold text-center mb-2">Login to Marketplace</h2>
                    <p class="text-center text-gray-500 mb-6">Please provide your Email and Password</p>
                    <input id="login-email" type="email" placeholder="Enter Email" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent">
                    <input id="login-password" type="password" placeholder="Enter Password" class="w-full border-2 border-gray-300 p-3 rounded-md mt-4 focus:outline-none focus:border-theme-accent">
                    <div class="text-right mt-2">
                        <a href="#" onclick="switchAuthForm('forgot')" class="text-sm text-theme-accent hover:underline">Forgot Password?</a>
                    </div>
                    <button onclick="handleLogin(event)" class="w-full bg-theme-primary text-white p-3 rounded-md mt-4 font-semibold hover:bg-theme-primary-dark">Continue</button>
                    <div class="my-6 flex items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    <button onclick="loginWithGoogle(event)" class="w-full border-2 border-gray-300 p-3 rounded-md flex items-center justify-center gap-2 hover:bg-gray-50">
                        <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5">
                        <span class="font-semibold">Login with Google</span>
                    </button>
                     <p class="text-center mt-4 text-sm">Don't have an account? <a href="#" onclick="switchAuthForm('register')" class="font-semibold text-theme-accent">Register</a></p>
                </div>
                <div id="register-form" class="w-full max-w-sm mx-auto hidden">
                     <div class="flex border-b mb-4">
                        <button id="login-tab-reg" class="flex-1 py-2 text-gray-500" onclick="switchAuthForm('login')">Login</button>
                        <button id="register-tab-reg" class="flex-1 py-2 font-semibold border-b-2 border-theme-accent" onclick="switchAuthForm('register')">Register</button>
                    </div>
                    <h2 class="text-2xl font-bold text-center mb-6">Register on Marketplace</h2>
                    <div class="space-y-4">
                        <input id="register-first-name" type="text" placeholder="First Name" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent">
                        <input id="register-last-name" type="text" placeholder="Last Name" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent">
                        <input id="register-email" type="email" placeholder="Email" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent">
                        <input id="register-mobile" type="tel" placeholder="10-digit Mobile Number" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent">
                        <input id="register-password" type="password" placeholder="Password" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent">
                        <button onclick="handleRegister(event)" class="w-full bg-theme-primary text-white p-3 rounded-md mt-4 font-semibold hover:bg-theme-primary-dark">Register</button>
                    </div>
                    <p class="text-center mt-4 text-sm">Already have an account? <a href="#" onclick="switchAuthForm('login')" class="font-semibold text-theme-accent">Login</a></p>
                </div>
                <div id="forgot-password-form" class="w-full max-w-sm mx-auto hidden">
                    <div class="flex border-b mb-4">
                       <button class="flex-1 py-2 text-gray-500" onclick="switchAuthForm('login')">Login</button>
                       <button class="flex-1 py-2 text-gray-500" onclick="switchAuthForm('register')">Register</button>
                   </div>
                   <h2 class="text-2xl font-bold text-center mb-2">Reset Password</h2>
                   <p class="text-center text-gray-500 mb-6">Enter your email to receive a password reset link.</p>
                   <input id="reset-email" type="email" placeholder="Enter your registered Email" class="w-full border-2 border-gray-300 p-3 rounded-md focus:outline-none focus:border-theme-accent">
                   <button onclick="handlePasswordReset(event)" class="w-full bg-theme-primary text-white p-3 rounded-md mt-4 font-semibold hover:bg-theme-primary-dark">Send Reset Link</button>
                    <p class="text-center mt-4 text-sm"><a href="#" onclick="switchAuthForm('login')" class="font-semibold text-theme-accent">Back to Login</a></p>
               </div>
            </div>
        </div>
    </div>

    <!-- Chat Window -->
    <div id="chat-window" class="hidden fixed bottom-0 right-4 w-80 bg-white rounded-t-lg shadow-2xl z-50">
        <div class="flex justify-between items-center bg-theme-primary text-white p-2 rounded-t-lg">
            <div>
                <p id="chat-seller-name" class="font-bold text-sm"></p>
                <p id="chat-ad-id" class="text-xs"></p>
            </div>
            <div>
                <button id="mute-btn" onclick="toggleMute()" class="mr-2 hover:text-theme-accent"><i class="fas fa-volume-up"></i></button>
                <button onclick="closeChatWindow()" class="hover:text-red-400"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="chat-messages" class="h-64 p-4 overflow-y-auto space-y-4">
            <!-- Messages will be injected here -->
        </div>
        <div class="p-2 border-t">
            <form id="chat-form" class="flex items-center">
                <input id="chat-input" type="text" placeholder="Type a message..." class="w-full border rounded-full py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-theme-accent">
                <button type="submit" class="ml-2 bg-theme-accent text-white rounded-full h-8 w-8 flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

     <!-- Ad Submission Success Modal -->
    <div id="adSuccessModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-md bg-white text-center">
            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
            <h3 class="text-2xl font-bold mb-2">Ad Submitted!</h3>
            <p class="text-gray-600 mb-6">Your ad is under processing and will be live soon.</p>
            <div class="space-y-4">
                <button onclick="showPremiumListingPage(event); hideAdSuccessModal();" class="w-full bg-theme-accent text-white p-3 rounded-md font-semibold hover:bg-theme-accent-dark">For Paid Listing Click here</button>
                <button onclick="hideAdSuccessModal()" class="w-full bg-gray-200 text-gray-700 p-2 rounded-md font-semibold hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Element -->
    <div id="toast-notification"></div>

    <script type="module">
        // Import Firebase modules for AUTHENTICATION ONLY
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            updateProfile,
            signInAnonymously,
            signInWithCustomToken,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // --- Supabase Configuration for DATABASE ---
        const SUPABASE_URL = 'https://ynyqwmbeglqwtvwqpaeg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlueXF3bWJlZ2xxd3R2d3FwYWVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MzAxODcsImV4cCI6MjA3MTUwNjE4N30.IsLuwykC4Qtl4gXsFrygN5Ko1o4VZ4oLS6EDd8QGWoI';
        let supabase = null;
        if(window.supabase) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            console.error("Supabase client library not loaded.");
        }

        // --- Cloudinary Configuration for STORAGE ---
        const CLOUDINARY_CLOUD_NAME = 'dcxhenppn';
        const CLOUDINARY_UPLOAD_PRESET = 'marketplace_preset';

        // --- Page Navigation & State Management ---
        window.navigationHistory = [];
        let postLoginAction = null;

        const pageDivs = {
            homepage: document.getElementById('homepage'),
            listingpage: document.getElementById('listingpage'),
            helppage: document.getElementById('helppage'),
            placeholderpage: document.getElementById('placeholderpage'),
            productdetailpage: document.getElementById('productdetailpage'),
            comingsoonpage: document.getElementById('comingsoonpage'),
            myadspage: document.getElementById('myadspage'),
            userprofilepage: document.getElementById('userprofilepage'),
            editprofilepage: document.getElementById('editprofilepage'),
            premiumlistingpage: document.getElementById('premiumlistingpage'),
            dashboardpage: document.getElementById('dashboardpage'),
        };
        const headers = {
            loggedOut: document.getElementById('header-logged-out'),
            loggedIn: document.getElementById('header-logged-in')
        };

        // --- Toast Notification ---
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast-${type} show`;
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }
        window.showToast = showToast;


        // --- Page Navigation Logic ---
        function showPage(pageName, isLoggedIn, isBack = false) {
            let currentPage = '';
            for (const [name, div] of Object.entries(pageDivs)) {
                if (div && !div.classList.contains('hidden')) {
                    currentPage = name;
                    break;
                }
            }

            if (!isBack && currentPage && currentPage !== pageName) {
                window.navigationHistory.push(currentPage);
            }
            
            Object.values(pageDivs).forEach(div => { if(div) div.classList.add('hidden'); });
            if (pageDivs[pageName]) pageDivs[pageName].classList.remove('hidden');

            headers.loggedOut.classList.toggle('hidden', isLoggedIn);
            headers.loggedIn.classList.toggle('hidden', !isLoggedIn);
            window.scrollTo(0, 0);
        }
        window.showPage = showPage;
        
        function goBack(event) {
            if (event) event.preventDefault();
            if (window.navigationHistory.length > 0) {
                const previousPage = window.navigationHistory.pop();
                const isLoggedIn = !headers.loggedIn.classList.contains('hidden');
                showPage(previousPage, isLoggedIn, true);
            } else {
                showHomepage(event);
            }
        }
        window.goBack = goBack;

        function showHomepage(event) { if(event) event.preventDefault(); window.navigationHistory = []; showPage('homepage', !!auth.currentUser); }
        window.showHomepage = showHomepage;
        
        async function showListingPage(event, categoryKey) { 
            if(event) event.preventDefault(); 
            showPage('listingpage', !!auth.currentUser); 
            updateListingPage(categoryKey); 
            await fetchAndDisplayListings(categoryKey);
        }
        window.showListingPage = showListingPage;

        function showHelpPage(event) { if(event) event.preventDefault(); showPage('helppage', !!auth.currentUser); }
        window.showHelpPage = showHelpPage;
        
        function showPlaceholderPage(event) { if(event) event.preventDefault(); showPage('placeholderpage', true); }
        window.showPlaceholderPage = showPlaceholderPage;
        
        function showProductDetailPage(event) { 
            if (event) event.preventDefault();
            if (auth.currentUser) {
                 showPage('productdetailpage', true); 
            } else {
                postLoginAction = 'viewProduct';
                showLoginModal(event);
            }
        }
        window.showProductDetailPage = showProductDetailPage;
        
        function showComingSoonPage(event) { if(event) event.preventDefault(); showPage('comingsoonpage', !!auth.currentUser); }
        window.showComingSoonPage = showComingSoonPage;
        
        async function showMyAdsPage(event) {
            if(event) event.preventDefault();
            showPage('myadspage', true);
            await fetchAndDisplayMyAds(); // Fetch data after showing the page
        }
        window.showMyAdsPage = showMyAdsPage;

        function showUserProfilePage(event) { if(event) event.preventDefault(); showPage('userprofilepage', true); }
        window.showUserProfilePage = showUserProfilePage;
        
        function showEditProfilePage(event) { if(event) event.preventDefault(); showPage('editprofilepage', true); }
        window.showEditProfilePage = showEditProfilePage;
        
        function showPremiumListingPage(event) { if(event) event.preventDefault(); showPage('premiumlistingpage', !!auth.currentUser); }
        window.showPremiumListingPage = showPremiumListingPage;
        
        function showDashboardPage(event) { if(event) event.preventDefault(); showPage('dashboardpage', true); }
        window.showDashboardPage = showDashboardPage;
        
        function searchFromHome(event) {
            if (event) event.preventDefault();
            const locationValue = document.getElementById('location-search').value;
            showListingPage(event, 'cars'); // Default to cars for search
            document.getElementById('location-filter').value = locationValue;
            showToast(`Searching for items near "${locationValue}"`, 'info');
        }
        window.searchFromHome = searchFromHome;

        // --- Modal Control ---
        function showSellModal(event) { 
            if(event) event.preventDefault();
            if (auth.currentUser) {
                document.getElementById('sellModal').classList.remove('hidden'); 
            } else {
                postLoginAction = 'sellItem';
                showLoginModal(event);
            }
        }
        window.showSellModal = showSellModal;

        function hideSellModal() { 
            document.getElementById('sellModal').classList.add('hidden'); 
            editingAdId = null;
            document.getElementById('adForm').reset();
            document.getElementById('image-preview-container').innerHTML = '';
            document.querySelector('#sellModal .text-2xl').textContent = 'Post Your Ad';
            document.getElementById('post-ad-button').textContent = 'Post Now';
        }
        window.hideSellModal = hideSellModal;

        function showLoginModal(event) { if(event) event.preventDefault(); document.getElementById('loginModal').classList.remove('hidden'); }
        window.showLoginModal = showLoginModal;
        
        function hideLoginModal() { document.getElementById('loginModal').classList.add('hidden'); }
        window.hideLoginModal = hideLoginModal;

        function showTncModal(event) { if(event) event.preventDefault(); document.getElementById('tncModal').classList.remove('hidden'); }
        window.showTncModal = showTncModal;

        function hideTncModal() { document.getElementById('tncModal').classList.add('hidden'); }
        window.hideTncModal = hideTncModal;

        function showPostSuccessModal() { document.getElementById('adSuccessModal').classList.remove('hidden'); }
        window.showPostSuccessModal = showPostSuccessModal;

        function hideAdSuccessModal() { document.getElementById('adSuccessModal').classList.add('hidden'); }
        window.hideAdSuccessModal = hideAdSuccessModal;

        document.getElementById('adForm').addEventListener('submit', handleAdSubmit);
        
        function showReraInfo() { showToast('RERA is a unique ID for real estate projects, ensuring transparency.', 'info'); }
        window.showReraInfo = showReraInfo;

        // --- Dynamic Form Logic ---
        const categoriesData = [
            { id: 'cars', name: 'Cars' },
            { id: 'property', name: 'Property' },
            { id: 'mobiles', name: 'Mobiles' },
            { id: 'bikes', name: 'Bikes' },
            { id: 'electronics', name: 'Electronics & Appliances' },
            { id: 'commercial_vehicles', name: 'Commercial Vehicles' },
            { id: 'furniture', name: 'Furniture' },
            { id: 'fashion', name: 'Fashion' },
            { id: 'pets', name: 'Pets' },
            { id: 'services', name: 'Services' },
        ];

        function generateYearOptions(start, end) {
            let options = '<option value="">Select Year</option>';
            for (let year = end; year >= start; year--) {
                options += `<option value="${year}">${year}</option>`;
            }
            return options;
        }
        const yearDropdown = generateYearOptions(1990, 2025);

        const attributeTemplates = {
            cars: `<h3 class="text-xl font-bold text-gray-900 mb-4">Car Details</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="label-style">Brand*</label><select class="input-style w-full"><option>Maruti Suzuki</option><option>Hyundai</option><option>Tata</option><option>Mahindra</option><option>Kia</option><option>Toyota</option><option>Honda</option><option>Volkswagen</option><option>Skoda</option><option>MG</option><option>Renault</option><option>Nissan</option><option>Jeep</option><option>Citroen</option><option>Isuzu</option><option>Mercedes-Benz</option><option>BMW</option><option>Audi</option><option>Jaguar</option><option>Land Rover</option><option>Volvo</option><option>Other</option></select></div><div><label class="label-style">Model*</label><input type="text" placeholder="e.g., Swift, Creta, Nexon" class="input-style w-full"></div><div><label class="label-style">Variant*</label><input type="text" placeholder="e.g., VXI, SX, XZ+" class="input-style w-full"></div><div><label class="label-style">Year*</label><select class="input-style w-full">${yearDropdown}</select></div><div><label class="label-style">Fuel*</label><select class="input-style w-full"><option>Petrol</option><option>Diesel</option><option>CNG & Hybrids</option><option>Electric</option><option>LPG</option></select></div><div><label class="label-style">Transmission*</label><select class="input-style w-full"><option>Manual</option><option>Automatic</option></select></div><div><label class="label-style">KM Driven*</label><input type="number" placeholder="e.g., 25000" class="input-style w-full"></div><div><label class="label-style">No. of Owners*</label><select class="input-style w-full"><option>1st</option><option>2nd</option><option>3rd</option><option>4th+</option></select></div></div><div><label class="label-style">Condition</label><div class="flex space-x-4 mt-1"><label class="flex items-center"><input type="radio" name="condition" class="mr-2 h-4 w-4"> Non-Accidental</label><label class="flex items-center"><input type="radio" name="condition" class="mr-2 h-4 w-4"> Accidental</label></div></div>`,
            property: `<h3 class="text-xl font-bold text-gray-900 mb-4">Property Details</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="label-style">Type*</label><select class="input-style w-full" onchange="handlePropertyTypeChange(this)"><option>Apartment</option><option>Builder Floor</option><option>House & Villa</option><option>Plot</option><option>Land</option></select></div><div id="land-subcategory-container" class="hidden"><label class="label-style">Land Sub Category*</label><select class="input-style w-full"><option>Agriculture</option><option>Residential</option><option>Commercial</option><option>Industrial</option></select></div><div><label class="label-style">Bedrooms*</label><select class="input-style w-full"><option>1</option><option>2</option><option>3</option><option>4+</option></select></div><div><label class="label-style">Bathrooms*</label><select class="input-style w-full"><option>1</option><option>2</option><option>3+</option></select></div><div><label class="label-style">Furnishing*</label><select class="input-style w-full"><option>Furnished</option><option>Semi-Furnished</option><option>Unfurnished</option></select></div><div><label class="label-style">Listed By*</label><select class="input-style w-full"><option>Owner</option><option>Dealer</option><option>Builder</option></select></div><div><label class="label-style">Super Builtup area (ft²)*</label><input type="number" class="input-style w-full"></div><div><label class="label-style">Carpet Area (ft²)*</label><input type="number" class="input-style w-full"></div><div><label class="label-style">Maintenance (Monthly)</label><input type="number" class="input-style w-full"></div><div><label class="label-style">Total Floors</label><input type="number" class="input-style w-full"></div><div><label class="label-style">Floor No</label><input type="number" class="input-style w-full"></div><div><label class="label-style">Car Parking</label><select class="input-style w-full"><option>0</option><option>1</option><option>2+</option></select></div><div><label class="label-style">Facing</label><select class="input-style w-full"><option>North</option><option>South</option><option>East</option><option>West</option><option>North-East</option></select></div></div><div class="mt-4"><label class="label-style">RERA No. (Optional)</label><div class="flex items-center"><input type="text" placeholder="Enter RERA registration number" class="input-style w-full"><i onclick="showReraInfo()" class="fas fa-info-circle text-gray-500 ml-2 cursor-pointer" title="What is RERA?"></i></div></div>`,
            mobiles: `<h3 class="text-xl font-bold text-gray-900 mb-4">Mobile Details</h3><div><label class="label-style">Brand*</label><select class="input-style w-full"><option>Apple</option><option>Samsung</option><option>Xiaomi</option><option>OnePlus</option><option>Realme</option><option>Vivo</option><option>Oppo</option><option>Other</option></select></div>`,
            bikes: `<h3 class="text-xl font-bold text-gray-900 mb-4">Bike Details</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="label-style">Brand*</label><select class="input-style w-full"><option>Ather Energy</option><option>Bajaj</option><option>Benelli</option><option>BMW</option><option>Ducati</option><option>Harley-Davidson</option><option>Hero</option><option>Honda</option><option>Husqvarna</option><option>Indian</option><option>Jawa</option><option>Kawasaki</option><option>KTM</option><option>Ola Electric</option><option>Revolt</option><option>Royal Enfield</option><option>Suzuki</option><option>Triumph</option><option>TVS</option><option>Yamaha</option><option>Yezdi</option><option>Other</option></select></div><div><label class="label-style">Model*</label><input type="text" placeholder="e.g., Pulsar, Splendor, Classic 350, 450X" class="input-style w-full"></div><div><label class="label-style">Year*</label><select class="input-style w-full">${yearDropdown}</select></div><div><label class="label-style">KM Driven*</label><input type="number" class="input-style w-full"></div></div>`,
            electronics: `<h3 class="text-xl font-bold text-gray-900 mb-4">Electronics & Appliances</h3><div class="space-y-4"><div id="electronics-subtype-container"><label class="label-style">Type*</label><select id="electronics-subtype" class="input-style w-full"><option>TVs, Video - Audio</option><option>Kitchen & Other Appliances</option><option>Computers & Laptops</option><option>Cameras & Lenses</option><option>Games & Entertainment</option><option>Fridges</option><option>Washing Machines</option></select></div></div>`,
            commercial_vehicles: `<h3 class="text-xl font-bold text-gray-900 mb-4">Commercial Vehicle Details</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="label-style">Type*</label><select class="input-style w-full"><option>Trucks</option><option>Buses</option><option>Vans</option><option>Taxis</option><option>Other</option></select></div><div><label class="label-style">Year*</label><select class="input-style w-full">${yearDropdown}</select></div></div>`,
            furniture: `<h3 class="text-xl font-bold text-gray-900 mb-4">Furniture Details</h3><div><label class="label-style">Type*</label><select class="input-style w-full"><option>Sofa & Dining</option><option>Beds & Wardrobes</option><option>Home Decor & Garden</option><option>Kids Furniture</option><option>Other Household Items</option></select></div>`,
            fashion: `<h3 class="text-xl font-bold text-gray-900 mb-4">Fashion Details</h3><div><label class="label-style">Type*</label><select class="input-style w-full"><option>Men</option><option>Women</option><option>Kids</option></select></div>`,
            pets: `<h3 class="text-xl font-bold text-gray-900 mb-4">Pet Details</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="label-style">Type*</label><select class="input-style w-full"><option>Dogs</option><option>Cats</option><option>Fishes</option><option>Birds</option><option>Other Pets</option></select></div><div><label class="label-style">Breed</label><input type="text" placeholder="e.g., Labrador, Persian" class="input-style w-full"></div></div>`,
            services: `<h3 class="text-xl font-bold text-gray-900 mb-4">Service Details</h3><div><label class="label-style">Type*</label><input type="text" placeholder="e.g., Electronics & Computer Repair, Education & Classes" class="input-style w-full"></div>`
        };
        const style = document.createElement('style');
        style.innerHTML = `.input-style { padding: 0.5rem 0.75rem; background-color: white; border: 1px solid #D1D5DB; border-radius: 0.375rem; } .input-style:focus { outline: none; ring: 2px; ring-offset: 2px; ring-color: #D4AF37; border-color: #D4AF37; } .label-style { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }`;
        document.head.appendChild(style);
        
        function updateAttributeFields() {
            const category = document.getElementById('category-select').value;
            const container = document.getElementById('category-attributes');
            container.innerHTML = (category && attributeTemplates[category]) ? attributeTemplates[category] : '<p class="text-gray-500 text-center py-4">Please select a category to see relevant options.</p>';
        }
        window.updateAttributeFields = updateAttributeFields;

        function handlePropertyTypeChange(selectElement) {
            const landSubCategoryContainer = document.getElementById('land-subcategory-container');
            if (selectElement.value === 'Land') {
                landSubCategoryContainer.classList.remove('hidden');
            } else {
                landSubCategoryContainer.classList.add('hidden');
            }
        }
        window.handlePropertyTypeChange = handlePropertyTypeChange;

        const originalShowModal = showSellModal;
        window.showSellModal = function() { 
            document.getElementById('category-select').value = ''; 
            updateAttributeFields(); 
            originalShowModal(); 
        }

        // --- Filter Data and Logic ---
        const filterData = {
            cars: [
                { title: 'Budget', type: 'range' },
                { title: 'Brand', type: 'checkbox', options: ['Maruti Suzuki', 'Hyundai', 'Honda', 'Tata', 'Mahindra', 'Toyota', 'Ford', 'Renault', 'Volkswagen', 'BMW', 'Mercedes-Benz', 'Audi'] },
                { title: 'Model Year', type: 'range' },
                { title: 'KMs Driven', type: 'range' },
                { title: 'Fuel Type', type: 'checkbox', options: ['Petrol', 'Diesel', 'CNG', 'LPG', 'Electric', 'Hybrid'] },
                { title: 'Transmission', type: 'radio', name: 'transmission', options: ['Manual', 'Automatic'] },
                { title: 'No. of Owners', type: 'checkbox', options: ['1st', '2nd', '3rd', '4th+'] },
                { title: 'Posted By', type: 'checkbox', options: ['Individual', 'Dealer'] }
            ],
            property: [
                { title: 'Budget', type: 'range' },
                { title: 'Property Type', type: 'checkbox', options: ['Apartment', 'Builder Floor', 'House & Villa', 'Plot', 'Commercial Office', 'Shop/Showroom'] },
                { title: 'Bedrooms (BHK)', type: 'checkbox', options: ['1 BHK', '2 BHK', '3 BHK', '4 BHK', '4+ BHK'] },
                { title: 'Furnishing', type: 'radio', name: 'furnishing', options: ['Furnished', 'Semi-Furnished', 'Unfurnished'] },
                { title: 'Construction Status', type: 'radio', name: 'construction', options: ['Ready to Move', 'Under Construction'] },
                { title: 'Listed By', type: 'checkbox', options: ['Owner', 'Dealer', 'Builder'] },
                { title: 'Area (Sq. Ft.)', type: 'range' }
            ],
            mobiles: [
                { title: 'Price', type: 'range' },
                { title: 'Brand', type: 'checkbox', options: ['Apple', 'Samsung', 'Xiaomi', 'OnePlus', 'Realme', 'Vivo', 'Oppo'] },
                { title: 'RAM', type: 'checkbox', options: ['4 GB', '6 GB', '8 GB', '12 GB+'] },
                { title: 'Operating System', type: 'radio', name: 'os', options: ['Android', 'iOS'] }
            ],
            furniture: [
                { title: 'Price', type: 'range' },
                { title: 'Furniture Type', type: 'checkbox', options: ['Sofa Sets', 'Bed Sets', 'Dining Tables', 'Office Chairs', 'Wardrobes', 'TV Units'] },
                { title: 'Material', type: 'checkbox', options: ['Solid Wood (Teak)', 'Solid Wood (Sheesham)', 'Engineered Wood', 'Metal', 'Plastic'] },
                { title: 'Condition', type: 'radio', name: 'condition', options: ['Brand New', 'Gently Used', 'Heavily Used'] }
            ],
            pets: [
                { title: 'Animal Type', type: 'select', options: ['Dogs', 'Cats', 'Birds', 'Fish & Aquariums'] },
                { title: 'Breed', type: 'text', placeholder: 'e.g., Labrador, Persian Cat' },
                { title: 'Age', type: 'range' },
                { title: 'Posted By', type: 'radio', name: 'pet_poster', options: ['Owner', 'Breeder'] }
            ],
            default: [
                { title: 'Price', type: 'range' }
            ]
        };

        function createFilterSection(filter) {
            let optionsHTML = '';
            if (filter.type === 'range') {
                optionsHTML = `<div class="mt-2 flex items-center space-x-2"><input type="number" placeholder="Min" class="w-full border rounded-md p-2 text-sm"><span>to</span><input type="number" placeholder="Max" class="w-full border rounded-md p-2 text-sm"></div>`;
            } else if (filter.type === 'checkbox') {
                optionsHTML = `<div class="mt-2 space-y-2 text-xs">` +
                    filter.options.map(opt => `<label class="flex items-center font-normal"><input type="checkbox" class="h-4 w-4 text-theme-accent border-gray-300 rounded focus:ring-theme-accent"> <span class="ml-2">${opt}</span></label>`).join('') +
                    `</div>`;
            } else if (filter.type === 'radio') {
                 optionsHTML = `<div class="mt-2 space-y-2 text-xs">` +
                    filter.options.map(opt => `<label class="flex items-center font-normal"><input type="radio" name="${filter.name}" class="h-4 w-4 text-theme-accent border-gray-300 focus:ring-theme-accent"> <span class="ml-2">${opt}</span></label>`).join('') +
                    `</div>`;
            } else if (filter.type === 'select') {
                optionsHTML = `<div class="mt-2"><select class="input-style w-full text-sm">` +
                    filter.options.map(opt => `<option>${opt}</option>`).join('') +
                    `</select></div>`;
            } else if (filter.type === 'text') {
                 optionsHTML = `<div class="mt-2"><input type="text" placeholder="${filter.placeholder}" class="input-style w-full text-sm"></div>`;
            }

            return `
                <div class="border-t py-3">
                    <details open>
                        <summary class="font-semibold text-sm cursor-pointer flex justify-between items-center hover:text-theme-accent">
                            <span>${filter.title}</span>
                            <i class="fas fa-chevron-down accordion-icon transition-transform text-xs"></i>
                        </summary>
                        ${optionsHTML}
                    </details>
                </div>
            `;
        }

        function updateListingPage(categoryKey) {
            const sidebar = document.getElementById('filter-sidebar');
            const title = document.getElementById('listing-page-title');
            const filters = filterData[categoryKey] || filterData.default;

            let sidebarHTML = `
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Filters</h2>
                    <div class="mb-4">
                        <h3 class="font-semibold mb-2 text-sm">Location</h3>
                        <div class="relative">
                            <input id="location-filter" type="text" class="w-full border rounded-md p-2 text-sm pr-8">
                            <i class="fas fa-map-marker-alt absolute top-1/2 right-3 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    ${filters.map(createFilterSection).join('')}
                    <div class="border-t pt-4 mt-4 space-y-2">
                         <button onclick="console.log('Filters Applied!')" class="w-full bg-theme-primary text-white p-2 rounded-md font-semibold hover:bg-theme-primary-dark text-sm">Apply Filters</button>
                         <button onclick="updateListingPage('${categoryKey}')" class="w-full bg-gray-200 text-gray-700 p-2 rounded-md font-semibold hover:bg-gray-300 text-sm">Reset</button>
                    </div>
                </div>
            `;

            sidebar.innerHTML = sidebarHTML;
            title.innerText = `Fresh Recommendations in ${categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1)}`;
            
            const locationFilter = document.getElementById('location-filter');
            if (locationFilter) {
                locationFilter.value = document.getElementById('location-search').value || "Aligarh, Uttar Pradesh";
            }
        }
        window.updateListingPage = updateListingPage;
        
        function togglePostButton() {
            const checkbox = document.getElementById('terms-checkbox');
            const button = document.getElementById('post-ad-button');
            if (checkbox.checked) {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        window.togglePostButton = togglePostButton;

        // --- Chat Logic ---
        let isMuted = false;
        const synth = new Tone.Synth().toDestination();

        function openChatWindow(sellerName, adId) {
            document.getElementById('chat-seller-name').innerText = sellerName;
            document.getElementById('chat-ad-id').innerText = `Ad ID: ${adId}`;
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('chat-notification-dot').classList.add('hidden');
        }
        window.openChatWindow = openChatWindow;

        function closeChatWindow() {
            document.getElementById('chat-window').classList.add('hidden');
        }
        window.closeChatWindow = closeChatWindow;

        function toggleMute() {
            isMuted = !isMuted;
            const muteIcon = document.getElementById('mute-btn').querySelector('i');
            muteIcon.className = isMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
        }
        window.toggleMute = toggleMute;

        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message) {
                appendMessage(message, 'sent');
                input.value = '';
                simulateReply();
            }
        });

        function appendMessage(text, type) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.textContent = text;
            if (type === 'sent') {
                messageDiv.className = 'bg-theme-accent text-white p-2 rounded-lg self-end ml-auto max-w-xs break-words';
            } else {
                messageDiv.className = 'bg-gray-200 p-2 rounded-lg self-start mr-auto max-w-xs break-words';
                if (!isMuted) {
                    synth.triggerAttackRelease("C5", "8n");
                }
                document.getElementById('chat-notification-dot').classList.remove('hidden');
                document.getElementById('main-notification-dot').classList.remove('hidden');
            }
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function simulateReply() {
            setTimeout(() => {
                appendMessage("Thanks for your interest! Is the item still available?", 'received');
            }, 1500);
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            document.getElementById('main-notification-dot').classList.add('hidden');
        }
        window.toggleNotifications = toggleNotifications;

        function switchAuthForm(form) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const forgotForm = document.getElementById('forgot-password-form');
            
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            forgotForm.classList.add('hidden');

            if (form === 'login') {
                loginForm.classList.remove('hidden');
            } else if (form === 'register') {
                registerForm.classList.remove('hidden');
            } else if (form === 'forgot') {
                forgotForm.classList.remove('hidden');
            }
        }
        window.switchAuthForm = switchAuthForm;
        
        function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    document.getElementById('profile-pic-preview').src = imageUrl;
                }
                reader.readAsDataURL(file);
            }
        }
        window.handleProfilePictureChange = handleProfilePictureChange;
        
        // --- Authentication Logic ---
        async function handleRegister(event) {
            event.preventDefault();
            const firstName = document.getElementById('register-first-name').value.trim();
            const lastName = document.getElementById('register-last-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const mobile = document.getElementById('register-mobile').value.trim();
            const password = document.getElementById('register-password').value.trim();

            if (!firstName || !lastName || !email || !password || !mobile) {
                showToast('Please fill in all required fields.', 'error');
                return;
            }
            if (!/^[0-9]{10}$/.test(mobile)) {
                showToast('Please enter a valid 10-digit mobile number.', 'error');
                return;
            }
            if (password.length < 6) {
                showToast('Password must be at least 6 characters long.', 'error');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await updateProfile(user, {
                    displayName: `${firstName} ${lastName}`
                });

                // Create a user profile in Supabase
                const { error: supabaseError } = await supabase
                    .from('profiles')
                    .insert([{ 
                        id: user.uid, 
                        first_name: firstName, 
                        last_name: lastName, 
                        mobile: mobile,
                        email: email 
                    }]);

                if (supabaseError) throw supabaseError;

                showToast('Registration successful! Please check your email to verify your account.', 'success');
                hideLoginModal();
            } catch (error) {
                console.error("Error signing up:", error);
                showToast('Error signing up: ' + error.message, 'error');
            }
        }
        window.handleRegister = handleRegister;

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!email || !password) {
                showToast('Please enter both email and password.', 'error');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideLoginModal();
                showToast('Login successful!', 'success');
            } catch (error) {
                console.error("Error logging in:", error);
                showToast('Error logging in: ' + error.message, 'error');
            }
        }
        window.handleLogin = handleLogin;

        async function loginWithGoogle(event) {
            event.preventDefault();
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                hideLoginModal();
                showToast('Logged in with Google successfully!', 'success');
            } catch (error) {
                console.error('Error with Google login:', error);
                showToast('Google login failed. Please try again.', 'error');
            }
        }
        window.loginWithGoogle = loginWithGoogle;

        async function handlePasswordReset(event) {
            event.preventDefault();
            const email = document.getElementById('reset-email').value.trim();

            if (!email) {
                showToast('Please enter your email address.', 'error');
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                showToast('Password reset link sent! Please check your email.', 'success');
                switchAuthForm('login');
            } catch (error) {
                console.error("Error sending password reset email:", error);
                showToast('Error: ' + error.message, 'error');
            }
        }
        window.handlePasswordReset = handlePasswordReset;
        
        async function logout(event) {
            if(event) event.preventDefault();
            try {
                await signOut(auth);
                showToast('You have been logged out.', 'info');
            } catch (error) {
                console.error('Error logging out:', error);
                showToast('Logout failed!', 'error');
            }
        }
        window.logout = logout;

        // --- Auth State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const lastPage = window.navigationHistory.length > 0 ? window.navigationHistory[window.navigationHistory.length - 1] : 'homepage';
                showPage(lastPage, true); 
                await updateUIForUser(user);
                
                if (postLoginAction === 'sellItem') {
                    showSellModal();
                } else if (postLoginAction === 'viewProduct') {
                    showProductDetailPage();
                }
                postLoginAction = null;
            } else {
                showPage('homepage', false);
                updateUIForGuest();
            }
        });

        async function updateUIForUser(user) {
            const fullName = user.displayName || user.email;
            const profilePicUrl = user.photoURL || `https://placehold.co/96x96/0A2342/D4AF37?text=${(fullName || 'U').charAt(0).toUpperCase()}`;

            // Fetch additional user data from Supabase
            const { data: userProfileData, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.uid)
                .single();
            
            if (error && error.code !== 'PGRST116') { // Ignore "No rows found" error
                console.error("Error fetching user profile from Supabase:", error);
            }

            // Update Header
            document.getElementById('header-profile-pic').src = profilePicUrl;
            document.getElementById('dropdown-profile-pic').src = profilePicUrl;
            document.getElementById('dropdown-username').innerText = fullName;

            // Update Profile Page
            document.getElementById('profile-page-pic').src = profilePicUrl;
            document.getElementById('profile-page-username').innerText = fullName;
            const creationDate = user.metadata.creationTime ? new Date(user.metadata.creationTime) : new Date();
            document.getElementById('profile-page-member-since').innerText = `Member since ${creationDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;

            // Update Edit Profile Page
            document.getElementById('profile-pic-preview').src = profilePicUrl;
            document.getElementById('edit-profile-name-input').value = fullName;
            document.getElementById('edit-profile-email-input').value = user.email || '';
            if(userProfileData) {
                document.getElementById('edit-profile-phone-input').value = userProfileData.mobile || '';
                document.getElementById('edit-profile-about-input').value = userProfileData.about || '';
            }
        }

        function updateUIForGuest() {
            const placeholderPic = 'https://placehold.co/40x40/E2E8F0/4A5568?text=U';
            document.getElementById('header-profile-pic').src = placeholderPic;
            document.getElementById('dropdown-profile-pic').src = placeholderPic;
            document.getElementById('dropdown-username').innerText = 'Unknown';
        }

        async function handleProfileUpdate(event) {
            event.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showToast('You must be logged in to update your profile.', 'error');
                return;
            }

            const newName = document.getElementById('edit-profile-name-input').value.trim();
            const newPhone = document.getElementById('edit-profile-phone-input').value.trim();
            const newAbout = document.getElementById('edit-profile-about-input').value.trim();

            if (!newName) {
                showToast('Name cannot be empty.', 'error');
                return;
            }
            
            try {
                await updateProfile(user, { displayName: newName });
                
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        mobile: newPhone, 
                        about: newAbout,
                        first_name: newName.split(' ')[0],
                        last_name: newName.split(' ').slice(1).join(' ')
                    })
                    .eq('id', user.uid);
                
                if (error) throw error;

                showToast('Profile updated successfully!', 'success');
                await updateUIForUser(user);
                showUserProfilePage(event);
            } catch (error) {
                console.error("Error updating profile:", error);
                showToast('Failed to update profile: ' + error.message, 'error');
            }
        }
        window.handleProfileUpdate = handleProfileUpdate;
        
        function loadCategories() {
            const categorySelect = document.getElementById('category-select');
            while (categorySelect.options.length > 1) {
                categorySelect.remove(1);
            }
            categoriesData.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        async function uploadFilesToCloudinary(files) {
            const uploadedUrls = [];
            const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const response = await fetch(uploadUrl, { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.secure_url) {
                        uploadedUrls.push(data.secure_url);
                    } else { throw new Error('Image upload failed.'); }
                } catch (error) {
                    console.error('Error uploading to Cloudinary:', error);
                    showToast('An error occurred during file upload.', 'error');
                    return [];
                }
            }
            return uploadedUrls;
        }
        
        let editingAdId = null; 

        async function handleAdSubmit(event) {
            event.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showToast('You must be logged in to post an ad.', 'error');
                showLoginModal();
                return;
            }

            const title = document.getElementById('ad-title').value.trim();
            const description = document.getElementById('ad-description').value.trim();
            const price = document.getElementById('ad-price').value;
            const categoryId = document.getElementById('category-select').value;
            const files = document.getElementById('file-upload').files;
            
            if (!title || !description || !price || !categoryId) {
                showToast("Please fill out all required fields.", 'error');
                return;
            }
            if (description.split(/\s+/).filter(w => w.length > 0).length < 50) {
                showToast(`Description must be at least 50 words.`, 'error');
                return;
            }
            if (/(\+?\d{1,4}?[-.\s]?)?(\(?\d{3}\)?[-.\s]?)?[\d\-.\s]{7,10}/g.test(title + description)) {
                showToast("Phone numbers are not allowed in title or description.", 'error');
                return;
            }

            let imageUrls = [];
            if (files.length > 0) {
                imageUrls = await uploadFilesToCloudinary(files);
                if (imageUrls.length !== files.length) {
                    showToast('Some images failed to upload. Please try again.', 'error');
                    return;
                }
            }

            const listingData = {
                user_id: user.uid,
                category_id: categoryId,
                title: title,
                description: description,
                price: parseFloat(price),
                image_urls: imageUrls,
                location: document.getElementById('location-search').value || 'Not specified'
            };

            try {
                let error;
                if (editingAdId) {
                    const result = await supabase.from('listings').update(listingData).eq('id', editingAdId);
                    error = result.error;
                } else {
                    const result = await supabase.from('listings').insert([listingData]);
                    error = result.error;
                }

                if (error) throw error;
                
                if(editingAdId) {
                    showToast('Ad updated successfully!', 'success');
                } else {
                    showPostSuccessModal();
                }

                hideSellModal();
                fetchAndDisplayMyAds();
            } catch (error) {
                console.error('Error saving listing to Supabase:', error);
                showToast('Failed to save ad: ' + error.message, 'error');
            }
        }
        window.handleAdSubmit = handleAdSubmit;

        async function handleEditAd(adId) {
            editingAdId = adId;
            const { data: ad, error } = await supabase
                .from('listings')
                .select('*')
                .eq('id', adId)
                .single();
            
            if (error) {
                console.error("Error fetching ad for edit:", error);
                showToast('Could not load ad details for editing.', 'error');
                return;
            }
            
            document.getElementById('category-select').value = ad.category_id;
            updateAttributeFields();
            document.getElementById('ad-title').value = ad.title;
            document.getElementById('ad-description').value = ad.description;
            document.getElementById('ad-price').value = ad.price;
            
            document.querySelector('#sellModal .text-2xl').textContent = 'Edit Your Ad';
            document.getElementById('post-ad-button').textContent = 'Update Ad';
            
            showSellModal();
        }
        window.handleEditAd = handleEditAd;

        async function handleDeleteAd(adId) {
            const { error } = await supabase.from('listings').delete().eq('id', adId);
            if (error) {
                console.error('Error deleting ad:', error);
                showToast('Failed to delete ad.', 'error');
            } else {
                showToast('Ad deleted successfully!', 'success');
                fetchAndDisplayMyAds();
            }
        }
        window.handleDeleteAd = handleDeleteAd;

        async function fetchAndDisplayMyAds() {
            const user = auth.currentUser;
            if (!user) {
                showLoginModal();
                return;
            }

            const { data: ads, error } = await supabase
                .from('listings')
                .select('*')
                .eq('user_id', user.uid);

            if (error) {
                console.error("Error fetching user's ads:", error);
                showToast("Could not fetch your ads.", 'error');
                return;
            }

            const adsGrid = document.getElementById('my-ads-grid');
            adsGrid.innerHTML = '';

            if (!ads || ads.length === 0) {
                adsGrid.innerHTML = `
                    <div class="col-span-full bg-white p-8 rounded-lg shadow-md text-center">
                        <img src="https://placehold.co/300x200/F0F9FF/1a202c?text=Sell+Something" class="mx-auto mb-4">
                        <h3 class="text-2xl font-bold">You haven't listed anything yet</h3>
                        <p class="text-gray-500 mb-6">Let go of what you don't use anymore</p>
                        <button onclick="showSellModal()" class="bg-theme-accent text-white px-6 py-3 rounded-full font-semibold hover:bg-theme-accent-dark">Start selling</button>
                    </div>`;
                return;
            }

            ads.forEach((ad) => {
                const adCard = `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <img src="${ad.image_urls && ad.image_urls.length > 0 ? ad.image_urls[0] : 'https://placehold.co/400x300/E2E8F0/4A5568?text=No+Image'}" alt="Product Image" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-2">₹ ${ad.price.toLocaleString('en-IN')}</h3>
                            <p class="text-gray-600 text-sm mb-4 truncate">${ad.title}</p>
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>${ad.location || 'N/A'}</span>
                                <span class="px-2 py-1 bg-green-200 text-green-800 rounded-full text-xs">Active</span>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button onclick="handleEditAd(${ad.id})" class="w-full bg-gray-200 text-gray-700 p-2 rounded-md font-semibold hover:bg-gray-300 text-sm">Edit</button>
                                <button onclick="handleDeleteAd(${ad.id})" class="w-full bg-red-500 text-white p-2 rounded-md font-semibold hover:bg-red-600 text-sm">Delete</button>
                            </div>
                        </div>
                    </div>`;
                adsGrid.innerHTML += adCard;
            });
        }
        window.fetchAndDisplayMyAds = fetchAndDisplayMyAds;

        async function fetchAndDisplayListings(category) {
            const { data: ads, error } = await supabase
                .from('listings')
                .select('*')
                .eq('category_id', category);

            if (error) {
                console.error("Error fetching listings:", error);
                showToast("Could not fetch listings.", 'error');
                return;
            }

            const listingGrid = document.getElementById('listing-grid');
            listingGrid.innerHTML = '';

            if (!ads || ads.length === 0) {
                listingGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">No listings found in this category yet.</p>`;
                return;
            }

            ads.forEach((ad) => {
                const adCard = `
                <a href="#" onclick="showProductDetailPage(event)" class="block bg-white rounded-lg border border-gray-200 overflow-hidden product-card transition-all duration-300 relative">
                    ${ad.is_premium ? '<span class="absolute top-2 right-2 bg-theme-accent text-white text-xs font-bold px-2 py-1 rounded">Premium</span>' : ''}
                    <img src="${ad.image_urls && ad.image_urls.length > 0 ? ad.image_urls[0] : 'https://placehold.co/400x300/E2E8F0/4A5568?text=No+Image'}" alt="${ad.title}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg mb-2 truncate">₹ ${ad.price.toLocaleString('en-IN')}</h3>
                            <i class="far fa-heart text-gray-400 hover:text-red-500"></i>
                        </div>
                        <p class="text-gray-600 text-sm truncate">${ad.title}</p>
                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                            <span>${ad.location}</span>
                            <span>${ad.created_at ? new Date(ad.created_at).toLocaleDateString() : 'Recently'}</span>
                        </div>
                    </div>
                </a>`;
                listingGrid.innerHTML += adCard;
            });
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             // Initial Sign-In Logic
            (async () => {
                try {
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        console.log("Signing in with custom token...");
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else if (!auth.currentUser) {
                        console.log("Signing in anonymously...");
                        await signInAnonymously(auth);
                    }
                    console.log("Initial sign-in check complete.");
                } catch (error) {
                    console.error("Error during initial sign-in:", error);
                    showToast(`Initial authentication failed: ${error.message}`, 'error');
                }
            })();

            loadCategories();
            showHomepage(); // Show homepage on initial load
        });

    </script>
</body>
</html>

