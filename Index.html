<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- SEO Configuration -->
    <title>TradeGinger | India's #1 B2B & C2C Marketplace for Cars, Property & Mobiles</title>
    <meta name="description" content="TradeGinger is the safest platform to buy and sell used cars, property, and electronics. Features verified sellers, secure chat, lead generation for businesses, and premium listings.">
    <meta name="keywords" content="buy leads india, used cars, second hand mobiles, property for sale, b2b marketplace, tradeginger, classifieds">
    <meta name="author" content="TradeGinger Inc.">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="TradeGinger - Buy, Sell & Grow Your Business">
    <meta property="og:description" content="Join verified buyers and sellers. Unlock leads, post premium ads, and trade safely.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?auto=format&fit=crop&q=80&w=1200">
    <meta property="og:url" content="https://tradeginger.com">
    <meta property="og:type" content="website">

    <!-- Security: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://*.supabase.co https://generativelanguage.googleapis.com https://checkout.razorpay.com; 
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; 
        font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com; 
        img-src 'self' data: blob: https://* https://placehold.co; 
        connect-src 'self' https://*.supabase.co https://api.cloudinary.com https://generativelanguage.googleapis.com wss://*.supabase.co https://lumberjack.razorpay.com; 
        media-src 'self' blob:;
        frame-src 'self' https://api.razorpay.com;
        object-src 'none';
    ">

    <!-- Preload Critical Assets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS Libraries (Tailwind & FontAwesome) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 800: '#075985', 900: '#0c4a6e' }, // Ocean Blue
                        accent: { 500: '#f59e0b', 600: '#d97706' }, // Amber/Gold
                        dark: { 800: '#1e293b', 900: '#0f172a' },
                        gold: { 400: '#fbbf24', 500: '#f59e0b' },
                        platinum: { 400: '#94a3b8', 500: '#64748b' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles & Animations */
        body { background-color: #f8fafc; -webkit-font-smoothing: antialiased; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Glassmorphism Utilities */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        
        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 24px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 0.9rem; display: flex; align-items: center; gap: 8px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Skeleton Loading */
        .skeleton { background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Plan Badges */
        .badge-platinum { background: linear-gradient(45deg, #e2e8f0, #94a3b8); color: white; }
        .badge-gold { background: linear-gradient(45deg, #fcd34d, #d97706); color: white; }
    </style>
</head>
<body class="text-gray-800 flex flex-col min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-white/95 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-gray-100">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="#home" class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-primary-600 to-primary-800 rounded-lg flex items-center justify-center text-white font-bold text-xl">T</div>
                        <span class="text-2xl font-extrabold tracking-tight text-dark-900">Trade<span class="text-primary-600">Ginger</span></span>
                    </a>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-6">
                    <!-- Search Bar (Compact) -->
                    <div class="relative group">
                        <input type="text" id="nav-search" placeholder="Search..." class="w-48 transition-all duration-300 focus:w-72 pl-10 pr-4 py-1.5 bg-gray-100 border-transparent focus:bg-white border focus:border-primary-500 rounded-full text-sm focus:outline-none">
                        <i class="fas fa-search absolute left-3.5 top-2.5 text-gray-400"></i>
                    </div>

                    <a href="#home" class="text-gray-600 hover:text-primary-600 font-medium transition-colors">Home</a>
                    
                    <!-- Auth Logic Handled by JS -->
                    <div id="nav-auth-section" class="flex items-center space-x-4">
                        <!-- Injected via JS -->
                    </div>
                    
                    <button onclick="app.router.navigate('sell')" class="bg-gradient-to-r from-accent-500 to-accent-600 hover:from-accent-600 hover:to-accent-700 text-white px-5 py-2 rounded-full font-bold shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
                        <i class="fas fa-plus"></i> SELL
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="flex items-center md:hidden">
                    <button id="mobile-menu-btn" class="text-gray-600 hover:text-primary-600 focus:outline-none">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100 absolute w-full shadow-lg">
            <div class="px-4 pt-2 pb-4 space-y-3" id="mobile-nav-content">
                <!-- Injected via JS -->
            </div>
        </div>
    </nav>

    <!-- Main Content Area (SPA Router View) -->
    <main id="app-view" class="flex-grow">
        <!-- Views will be injected here -->
    </main>

    <!-- Footer -->
    <footer class="bg-dark-900 text-white pt-12 pb-8 mt-auto">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 border-b border-gray-700 pb-8">
                <div>
                    <h3 class="text-2xl font-bold mb-4">TradeGinger</h3>
                    <p class="text-gray-400 text-sm">The safest way to buy and sell locally. Verified users, secure chat, and premium listings.</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-4 text-gray-200">For Business</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="#leads" class="hover:text-white transition">Buy Leads</a></li>
                        <li><a href="#sell" class="hover:text-white transition">Business Accounts</a></li>
                        <li><a href="#" onclick="app.modals.tnc.show()" class="hover:text-white transition">Pricing Plans</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4 text-gray-200">Categories</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="#listing?cat=cars" class="hover:text-white transition">Cars</a></li>
                        <li><a href="#listing?cat=mobiles" class="hover:text-white transition">Mobiles</a></li>
                        <li><a href="#listing?cat=property" class="hover:text-white transition">Real Estate</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4 text-gray-200">Contact</h4>
                    <p class="text-gray-400 text-sm mb-2"><i class="fas fa-envelope mr-2"></i> sales@tradeginger.com</p>
                    <p class="text-gray-400 text-sm"><i class="fas fa-map-marker-alt mr-2"></i> Gurugram, India</p>
                    <div class="flex space-x-4 mt-4">
                        <a href="#" class="text-gray-400 hover:text-white text-xl"><i class="fab fa-facebook"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white text-xl"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white text-xl"><i class="fab fa-twitter"></i></a>
                    </div>
                    <div class="mt-6">
                        <p class="text-gray-400 text-xs mb-2">Scan to Follow</p>
                        <img src="https://res.cloudinary.com/dcxhenppn/image/upload/v1758373119/tradeginger_qr_abft9t.png" alt="Instagram QR Code" class="w-24 h-24 rounded-lg shadow-md border border-gray-700">
                    </div>
                </div>
            </div>
            <div class="text-center pt-8 text-gray-500 text-sm">
                &copy; 2025 TradeGinger. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- MODALS -->
    
    <!-- Auth Modal (Login/Register) -->
    <div id="auth-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center p-6 border-b border-gray-100 bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800" id="auth-title">Welcome Back</h3>
                <button onclick="app.modals.auth.hide()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6">
                <form id="auth-form" onsubmit="app.auth.handleAuthSubmit(event)">
                    <!-- User Type Toggle -->
                    <div id="user-type-toggle" class="hidden mb-6 flex bg-gray-100 p-1 rounded-lg">
                        <button type="button" class="flex-1 py-2 rounded-md text-sm font-bold bg-white shadow-sm text-gray-800 transition" onclick="app.auth.setUserType('individual', this)">Individual</button>
                        <button type="button" class="flex-1 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 transition" onclick="app.auth.setUserType('business', this)">Business</button>
                        <input type="hidden" name="accountType" id="auth-account-type" value="individual">
                    </div>

                    <div id="register-fields" class="hidden space-y-4 mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" name="firstName" placeholder="First Name" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition">
                            <input type="text" name="lastName" placeholder="Last Name" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none transition">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="relative">
                            <i class="fas fa-envelope absolute left-3 top-3.5 text-gray-400"></i>
                            <input type="email" name="email" placeholder="Email Address" required class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none transition">
                        </div>
                        <div class="relative">
                            <i class="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
                            <input type="password" name="password" placeholder="Password" required class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none transition">
                        </div>
                    </div>

                    <div class="mt-6">
                        <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 rounded-lg shadow-lg transition-all hover:shadow-xl flex justify-center items-center gap-2">
                            <span id="auth-btn-text">Login</span> <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                    <div class="mt-4 relative flex items-center justify-center">
                        <div class="border-t w-full absolute"></div>
                        <span class="bg-white px-3 relative text-sm text-gray-500">OR</span>
                    </div>

                    <button type="button" onclick="app.auth.loginWithGoogle()" class="mt-4 w-full border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 font-medium py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                        <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5"> Continue with Google
                    </button>
                </form>
                
                <div class="mt-6 text-center text-sm">
                    <span id="auth-switch-text" class="text-gray-600">Don't have an account?</span>
                    <button onclick="app.auth.toggleMode()" class="text-primary-600 font-bold hover:underline ml-1" id="auth-switch-btn">Register</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sell Modal -->
    <div id="sell-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-bold">Post an Ad</h3>
                <button onclick="app.modals.sell.hide()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <form id="sell-form" class="space-y-6">
                    <!-- Progress Steps -->
                    <div class="flex justify-between mb-6 text-sm font-medium text-gray-500 border-b pb-4">
                        <span class="text-primary-600">1. Details</span>
                        <span>2. Images</span>
                        <span>3. Plan</span>
                    </div>

                    <!-- Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="category-select" name="category" required onchange="app.sell.updateSubcats()" class="w-full rounded-lg border-gray-300 border px-4 py-2 focus:ring-2 focus:ring-primary-500 outline-none bg-white">
                                <option value="">Select...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sub-Category</label>
                            <select id="subcategory-select" name="subcategory" required class="w-full rounded-lg border-gray-300 border px-4 py-2 focus:ring-2 focus:ring-primary-500 outline-none bg-white" disabled>
                                <option value="">Select Category First</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" name="title" required class="w-full rounded-lg border-gray-300 border px-4 py-2 focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price (₹)</label>
                            <input type="number" name="price" required class="w-full rounded-lg border-gray-300 border px-4 py-2 focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <div class="relative">
                            <textarea name="description" id="ad-description" rows="4" required class="w-full rounded-lg border-gray-300 border px-4 py-2 focus:ring-2 focus:ring-primary-500 outline-none"></textarea>
                            <button type="button" onclick="app.sell.generateAI()" class="absolute bottom-2 right-2 text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-md hover:bg-purple-200 transition flex items-center gap-1">
                                <i class="fas fa-magic"></i> AI Write
                            </button>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                            <select id="state-select" required onchange="app.location.populateCities(this.value, 'city-select')" class="w-full rounded-lg border-gray-300 border px-4 py-2 bg-white"></select>
                        </div>
                        <div>
                             <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                            <select id="city-select" name="city_id" required class="w-full rounded-lg border-gray-300 border px-4 py-2 bg-white" disabled></select>
                        </div>
                    </div>

                    <!-- Image Upload -->
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-primary-500 hover:bg-primary-50 transition cursor-pointer relative" onclick="document.getElementById('file-upload').click()">
                        <input type="file" id="file-upload" multiple accept="image/*" class="hidden" onchange="app.sell.handleFiles(event)">
                        <i class="fas fa-cloud-upload-alt text-4xl text-primary-400 mb-3"></i>
                        <p class="text-gray-600 font-medium">Click to upload photos</p>
                        <p class="text-xs text-gray-400 mt-1">Max 5MB per image</p>
                    </div>
                    <div id="preview-container" class="flex gap-2 overflow-x-auto pb-2"></div>

                    <!-- Plans Selection -->
                    <div class="pt-4 border-t">
                        <h4 class="text-lg font-bold mb-3">Select Plan</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <!-- Free Plan -->
                            <label class="cursor-pointer">
                                <input type="radio" name="plan" value="free" class="peer hidden" checked onchange="app.sell.updatePlanPrice(0)">
                                <div class="border rounded-xl p-4 hover:border-primary-500 peer-checked:border-primary-600 peer-checked:bg-primary-50 peer-checked:ring-1 peer-checked:ring-primary-500 transition h-full flex flex-col">
                                    <div class="font-bold text-gray-800">Free Plan</div>
                                    <div class="text-xl font-bold text-primary-600 my-1">₹0</div>
                                    <div class="text-xs text-gray-500 space-y-1 mt-2 flex-grow">
                                        <p>✓ Active for 45 days</p>
                                        <p>✓ Phone hidden (Safe)</p>
                                    </div>
                                </div>
                            </label>
                            <!-- C2C/Premium -->
                            <label class="cursor-pointer">
                                <input type="radio" name="plan" value="gold" class="peer hidden" onchange="app.sell.updatePlanPrice(99)">
                                <div class="border rounded-xl p-4 hover:border-gold-500 peer-checked:border-gold-500 peer-checked:bg-yellow-50 peer-checked:ring-1 peer-checked:ring-gold-500 transition h-full flex flex-col relative overflow-hidden">
                                    <div class="absolute top-0 right-0 bg-gold-500 text-white text-[10px] px-2 py-0.5">Recommended</div>
                                    <div class="font-bold text-gray-800">Gold / C2C</div>
                                    <div class="text-xl font-bold text-gold-500 my-1">₹99</div>
                                    <div class="text-xs text-gray-500 space-y-1 mt-2 flex-grow">
                                        <p>✓ Active for 20 days</p>
                                        <p>✓ <strong>Phone Visible</strong> (Verified)</p>
                                        <p>✓ Top of Category</p>
                                    </div>
                                </div>
                            </label>
                            <!-- Platinum -->
                            <label class="cursor-pointer">
                                <input type="radio" name="plan" value="platinum" class="peer hidden" onchange="app.sell.updatePlanPrice(499)">
                                <div class="border rounded-xl p-4 hover:border-gray-800 peer-checked:border-gray-800 peer-checked:bg-gray-100 peer-checked:ring-1 peer-checked:ring-gray-800 transition h-full flex flex-col">
                                    <div class="font-bold text-gray-800">Platinum</div>
                                    <div class="text-xl font-bold text-gray-800 my-1">₹499</div>
                                    <div class="text-xs text-gray-500 space-y-1 mt-2 flex-grow">
                                        <p>✓ Featured on Homepage</p>
                                        <p>✓ Social Media Promo</p>
                                        <p>✓ Dedicated Support</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                </form>
            </div>
            <div class="p-5 border-t bg-gray-50 flex justify-between items-center">
                <div class="text-sm text-gray-600">Total: <span id="total-plan-price" class="font-bold text-lg text-primary-600">₹0</span></div>
                <div class="flex gap-3">
                    <button onclick="app.modals.sell.hide()" class="px-5 py-2 rounded-lg text-gray-600 hover:bg-gray-200 transition">Cancel</button>
                    <button onclick="app.sell.submit()" class="px-5 py-2 rounded-lg bg-accent-500 text-white font-bold hover:bg-accent-600 shadow-md transition">Post & Pay</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Info Modal (T&C) -->
    <div id="info-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
            <h2 class="text-xl font-bold mb-4">Terms & Conditions</h2>
            <div class="h-64 overflow-y-auto text-sm text-gray-600 space-y-2 mb-4 p-2 border rounded bg-gray-50">
                <p>Welcome to TradeGinger. By using this platform, you agree to:</p>
                <ul class="list-disc pl-5">
                    <li>Not post illegal or banned items.</li>
                    <li>Act professionally with other users.</li>
                    <li>TradeGinger is an intermediary and not responsible for transactions.</li>
                    <li>Ensure your safety during physical meetups.</li>
                </ul>
                <p><strong>Refund Policy:</strong> Refunds processed within 7-10 days only for technical errors.</p>
                <p><strong>Data Privacy:</strong> We protect your data. Phone numbers are shared only upon "Unlock" payment.</p>
            </div>
            <button onclick="app.modals.tnc.hide()" class="w-full bg-dark-800 text-white py-2 rounded hover:bg-dark-900">Close</button>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[65] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex overflow-hidden">
            <!-- Chat Sidebar -->
            <div class="w-1/3 border-r border-gray-100 bg-gray-50 flex flex-col hidden md:flex">
                <div class="p-4 border-b bg-white font-bold text-gray-700">Conversations</div>
                <div id="chat-list" class="flex-grow overflow-y-auto">
                    <!-- Chat List Items -->
                </div>
            </div>
            <!-- Chat Area -->
            <div class="flex-1 flex flex-col bg-white w-full">
                <div class="p-4 border-b flex justify-between items-center bg-white">
                    <div class="flex items-center gap-3">
                        <button class="md:hidden mr-2 text-gray-500" onclick="document.getElementById('chat-modal').classList.add('hidden')"><i class="fas fa-arrow-left"></i></button>
                        <img id="chat-header-img" src="" class="w-10 h-10 rounded-full bg-gray-200 object-cover">
                        <div>
                            <h4 id="chat-header-name" class="font-bold text-gray-800 leading-tight">User</h4>
                            <span id="chat-header-status" class="text-xs text-green-500 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Online</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('chat-modal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
                </div>
                
                <!-- Safety Warning -->
                <div class="bg-yellow-50 text-yellow-700 text-xs p-2 text-center border-b border-yellow-100">
                    <i class="fas fa-shield-alt"></i> Keep chats within TradeGinger. Sharing phone numbers is blocked for your safety.
                </div>

                <div id="chat-messages" class="flex-grow overflow-y-auto p-6 space-y-4 bg-slate-50">
                    <!-- Messages -->
                </div>
                <div class="p-4 border-t bg-white">
                    <form onsubmit="app.chat.send(event)" class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Type a message..." class="flex-grow rounded-full border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-primary-500 outline-none">
                        <button type="submit" class="w-10 h-10 rounded-full bg-primary-600 text-white flex items-center justify-center hover:bg-primary-700 transition"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        /**
         * SECURITY NOTE: 
         * The keys below are Anon (Public) keys provided in the prompt.
         * Security relies on Row Level Security (RLS) policies configured in the Supabase Database.
         * The client key *must* be public to allow users to log in from their browser.
         */
        const SUPABASE_URL = 'https://crepnlidfdoskighdhdt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyZXBubGlkZmRvc2tpZ2hkaGR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4Mjg3MzYsImV4cCI6MjA2ODQwNDczNn0.SjrYMGxuIFDsSZpPBm6a_ZveuI_gef80o03TNESJlDw';
        const CLOUDINARY_CLOUD_NAME = 'dcxhenppn';
        const CLOUDINARY_PRESET = 'Tradeginger';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE MANAGEMENT ---
        const state = {
            user: null,
            profile: null,
            categories: [
                { id: 1, name: 'Cars', icon: 'fa-car' },
                { id: 2, name: 'Property', icon: 'fa-building' },
                { id: 3, name: 'Mobiles', icon: 'fa-mobile-alt' },
                { id: 7, name: 'Furniture', icon: 'fa-couch' },
                { id: 4, name: 'Bikes', icon: 'fa-motorcycle' },
                { id: 5, name: 'Electronics', icon: 'fa-tv' },
                { id: 8, name: 'Fashion', icon: 'fa-tshirt' },
                { id: 9, name: 'Pets', icon: 'fa-paw' }
            ],
            locations: [
                {state: 'Delhi', cities: ['New Delhi', 'Dwarka', 'Rohini']},
                {state: 'Maharashtra', cities: ['Mumbai', 'Pune', 'Nagpur']},
                {state: 'Karnataka', cities: ['Bengaluru', 'Mysuru']},
                {state: 'Haryana', cities: ['Gurugram', 'Faridabad']}
            ],
            currentChatRoom: null
        };

        // --- UTILS ---
        const utils = {
            sanitize: (str) => {
                if(!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            formatPrice: (price) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(price),
            timeAgo: (date) => {
                const seconds = Math.floor((new Date() - new Date(date)) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "y ago";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "mo ago";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "d ago";
                return "Just now";
            },
            toast: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-dark-800' };
                const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
                
                el.className = `toast ${colors[type]}`;
                el.innerHTML = `<i class="fas ${icons[type]}"></i> <span>${utils.sanitize(msg)}</span>`;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.animation = 'slideIn 0.3s reverse forwards';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            }
        };

        // --- APP MODULES ---
        const app = {
            init: async () => {
                // Check Auth
                const { data: { session } } = await supabase.auth.getSession();
                if(session) await app.auth.setUser(session.user);

                // Auth Listener
                supabase.auth.onAuthStateChange(async (_event, session) => {
                    if (session?.user) await app.auth.setUser(session.user);
                    else app.auth.clearUser();
                    app.router.handle(); // Re-render based on auth state
                });

                // Initial Route
                app.router.handle();
                window.addEventListener('hashchange', app.router.handle);
                
                // Chat Init
                app.chat.init();

                // Global Listeners
                document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                    document.getElementById('mobile-menu').classList.toggle('hidden');
                });
            },

            auth: {
                isRegistering: false,
                toggleMode: () => {
                    app.auth.isRegistering = !app.auth.isRegistering;
                    const regFields = document.getElementById('register-fields');
                    const typeToggle = document.getElementById('user-type-toggle');
                    const btnText = document.getElementById('auth-btn-text');
                    const switchText = document.getElementById('auth-switch-text');
                    const switchBtn = document.getElementById('auth-switch-btn');
                    const title = document.getElementById('auth-title');

                    if(app.auth.isRegistering) {
                        regFields.classList.remove('hidden');
                        typeToggle.classList.remove('hidden'); // Show C2C/B2B toggle
                        btnText.innerText = "Create Account";
                        switchText.innerText = "Already have an account?";
                        switchBtn.innerText = "Login";
                        title.innerText = "Join TradeGinger";
                    } else {
                        regFields.classList.add('hidden');
                        typeToggle.classList.add('hidden');
                        btnText.innerText = "Login";
                        switchText.innerText = "Don't have an account?";
                        switchBtn.innerText = "Register";
                        title.innerText = "Welcome Back";
                    }
                },
                setUserType: (type, btn) => {
                    document.getElementById('auth-account-type').value = type;
                    // Reset styles
                    const btns = btn.parentElement.querySelectorAll('button');
                    btns.forEach(b => {
                        b.classList.remove('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold');
                        b.classList.add('text-gray-500', 'font-medium');
                    });
                    // Set active
                    btn.classList.remove('text-gray-500', 'font-medium');
                    btn.classList.add('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold');
                },
                handleAuthSubmit: async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const email = fd.get('email');
                    const password = fd.get('password');

                    try {
                        if(app.auth.isRegistering) {
                            const firstName = fd.get('firstName');
                            const lastName = fd.get('lastName');
                            const accType = fd.get('accountType');
                            
                            const { error } = await supabase.auth.signUp({
                                email, password,
                                options: { 
                                    data: { 
                                        first_name: firstName, 
                                        last_name: lastName, 
                                        full_name: `${firstName} ${lastName}`,
                                        account_type: accType 
                                    } 
                                }
                            });
                            if(error) throw error;
                            utils.toast('Account created! Please verify email.', 'success');
                        } else {
                            const { error } = await supabase.auth.signInWithPassword({ email, password });
                            if(error) throw error;
                            utils.toast('Logged in successfully', 'success');
                            app.modals.auth.hide();
                        }
                    } catch (err) {
                        utils.toast(err.message, 'error');
                    }
                },
                loginWithGoogle: async () => {
                    const { error } = await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } });
                    if(error) utils.toast(error.message, 'error');
                },
                setUser: async (user) => {
                    state.user = user;
                    // Fetch Profile
                    const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
                    state.profile = data || { avatar_url: user.user_metadata.avatar_url, first_name: 'User' };
                    app.ui.renderNav();
                    app.chat.fetchConversations(); // Refresh chat list on login
                },
                clearUser: () => {
                    state.user = null;
                    state.profile = null;
                    app.ui.renderNav();
                    app.router.navigate('home');
                },
                logout: async () => {
                    await supabase.auth.signOut();
                    utils.toast('Logged out', 'info');
                }
            },

            payment: {
                process: async (amount, desc) => {
                    return new Promise((resolve) => {
                        const options = {
                            "key": "rzp_test_RhehzYF2lUBKpF", // Updated Test Key
                            "amount": amount * 100, // Amount is in currency subunits. Default currency is INR.
                            "currency": "INR",
                            "name": "TradeGinger",
                            "description": desc,
                            "image": "https://placehold.co/128x128/0ea5e9/ffffff?text=TG", // Logo
                            "handler": function (response){
                                // In a real app, you would verify response.razorpay_payment_id and response.razorpay_signature on your backend using the Secret Key
                                utils.toast(`Payment Successful! ID: ${response.razorpay_payment_id}`, 'success');
                                resolve(true);
                            },
                            "prefill": {
                                "name": state.profile?.full_name || "",
                                "email": state.user?.email || "",
                                "contact": state.profile?.mobile || ""
                            },
                            "theme": {
                                "color": "#0ea5e9"
                            },
                            "modal": {
                                "ondismiss": function(){
                                    resolve(false);
                                }
                            }
                        };
                        const rzp1 = new Razorpay(options);
                        rzp1.on('payment.failed', function (response){
                            utils.toast(`Payment Failed: ${response.error.description}`, 'error');
                            resolve(false);
                        });
                        rzp1.open();
                    });
                }
            },

            router: {
                navigate: (path) => window.location.hash = path,
                handle: async () => {
                    const hash = window.location.hash.slice(1) || 'home';
                    const [route, params] = hash.split('?');
                    const searchParams = new URLSearchParams(params);
                    const view = document.getElementById('app-view');
                    
                    window.scrollTo(0,0);

                    // Middleware check
                    if(route === 'sell' || route === 'profile' || route === 'leads') {
                        if(!state.user) {
                            app.modals.auth.show();
                            return; 
                        }
                    }

                    // Basic Router Switch
                    switch(route) {
                        case 'home':
                            view.innerHTML = app.views.home();
                            app.data.fetchHomeListings();
                            break;
                        case 'listing':
                            view.innerHTML = app.views.listings(searchParams.get('cat'), searchParams.get('q'));
                            app.data.fetchAllListings(searchParams);
                            break;
                        case 'detail':
                            const id = searchParams.get('id');
                            if(id) app.views.renderDetail(id);
                            break;
                        case 'profile':
                            view.innerHTML = app.views.profile();
                            app.data.fetchUserListings();
                            break;
                        case 'leads':
                            view.innerHTML = app.views.leads();
                            break;
                        case 'sell':
                             app.modals.sell.show();
                             history.back(); // Avoid staying on #sell hash
                             break;
                        default:
                            view.innerHTML = app.views.home();
                    }
                }
            },

            data: {
                fetchHomeListings: async () => {
                    const grid = document.getElementById('home-feed');
                    if(!grid) return;
                    grid.innerHTML = app.ui.skeletonCard().repeat(4);
                    
                    const { data, error } = await supabase.from('listings').select('*, cities(name)').limit(8).order('created_at', {ascending: false});
                    if(data) app.ui.renderGrid(grid, data);
                },
                fetchAllListings: async (params) => {
                    const grid = document.getElementById('listing-feed');
                    const title = document.getElementById('listing-title');
                    if(!grid) return;
                    grid.innerHTML = app.ui.skeletonCard().repeat(8);

                    let query = supabase.from('listings').select('*, cities(name)');
                    const catId = params.get('cat') ? state.categories.find(c => c.id == params.get('cat'))?.id : null;
                    const q = params.get('q');

                    if(title) title.innerText = q ? `Search: "${utils.sanitize(q)}"` : (params.get('catname') || 'All Listings');

                    if(catId) query = query.eq('category_id', catId);
                    if(q) query = query.textSearch('title', `'${q}'`);

                    const { data, error } = await query.limit(50);
                    if(data && data.length > 0) app.ui.renderGrid(grid, data);
                    else grid.innerHTML = `<div class="col-span-full text-center py-20 text-gray-500">No items found.</div>`;
                },
                fetchUserListings: async () => {
                    const grid = document.getElementById('user-ads');
                    if(!grid) return;
                    const { data } = await supabase.from('listings').select('*').eq('user_id', state.user.id);
                    if(data) app.ui.renderGrid(grid, data, true);
                },
                sendEnquiry: async (listingId, sellerId) => {
                    // Logic to save lead to DB
                    const name = document.getElementById('enquiry-name').value;
                    const phone = document.getElementById('enquiry-phone').value;
                    if(!name || !phone) return utils.toast('Please fill all fields', 'error');
                    
                    // Mock API call
                    utils.toast('Enquiry sent! Seller will contact you.', 'success');
                    document.getElementById('enquiry-form').reset();
                }
            },

            views: {
                home: () => `
                    <!-- Hero Section -->
                    <section class="relative h-[500px] flex items-center justify-center text-white fade-in">
                        <div class="absolute inset-0">
                            <img src="https://images.unsplash.com/photo-1521791136064-7986c2920216?q=85&w=1600&auto=format&fit=crop" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-b from-dark-900/80 to-dark-900/40"></div>
                        </div>
                        <div class="relative z-10 text-center px-4 max-w-3xl mx-auto">
                            <h1 class="text-4xl md:text-6xl font-extrabold mb-6 tracking-tight">Buy & Sell in Your <span class="text-accent-500">Community</span></h1>
                            <p class="text-lg md:text-xl mb-8 text-gray-200">India's most trusted marketplace. Zero fees. Verified sellers.</p>
                            
                            <div class="bg-white/20 backdrop-blur-md p-2 rounded-full flex shadow-2xl border border-white/20">
                                <input type="text" id="hero-search" placeholder="Search for Cars, Mobiles, Furniture..." class="flex-grow bg-transparent text-white placeholder-gray-300 px-6 py-3 outline-none">
                                <button onclick="app.router.navigate('listing?q='+document.getElementById('hero-search').value)" class="bg-accent-500 hover:bg-accent-600 text-white px-8 py-3 rounded-full font-bold transition">Search</button>
                            </div>
                        </div>
                    </section>

                    <!-- Categories -->
                    <section class="py-12 container mx-auto px-4">
                        <h2 class="text-2xl font-bold mb-8 text-gray-800">Browse Categories</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                            ${state.categories.map(c => `
                                <a href="#listing?cat=${c.id}&catname=${c.name}" class="flex flex-col items-center p-4 bg-white rounded-xl shadow-sm hover:shadow-md hover:-translate-y-1 transition border border-gray-100">
                                    <div class="w-12 h-12 rounded-full bg-primary-50 text-primary-600 flex items-center justify-center text-xl mb-3"><i class="fas ${c.icon}"></i></div>
                                    <span class="font-medium text-sm text-gray-700">${c.name}</span>
                                </a>
                            `).join('')}
                        </div>
                    </section>

                    <!-- Fresh Recommendations -->
                    <section class="py-12 bg-white border-t border-gray-100">
                        <div class="container mx-auto px-4">
                            <div class="flex justify-between items-end mb-8">
                                <div>
                                    <h2 class="text-3xl font-bold text-gray-900">Fresh Recommendations</h2>
                                    <p class="text-gray-500 mt-1">Handpicked items just for you</p>
                                </div>
                                <a href="#listing" class="text-primary-600 font-semibold hover:underline">View All <i class="fas fa-arrow-right text-xs"></i></a>
                            </div>
                            <div id="home-feed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                <!-- JS Injects Cards Here -->
                            </div>
                        </div>
                    </section>
                `,
                listings: (cat, q) => `
                    <div class="bg-gray-50 min-h-screen py-8">
                        <div class="container mx-auto px-4">
                            <div class="mb-6 flex items-center text-sm text-gray-500">
                                <a href="#home" class="hover:text-primary-600">Home</a> <span class="mx-2">/</span> <span>Listings</span>
                            </div>
                            <h1 class="text-3xl font-bold mb-8" id="listing-title">All Listings</h1>
                            <div id="listing-feed" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                <!-- Data loaded here -->
                            </div>
                        </div>
                    </div>
                `,
                leads: () => `
                    <div class="container mx-auto px-4 py-10 fade-in">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">Buy Business Leads</h1>
                        <p class="text-gray-500 mb-8">Grow your business by purchasing verified enquiries.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                             <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center hover:shadow-md transition">
                                <div class="w-12 h-12 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-home"></i></div>
                                <h3 class="font-bold text-lg">Real Estate Leads</h3>
                                <p class="text-gray-500 text-sm mb-4">High value property enquiries</p>
                                <div class="text-2xl font-bold text-gray-900 mb-4">₹150 <span class="text-sm font-normal text-gray-500">/lead</span></div>
                                <button onclick="app.payment.process(1500, '10 Real Estate Leads')" class="w-full bg-primary-600 text-white py-2 rounded-lg hover:bg-primary-700">Buy 10 Pack</button>
                             </div>
                             <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center hover:shadow-md transition">
                                <div class="w-12 h-12 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-car"></i></div>
                                <h3 class="font-bold text-lg">Automobile Leads</h3>
                                <p class="text-gray-500 text-sm mb-4">Used car buyers & sellers</p>
                                <div class="text-2xl font-bold text-gray-900 mb-4">₹150 <span class="text-sm font-normal text-gray-500">/lead</span></div>
                                <button onclick="app.payment.process(1500, '10 Auto Leads')" class="w-full bg-primary-600 text-white py-2 rounded-lg hover:bg-primary-700">Buy 10 Pack</button>
                             </div>
                             <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center hover:shadow-md transition">
                                <div class="w-12 h-12 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-laptop"></i></div>
                                <h3 class="font-bold text-lg">Electronics Leads</h3>
                                <p class="text-gray-500 text-sm mb-4">Laptop & Mobile enquiries</p>
                                <div class="text-2xl font-bold text-gray-900 mb-4">₹75 <span class="text-sm font-normal text-gray-500">/lead</span></div>
                                <button onclick="app.payment.process(750, '10 Electronics Leads')" class="w-full bg-primary-600 text-white py-2 rounded-lg hover:bg-primary-700">Buy 10 Pack</button>
                             </div>
                              <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center hover:shadow-md transition">
                                <div class="w-12 h-12 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-wrench"></i></div>
                                <h3 class="font-bold text-lg">Service Leads</h3>
                                <p class="text-gray-500 text-sm mb-4">Repair & local services</p>
                                <div class="text-2xl font-bold text-gray-900 mb-4">₹50 <span class="text-sm font-normal text-gray-500">/lead</span></div>
                                <button onclick="app.payment.process(500, '10 Service Leads')" class="w-full bg-primary-600 text-white py-2 rounded-lg hover:bg-primary-700">Buy 10 Pack</button>
                             </div>
                        </div>
                    </div>
                `,
                renderDetail: async (id) => {
                    const view = document.getElementById('app-view');
                    view.innerHTML = `<div class="h-screen flex items-center justify-center"><div class="loader"></div></div>`;
                    
                    const { data: ad } = await supabase.from('listings').select('*, profiles(*), cities(*)').eq('id', id).single();
                    
                    if(!ad) { view.innerHTML = `<div class="p-20 text-center">Ad not found</div>`; return; }

                    const mainImg = ad.image_urls?.[0] || 'https://placehold.co/600x400?text=No+Image';
                    const userAvatar = ad.profiles?.avatar_url || 'https://placehold.co/50x50?text=U';

                    // Logic for phone unlock state (mocked)
                    const isPhoneUnlocked = false; 

                    view.innerHTML = `
                        <div class="container mx-auto px-4 py-8 fade-in">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Images -->
                                <div class="lg:col-span-2 space-y-4">
                                    <div class="bg-black rounded-xl overflow-hidden h-[400px] md:h-[500px] flex items-center justify-center relative group">
                                        <img src="${mainImg}" id="main-img" class="h-full w-full object-contain">
                                    </div>
                                    <div class="flex gap-2 overflow-x-auto pb-2">
                                        ${(ad.image_urls || []).map(url => `
                                            <img src="${url}" onclick="document.getElementById('main-img').src='${url}'" class="w-20 h-20 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-primary-500">
                                        `).join('')}
                                    </div>
                                    
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
                                        <h3 class="text-xl font-bold mb-4">Description</h3>
                                        <p class="text-gray-700 leading-relaxed whitespace-pre-line">${utils.sanitize(ad.description)}</p>
                                        <div class="mt-6 grid grid-cols-2 gap-4 text-sm">
                                            <div class="bg-gray-50 p-3 rounded"><strong>Category:</strong> ${ad.subcategory || 'General'}</div>
                                            <div class="bg-gray-50 p-3 rounded"><strong>Location:</strong> ${utils.sanitize(ad.location)}</div>
                                            <div class="bg-gray-50 p-3 rounded"><strong>Posted:</strong> ${utils.timeAgo(ad.created_at)}</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Sidebar -->
                                <div class="space-y-6">
                                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 sticky top-24">
                                        <h1 class="text-2xl font-bold text-gray-900 mb-2">${utils.sanitize(ad.title)}</h1>
                                        <div class="text-3xl font-extrabold text-primary-600 mb-6">${utils.formatPrice(ad.price)}</div>
                                        
                                        <div class="flex items-center gap-4 mb-6 pb-6 border-b">
                                            <img src="${userAvatar}" class="w-14 h-14 rounded-full object-cover border">
                                            <div>
                                                <p class="font-bold text-lg">${utils.sanitize(ad.profiles?.full_name || 'TradeGinger User')}</p>
                                                <p class="text-xs text-gray-500">Member since 2024</p>
                                            </div>
                                        </div>

                                        <div class="space-y-3">
                                            <!-- Phone Unlock -->
                                            <div id="phone-section" class="bg-green-50 border border-green-200 p-3 rounded-lg flex justify-between items-center">
                                                <div class="text-green-800 font-medium"><i class="fas fa-phone-alt mr-2"></i> +91 XXXXX XXXXX</div>
                                                <button onclick="app.ui.unlockPhone(this)" class="text-xs bg-green-600 text-white px-3 py-1 rounded shadow hover:bg-green-700">Unlock (₹5)</button>
                                            </div>

                                            <!-- Actions -->
                                            <button onclick="app.chat.start('${ad.profiles?.id}', '${ad.id}', '${ad.profiles?.full_name?.replace(/'/g, "")}')" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 rounded-lg shadow-md transition flex items-center justify-center gap-2">
                                                <i class="fas fa-comment-dots"></i> Chat with Seller
                                            </button>

                                            <!-- Enquiry Form (Lead Gen) -->
                                            <div class="border-t pt-4 mt-4">
                                                <h4 class="font-bold text-gray-700 mb-2">Send Enquiry</h4>
                                                <form id="enquiry-form" onsubmit="event.preventDefault(); app.data.sendEnquiry('${ad.id}', '${ad.profiles?.id}')" class="space-y-2">
                                                    <input type="text" id="enquiry-name" placeholder="Your Name" class="w-full text-sm border rounded px-3 py-2 bg-gray-50">
                                                    <input type="tel" id="enquiry-phone" placeholder="Your Phone Number" class="w-full text-sm border rounded px-3 py-2 bg-gray-50">
                                                    <button type="submit" class="w-full bg-gray-800 text-white text-sm py-2 rounded hover:bg-gray-900">Send Interest</button>
                                                </form>
                                            </div>

                                            ${state.user?.id === ad.user_id ? `<div class="text-center text-sm text-gray-500 bg-gray-100 p-2 rounded">This is your ad</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                },
                profile: () => `
                    <div class="container mx-auto px-4 py-10 fade-in">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-8">
                            <div class="h-32 bg-gradient-to-r from-primary-800 to-dark-900"></div>
                            <div class="px-8 pb-8 flex flex-col md:flex-row items-end md:items-center gap-6 -mt-12">
                                <img src="${state.profile?.avatar_url || 'https://placehold.co/150x150'}" class="w-32 h-32 rounded-full border-4 border-white shadow-md bg-white">
                                <div class="flex-grow mb-2">
                                    <h1 class="text-3xl font-bold text-gray-900">${utils.sanitize(state.profile?.full_name || 'User')}</h1>
                                    <p class="text-gray-500"><i class="fas fa-envelope"></i> ${state.user?.email}</p>
                                </div>
                                <div class="mb-4 flex gap-2">
                                    <button onclick="app.router.navigate('leads')" class="bg-accent-500 text-white hover:bg-accent-600 px-4 py-2 rounded-lg font-medium shadow-sm"><i class="fas fa-bolt mr-1"></i> Buy Leads</button>
                                    <button onclick="app.auth.logout()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg font-medium border border-red-200">Logout</button>
                                </div>
                            </div>
                        </div>
                        
                        <h2 class="text-2xl font-bold mb-6">My Listings</h2>
                        <div id="user-ads" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- User ads -->
                        </div>
                    </div>
                `
            },

            ui: {
                skeletonCard: () => `
                    <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                        <div class="h-48 skeleton"></div>
                        <div class="p-4 space-y-3">
                            <div class="h-6 w-3/4 skeleton rounded"></div>
                            <div class="h-4 w-1/2 skeleton rounded"></div>
                            <div class="h-4 w-full skeleton rounded"></div>
                        </div>
                    </div>
                `,
                unlockPhone: async (btn) => {
                    if(await app.payment.process(5, "Unlock Phone Number")) {
                        const container = btn.parentElement;
                        container.innerHTML = `<div class="text-green-800 font-bold"><i class="fas fa-phone-alt mr-2"></i> +91 98765 43210</div>`;
                    }
                },
                renderGrid: (container, items, canEdit = false) => {
                    container.innerHTML = items.map(item => `
                        <div class="group bg-white rounded-xl border border-gray-100 overflow-hidden hover:shadow-lg transition-all duration-300 hover:-translate-y-1 relative">
                            <a href="#detail?id=${item.id}" class="block">
                                <div class="relative h-48 overflow-hidden bg-gray-100">
                                    <img src="${item.image_urls?.[0] || 'https://placehold.co/400x300'}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                    <div class="absolute bottom-2 left-2 bg-black/60 backdrop-blur text-white text-xs px-2 py-1 rounded">
                                        <i class="fas fa-map-marker-alt"></i> ${utils.sanitize(item.location || item.cities?.name)}
                                    </div>
                                    ${item.title.includes("Premium") ? `<div class="absolute top-2 left-2 badge-platinum text-xs font-bold px-2 py-1 rounded shadow">PLATINUM</div>` : ''}
                                </div>
                                <div class="p-4">
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="font-bold text-lg text-gray-800 truncate pr-2">${utils.formatPrice(item.price)}</h3>
                                    </div>
                                    <p class="text-gray-600 text-sm truncate mb-3">${utils.sanitize(item.title)}</p>
                                    <div class="flex justify-between items-center text-xs text-gray-400 border-t pt-3">
                                        <span>${utils.timeAgo(item.created_at)}</span>
                                        <span class="text-primary-600 font-medium">${item.subcategory || 'Item'}</span>
                                    </div>
                                </div>
                            </a>
                            ${canEdit ? `<button onclick="app.sell.delete('${item.id}')" class="absolute top-2 right-2 bg-white/90 p-2 rounded-full text-red-500 hover:bg-red-500 hover:text-white shadow transition"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    `).join('');
                },
                renderNav: () => {
                    const nav = document.getElementById('nav-auth-section');
                    const mobile = document.getElementById('mobile-nav-content');
                    
                    if(state.user) {
                        const html = `
                            <button onclick="document.getElementById('chat-modal').classList.remove('hidden')" class="relative text-gray-500 hover:text-primary-600 text-xl">
                                <i class="fas fa-comment-dots"></i>
                            </button>
                            <div class="relative group">
                                <button class="flex items-center gap-2">
                                    <img src="${state.profile?.avatar_url || 'https://placehold.co/40x40'}" class="w-8 h-8 rounded-full border border-gray-200 object-cover">
                                </button>
                                <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 hidden group-hover:block py-2 animate-fade-in-down">
                                    <div class="px-4 py-2 border-b border-gray-50 text-sm font-bold text-gray-700">${utils.sanitize(state.profile?.first_name)}</div>
                                    <a href="#profile" class="block px-4 py-2 text-sm text-gray-600 hover:bg-primary-50 hover:text-primary-600">My Profile</a>
                                    <a href="#leads" class="block px-4 py-2 text-sm text-gray-600 hover:bg-primary-50 hover:text-primary-600">Buy Leads</a>
                                    <div class="border-t border-gray-50 my-1"></div>
                                    <a href="#" onclick="app.auth.logout()" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Logout</a>
                                </div>
                            </div>
                        `;
                        nav.innerHTML = html;
                        mobile.innerHTML = `<a href="#profile" class="block py-2 font-bold">My Profile</a><a href="#" onclick="app.auth.logout()" class="block py-2 text-red-500">Logout</a>`;
                    } else {
                        nav.innerHTML = `<button onclick="app.modals.auth.show()" class="text-sm font-bold text-gray-700 hover:text-primary-600">Login / Register</button>`;
                        mobile.innerHTML = `<button onclick="app.modals.auth.show()" class="block w-full text-left py-2 font-bold">Login</button>`;
                    }
                }
            },

            modals: {
                auth: {
                    show: () => { document.getElementById('auth-modal').classList.remove('hidden', 'opacity-0', 'pointer-events-none'); document.getElementById('auth-modal').classList.add('opacity-100'); },
                    hide: () => { document.getElementById('auth-modal').classList.add('hidden', 'opacity-0', 'pointer-events-none'); }
                },
                sell: {
                    show: async () => {
                        document.getElementById('sell-modal').classList.remove('hidden');
                        // Populate selects
                        const catSelect = document.getElementById('category-select');
                        if(catSelect.options.length <= 1) {
                            state.categories.forEach(c => {
                                const opt = document.createElement('option');
                                opt.value = c.id; opt.text = c.name;
                                catSelect.add(opt);
                            });
                            // Populate states
                            const stSelect = document.getElementById('state-select');
                            state.locations.forEach(l => {
                                const opt = document.createElement('option');
                                opt.value = l.state; opt.text = l.state;
                                stSelect.add(opt);
                            });
                        }
                    },
                    hide: () => document.getElementById('sell-modal').classList.add('hidden')
                },
                tnc: {
                    show: () => document.getElementById('info-modal').classList.remove('hidden'),
                    hide: () => document.getElementById('info-modal').classList.add('hidden')
                }
            },

            sell: {
                stagedFiles: [],
                planPrice: 0,
                handleFiles: (e) => {
                    const files = Array.from(e.target.files);
                    app.sell.stagedFiles.push(...files);
                    const container = document.getElementById('preview-container');
                    container.innerHTML = '';
                    app.sell.stagedFiles.forEach(f => {
                        const url = URL.createObjectURL(f);
                        container.innerHTML += `<img src="${url}" class="w-16 h-16 object-cover rounded border">`;
                    });
                },
                updateSubcats: () => {
                   const catId = document.getElementById('category-select').value;
                   const sub = document.getElementById('subcategory-select');
                   sub.innerHTML = "";
                   sub.disabled = false;
                   // Simplified Mock Subcats
                   const subs = ['General', 'Premium', 'Refurbished', 'Accessories'];
                   subs.forEach(s => { const o = document.createElement('option'); o.text = s; o.value = s; sub.add(o); });
                },
                updatePlanPrice: (price) => {
                    app.sell.planPrice = price;
                    document.getElementById('total-plan-price').innerText = `₹${price}`;
                    const btn = document.querySelector('#sell-modal button[onclick="app.sell.submit()"]');
                    btn.innerText = price > 0 ? 'Post & Pay' : 'Post Now';
                },
                generateAI: async () => {
                    const title = document.getElementsByName('title')[0].value;
                    if(!title) return utils.toast('Enter title first', 'error');
                    const btn = document.querySelector('#sell-form button[type="button"]');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=YOUR_API_KEY`, { 
                           method: 'POST',
                           headers: {'Content-Type': 'application/json'},
                           body: JSON.stringify({ contents: [{ parts: [{ text: `Write a short sales description for: ${title}` }] }] })
                        });
                        // Mocking response logic
                        document.getElementById('ad-description').value = `This is a fantastic ${title} in great condition. It has been well maintained and is available for a quick sale. Contact for more details.`;
                        utils.toast('AI Generated Description (Mock)', 'success');
                    } catch(e) { document.getElementById('ad-description').value = `Great condition ${title}.`; }
                    btn.innerHTML = '<i class="fas fa-magic"></i> AI Write';
                },
                submit: async () => {
                    const form = document.getElementById('sell-form');
                    if(!form.checkValidity()) return utils.toast('Please fill all fields', 'error');

                    // Payment Check
                    if(app.sell.planPrice > 0) {
                        const success = await app.payment.process(app.sell.planPrice, "Ad Posting Fee");
                        if(!success) return;
                    }
                    
                    utils.toast('Uploading images...', 'info');
                    
                    // Upload Images to Cloudinary
                    const imageUrls = [];
                    for (const file of app.sell.stagedFiles) {
                        const fd = new FormData();
                        fd.append('file', file);
                        fd.append('upload_preset', CLOUDINARY_PRESET);
                        try {
                            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: fd });
                            const data = await res.json();
                            imageUrls.push(data.secure_url);
                        } catch(e) { console.error(e); }
                    }

                    const fd = new FormData(form);
                    const payload = {
                        user_id: state.user.id,
                        title: fd.get('title'),
                        price: fd.get('price'),
                        description: fd.get('description'),
                        category_id: fd.get('category'),
                        subcategory: fd.get('subcategory'),
                        location: document.getElementById('city-select').options[document.getElementById('city-select').selectedIndex].text,
                        image_urls: imageUrls,
                        city_id: 1001 // Mock ID for demo
                    };

                    const { error } = await supabase.from('listings').insert(payload);
                    if(error) return utils.toast(error.message, 'error');
                    
                    utils.toast('Ad Posted Successfully!', 'success');
                    app.modals.sell.hide();
                    form.reset();
                    app.sell.stagedFiles = [];
                    document.getElementById('preview-container').innerHTML = '';
                    app.router.navigate('profile');
                },
                delete: async (id) => {
                    if(!confirm('Delete this ad?')) return;
                    const { error } = await supabase.from('listings').delete().eq('id', id);
                    if(error) utils.toast(error.message, 'error');
                    else {
                        utils.toast('Deleted', 'success');
                        app.data.fetchUserListings();
                    }
                }
            },

            location: {
                populateCities: (stateName, targetId) => {
                    const target = document.getElementById(targetId);
                    target.innerHTML = ''; target.disabled = false;
                    const loc = state.locations.find(l => l.state === stateName);
                    loc?.cities.forEach(c => { const o = document.createElement('option'); o.text = c; o.value = c; target.add(o); });
                }
            },

            chat: {
                subscription: null,
                
                init: async () => {
                    // Load sidebar list if user is logged in
                    if(state.user) app.chat.fetchConversations();
                },

                fetchConversations: async () => {
                     // Fetch rooms where user is buyer or seller
                     const { data: rooms, error } = await supabase
                        .from('chat_rooms')
                        .select('*, listings(title, image_urls), buyer:buyer_id(full_name, avatar_url), seller:seller_id(full_name, avatar_url)')
                        .or(`buyer_id.eq.${state.user.id},seller_id.eq.${state.user.id}`);

                     if(error) return console.error(error);
                     
                     const list = document.getElementById('chat-list');
                     list.innerHTML = rooms.map(r => {
                        const isBuyer = r.buyer_id === state.user.id;
                        const otherUser = isBuyer ? r.seller : r.buyer;
                        // Fallback if relation lookup fails (common in simple setups)
                        const name = otherUser?.full_name || 'User';
                        const img = otherUser?.avatar_url || 'https://placehold.co/40x40';
                        
                        return `
                            <div onclick="app.chat.openRoom('${r.id}', '${name}', '${img}')" class="p-4 border-b hover:bg-gray-100 cursor-pointer flex items-center gap-3">
                                <img src="${img}" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <div class="font-bold text-sm text-gray-800">${name}</div>
                                    <div class="text-xs text-gray-500 truncate w-32">${r.listings?.title || 'Ad'}</div>
                                </div>
                            </div>
                        `;
                     }).join('');
                },

                start: async (sellerId, listingId, sellerName) => {
                    if(!state.user) return app.modals.auth.show();
                    if(sellerId === state.user.id) return utils.toast("Cannot chat with yourself", 'error');

                    document.getElementById('chat-modal').classList.remove('hidden');
                    document.getElementById('chat-header-name').innerText = sellerName;
                    document.getElementById('chat-messages').innerHTML = '<div class="loader mx-auto mt-10"></div>';

                    // 1. Find or Create Room
                    let { data: room, error } = await supabase
                        .from('chat_rooms')
                        .select('id')
                        .eq('listing_id', listingId)
                        .eq('buyer_id', state.user.id)
                        .eq('seller_id', sellerId)
                        .maybeSingle();

                    if (!room) {
                         const { data: newRoom, error: createError } = await supabase
                            .from('chat_rooms')
                            .insert({ 
                                listing_id: listingId, 
                                buyer_id: state.user.id, 
                                seller_id: sellerId 
                            })
                            .select()
                            .single();
                         
                         if(createError) {
                             console.error(createError);
                             return utils.toast("Error starting chat", "error");
                         }
                         room = newRoom;
                    }
                    
                    app.chat.openRoom(room.id, sellerName);
                },

                openRoom: async (roomId, name, img) => {
                    state.currentChatRoom = roomId;
                    document.getElementById('chat-modal').classList.remove('hidden');
                    if(name) document.getElementById('chat-header-name').innerText = name;
                    if(img) document.getElementById('chat-header-img').src = img;
                    
                    // Unsubscribe previous
                    if(app.chat.subscription) supabase.removeChannel(app.chat.subscription);

                    // Load Messages
                    const { data: msgs, error } = await supabase
                        .from('chat_messages')
                        .select('*')
                        .eq('room_id', roomId)
                        .order('created_at', { ascending: true });
                    
                    const container = document.getElementById('chat-messages');
                    container.innerHTML = '';
                    
                    if(msgs) {
                        msgs.forEach(m => app.chat.renderMessage(m));
                    }

                    // Subscribe
                    app.chat.subscription = supabase
                        .channel(`room:${roomId}`)
                        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages', filter: `room_id=eq.${roomId}` }, 
                        (payload) => {
                            app.chat.renderMessage(payload.new);
                        })
                        .subscribe();
                        
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                },

                renderMessage: (msg) => {
                    const container = document.getElementById('chat-messages');
                    const isMe = msg.sender_id === state.user.id;
                    const html = `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="${isMe ? 'bg-primary-600 text-white' : 'bg-gray-200 text-gray-800'} px-4 py-2 rounded-l-xl rounded-tr-xl max-w-xs shadow-sm text-sm">
                                ${utils.sanitize(msg.content)}
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                    container.scrollTop = container.scrollHeight;
                },

                send: async (e) => {
                    e.preventDefault();
                    const inp = document.getElementById('chat-input');
                    const text = inp.value.trim();
                    if(!text || !state.currentChatRoom) return;

                    // Safety Filter
                    const phoneRegex = /(\+?91|0)?[6-9]\d{9}/;
                    const emailRegex = /\S+@\S+\.\S+/;
                    if(phoneRegex.test(text) || emailRegex.test(text)) {
                        return utils.toast("Message blocked. Sharing contact info is not allowed.", "error");
                    }
                    
                    const { error } = await supabase
                        .from('chat_messages')
                        .insert({
                            room_id: state.currentChatRoom,
                            sender_id: state.user.id,
                            content: text
                        });
                        
                    if(error) utils.toast("Failed to send", "error");
                    else inp.value = '';
                }
            }
        };

        // Initialize App
        window.app = app;
        document.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
</html>
